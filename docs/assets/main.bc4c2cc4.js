var zi=Object.defineProperty;var vi=(e,t,r)=>t in e?zi(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var h=(e,t,r)=>(vi(e,typeof t!="symbol"?t+"":t,r),r),vt=(e,t,r)=>{if(!t.has(e))throw TypeError("Cannot "+r)};var a=(e,t,r)=>(vt(e,t,"read from private field"),r?r.call(e):t.get(e)),w=(e,t,r)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,r)},y=(e,t,r,n)=>(vt(e,t,"write to private field"),n?n.call(e,r):t.set(e,r),r);var g=(e,t,r)=>(vt(e,t,"access private method"),r);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function r(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerpolicy&&(s.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?s.credentials="include":i.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(i){if(i.ep)return;i.ep=!0;const s=r(i);fetch(i.href,s)}})();class pe{constructor(t){h(this,"value");h(this,"listeners",[]);this.value=t}get(){return this.value}set(t,r=!1){if(!(!r&&t===this.value)){this.value=t;for(const n of this.listeners)n(t)}}update(t,r=!1){const n=t(this.value);this.set(n,r)}subscribe(t){this.listeners.push(t),t(this.value)}subscribeLater(t){this.listeners.push(t)}}class Gr extends pe{constructor(r,n){localStorage.getItem(r)!==null&&(n=JSON.parse(localStorage.getItem(r)));super(n);h(this,"key");this.key=r}set(r,n=!1){(n||JSON.stringify(this.get())!==JSON.stringify(r))&&(super.set(r),localStorage.setItem(this.key,JSON.stringify(r)))}}const Ct=(e,t,r="",n)=>{const i=document.createElement(e);return i.innerText=t,r&&i.classList.add(...r.split(".").filter(s=>s)),n&&Object.entries(n).forEach(([s,o])=>{s==="parent"&&o.appendChild(i),s==="children"?o.forEach(l=>i.appendChild(l)):s==="eventListeners"?Object.entries(o).forEach(([l,m])=>{i.addEventListener(l,m)}):s==="color"||s==="background"?i.style[s]=o:s==="style"?Object.entries(o).forEach(([l,m])=>{i.style.setProperty(l,m)}):i[s]=o}),i},Zr=(e,...t)=>{let r=[],n={};const i=s=>{if(typeof s=="string")r.push(Ct("span",s));else if(typeof s=="number")r.push(Ct("span",s.toString()));else if(s instanceof pe){const o=Ye();s.subscribe(l=>{o.innerHTML="",o.appendChild(Ye(l))}),r.push(o)}else if(s instanceof Promise){const o=Ye();s.then(l=>{o.innerHTML="",o.appendChild(Ye(l))}),r.push(o)}else s instanceof HTMLElement?r.push(s):s instanceof Array?s.forEach(i):n={...n,...s}};for(let s of t)i(s);return Ct(e,"","",{...n,children:r})},Xe=e=>(...t)=>Zr(e,...t),ge=Xe("p"),nt=Xe("h2"),X=Xe("div"),et=Xe("button"),Ye=Xe("span"),Cr=(...e)=>{const t=e.find(i=>i instanceof pe),r=e.filter(i=>typeof i=="string").join(" "),n=Zr("input",...e);return t?(n.value=t.get(),t.subscribeLater(i=>{n.value!==i.toString()&&(n.value=i.toString())}),n.oninput=i=>{t.set(i.target.value)}):n.value=r,n},Ci=e=>{const t=X({style:{position:"fixed",top:"0",left:"0",width:"100%",height:"100%",background:"rgba(166, 166, 166, 0.5)",display:"flex","justify-content":"center","align-items":"center"}});return t.appendChild(e),document.body.appendChild(t),t.onclick=()=>{t.remove()},e.style.background="var(--bg)",e.style.color="var(--color)",e.style.padding="1em",e.style.paddingBottom="2em",e.style.borderRadius="1em",e.onclick=r=>{r.stopPropagation()},t},xe={loadApp:e=>({pushMsg:t=>{let r={sender:e.self,receiver:e.other,message:t};e.DB.set(!1,"messages",[...e.DB.get(!1,"messages")??[],r]),e.DB.set(!0,"messages",[...e.DB.get(!0,"messages")??[],r])}}),api:{setname:(e,t)=>{e.DB.set(!0,"name",t)},getname:(e,t)=>e.DB.get(!1,"name"),sendMessage:(e,t)=>{e.pushMsg(t)},getMessages:(e,t)=>e.DB.get(!0,"messages")}},Ei=e=>{let t=new Map,r=ge(),n=X();return e.handle(xe).then(async({call:i,users:s,subscribe:o})=>{console.log("handle",xe);async function l(T){let F=t.get(T);if(F)return F;let O=new pe("");return i(T,xe.api.getname,T).then(N=>O.set(N)),t.set(T,O),O}let m=new pe([]),S=new pe(X()),I=new Gr("other",e.identity);function v(){S.set(X(m.get().filter(T=>T.receiver==I.get()&&T.sender==e.identity||T.sender==I.get()&&T.receiver==e.identity).map(T=>ge(l(T.sender)," : ",T.message)),{style:{"max-width":"20em",margin:"auto"}}))}i(e.identity,xe.api.getMessages).then(T=>m.set(T??[])),m.subscribe(T=>v()),I.subscribeLater(T=>v()),o("messages",T=>{m.set(T??[])});let C=Cr();await l(e.identity).then(T=>T.subscribe(F=>C.value=F));let p=Cr(),f=et("send");f.onclick=async()=>{await i(I.get(),xe.api.sendMessage,p.value),p.value=""};let b=new pe("");I.subscribe(T=>{l(T).then(F=>F.subscribe(O=>b.set(O)))}),n.appendChild(X(nt("chat"),r,ge("my name:",C,et("update",{onclick:()=>{i(e.identity,xe.api.setname,C.value).then(()=>{l(e.identity).then(T=>T.set(C.value))})}})),et("chat with: ",b,{onclick:()=>{let T=Ci(X(nt("chat with"),s().then(F=>F.map(O=>ge(l(O),{onclick:()=>{I.set(O),T.remove()}})))))}}),S,ge("send message:",p,f)))}),n};let Xr=e=>{let t=[[{type:"rook",color:"white"},{type:"knight",color:"white"},{type:"bishop",color:"white"},{type:"queen",color:"white"},{type:"king",color:"white"},{type:"bishop",color:"white"},{type:"knight",color:"white"},{type:"rook",color:"white"}],[{type:"pawn",color:"white"},{type:"pawn",color:"white"},{type:"pawn",color:"white"},{type:"pawn",color:"white"},{type:"pawn",color:"white"},{type:"pawn",color:"white"},{type:"pawn",color:"white"},{type:"pawn",color:"white"}],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null],[{type:"pawn",color:"black"},{type:"pawn",color:"black"},{type:"pawn",color:"black"},{type:"pawn",color:"black"},{type:"pawn",color:"black"},{type:"pawn",color:"black"},{type:"pawn",color:"black"},{type:"pawn",color:"black"}],[{type:"rook",color:"black"},{type:"knight",color:"black"},{type:"bishop",color:"black"},{type:"queen",color:"black"},{type:"king",color:"black"},{type:"bishop",color:"black"},{type:"knight",color:"black"},{type:"rook",color:"black"}]];function r(p){return[p%10,Math.floor(p/10)]}function n(p){return p[0]+p[1]*10}if(n(r(21))!=21)throw new Error("posVec failed");function i(p){let[f,b]=r(p);return f>=0&&f<8&&b>=0&&b<8}function s(p,f){let[b,T]=r(f);return p[T][b]}function o(p,f,b){let[T,F]=r(f);p[F][T]=b}function l(p,f){for(let b=0;b<8;b++)for(let T=0;T<8;T++){let F=p[b][T];if(F&&F.color===f&&F.type==="king")return b*10+T}return null}function m(p){let f=[10,-10,1,-1],b=[11,-11,9,-9];if(p.type.startsWith("pawnmoved"))return p.color==="white"?[10]:[-10];if(p.type.startsWith("pawn"))return p.color==="white"?[10,20]:[-10,-20];if(p.type.startsWith("knight"))return[12,8,21,19,-12,8,-21,-19];if(p.type.startsWith("bishop"))return b;if(p.type.startsWith("rook"))return f;if(p.type.startsWith("queen")||p.type.startsWith("king"))return b.concat(f);throw new Error("unknown piece type: "+p.type)}function S(p,f){let[b,T]=r(p),[F,O]=f;return n([b+F,T+O])}function I(p,f){let b=s(p,f);if(!b)return[];let T=[],F=b.type,O=m(b);if(F.startsWith("pawn")){T=O.map(P=>f+P).filter(i).filter(P=>s(p,P)==null);let N=b.color=="white"?1:-1;T=T.concat([1,-1].map(P=>S(f,[P,N])).filter(i).filter(P=>{let q=s(p,P);return q?q.color!=b.color:(q=s(p,P-N*10),q&&q.color!=b.color&&q.type=="pawnmoveddouble")}))}else{let N=F.startsWith("rook")||F.startsWith("bishop")||F.startsWith("queen");for(let P of O){let q=f;for(;q=q+P,!!i(q);){let se=s(p,q);if(se){b.color!==se.color&&T.push(q);break}if(T.push(q),!N)break}}F=="king"&&(s(p,f+1)==null&&s(p,f+2)==null&&s(p,f+3)?.type=="rook"&&T.push(f+2),s(p,f-1)==null&&s(p,f-2)==null&&s(p,f-4)?.type=="rook"&&T.push(f-2))}return T}function v(p,f){return I(p,f)}function C(p,f){if(p.winner!=null)return["game over",p];let b=s(p.board,f.start);if(!b||b.color!==p.turn)return["not your turn",p];if(!v(p.board,f.start).includes(f.end))return["illegal move",p];if((b.type=="pawn"||b.type=="king"||b.type=="rook")&&(b.type+="moved"),b.type=="pawnmoved"&&Math.abs(f.end-f.start)==20&&(b.type="pawnmoveddouble"),b.type.startsWith("pawn")&&f.start%10!=f.end%10&&s(p.board,f.end)==null&&o(p.board,n([f.end%10,Math.floor(f.start/10)]),null),b.type.startsWith("king")){let F=f.start-f.end;F==2&&(o(p.board,f.end+1,{...b,type:"rookmoved"}),o(p.board,f.end-2,null)),F==-2&&(o(p.board,f.end-1,{...b,type:"rookmoved"}),o(p.board,f.end+1,null))}if(o(p.board,f.end,b),b.type.startsWith("pawn")){let F=Math.floor(f.end/10);(F==0||F==7)&&o(p.board,f.end,{...b,type:f.promo})}return o(p.board,f.start,null),p.turn=p.turn==="white"?"black":"white",l(p.board,p.turn)==null&&(p.winner=p.turn==="white"?"black":"white"),["",p]}return{startBoard:t,makeMove:C,getLegalMoves:v}},Er={loadApp:Xr,api:{getBoard:(e,t)=>e.startBoard}},ki={pawn:"p",knight:"N",bishop:"B",rook:"R",queen:"Q",king:"K",kingmoved:"K",rookmoved:"R",pawnmoved:"p",pawnmoveddouble:"p"},ie=(window.innerWidth<window.innerHeight?window.innerWidth:window.innerHeight)*.6,Ot=X({class:"chessboard",style:{backgroundColor:"#f0d9b5",width:ie+"px",height:ie+"px",margin:"auto",position:"relative",cursor:"pointer"}}),Bi=e=>{Ot.innerHTML="";for(let t=0;t<8;t++)for(let r=0;r<8;r++){let n=X({class:"square"});n.style.width=ie/8+"px",n.style.height=ie/8+"px",Ot.appendChild(n),n.style.backgroundColor=(r+t)%2===0?"#b58863":"#f0d9b5",n.style.left=t*ie/8+"px",n.style.bottom=r*ie/8+"px",n.style.position="absolute";let i=e.board[r][t];if(i){let s=X(ki[i.type],{class:"piece"});s.style.width=ie/8+"px",s.style.height=ie/8+"px",s.style.position="absolute",n.appendChild(s),s.style.color=i.color==="white"?"white":"black",s.style.fontWeight="bold",s.style.fontSize=ie/8+"px"}}},Oi=e=>{e.handle(Er).then(async({call:n,users:i,subscribe:s})=>{console.log("chess app loaded"),await n(e.identity,Er.api.getBoard).then(o=>{console.log("board",o)})});let t=X({style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100vh",width:"100vw",backgroundColor:"#f0d9b5","font-family":"monospace"}});t.appendChild(Ot);let r={board:Xr().startBoard,white:e.identity,black:"id123",turn:"white",winner:null};return Bi(r),t};const Yr="utf-8";function U(e,t=void 0){if(e)throw TypeError("Decoder error");return t||65533}function Q(e){throw TypeError("The code point "+e+" could not be encoded.")}function Dt(e){const t=String(e).trim().toLowerCase();return t in jt?jt[t]:null}const Qr=[{encodings:[{labels:["unicode-1-1-utf-8","utf-8","utf8"],name:"UTF-8"}],heading:"The Encoding"},{encodings:[{labels:["866","cp866","csibm866","ibm866"],name:"IBM866"},{labels:["csisolatin2","iso-8859-2","iso-ir-101","iso8859-2","iso88592","iso_8859-2","iso_8859-2:1987","l2","latin2"],name:"ISO-8859-2"},{labels:["csisolatin3","iso-8859-3","iso-ir-109","iso8859-3","iso88593","iso_8859-3","iso_8859-3:1988","l3","latin3"],name:"ISO-8859-3"},{labels:["csisolatin4","iso-8859-4","iso-ir-110","iso8859-4","iso88594","iso_8859-4","iso_8859-4:1988","l4","latin4"],name:"ISO-8859-4"},{labels:["csisolatincyrillic","cyrillic","iso-8859-5","iso-ir-144","iso8859-5","iso88595","iso_8859-5","iso_8859-5:1988"],name:"ISO-8859-5"},{labels:["arabic","asmo-708","csiso88596e","csiso88596i","csisolatinarabic","ecma-114","iso-8859-6","iso-8859-6-e","iso-8859-6-i","iso-ir-127","iso8859-6","iso88596","iso_8859-6","iso_8859-6:1987"],name:"ISO-8859-6"},{labels:["csisolatingreek","ecma-118","elot_928","greek","greek8","iso-8859-7","iso-ir-126","iso8859-7","iso88597","iso_8859-7","iso_8859-7:1987","sun_eu_greek"],name:"ISO-8859-7"},{labels:["csiso88598e","csisolatinhebrew","hebrew","iso-8859-8","iso-8859-8-e","iso-ir-138","iso8859-8","iso88598","iso_8859-8","iso_8859-8:1988","visual"],name:"ISO-8859-8"},{labels:["csiso88598i","iso-8859-8-i","logical"],name:"ISO-8859-8-I"},{labels:["csisolatin6","iso-8859-10","iso-ir-157","iso8859-10","iso885910","l6","latin6"],name:"ISO-8859-10"},{labels:["iso-8859-13","iso8859-13","iso885913"],name:"ISO-8859-13"},{labels:["iso-8859-14","iso8859-14","iso885914"],name:"ISO-8859-14"},{labels:["csisolatin9","iso-8859-15","iso8859-15","iso885915","iso_8859-15","l9"],name:"ISO-8859-15"},{labels:["iso-8859-16"],name:"ISO-8859-16"},{labels:["cskoi8r","koi","koi8","koi8-r","koi8_r"],name:"KOI8-R"},{labels:["koi8-ru","koi8-u"],name:"KOI8-U"},{labels:["csmacintosh","mac","macintosh","x-mac-roman"],name:"macintosh"},{labels:["dos-874","iso-8859-11","iso8859-11","iso885911","tis-620","windows-874"],name:"windows-874"},{labels:["cp1250","windows-1250","x-cp1250"],name:"windows-1250"},{labels:["cp1251","windows-1251","x-cp1251"],name:"windows-1251"},{labels:["ansi_x3.4-1968","cp1252","cp819","ibm819","iso-ir-100","windows-1252","x-cp1252"],name:"windows-1252"},{labels:["ascii","us-ascii","iso-8859-1","iso8859-1","iso88591","iso_8859-1","iso_8859-1:1987","l1","latin1","csisolatin1"],name:"iso-8859-1"},{labels:["cp1253","windows-1253","x-cp1253"],name:"windows-1253"},{labels:["cp1254","csisolatin5","iso-8859-9","iso-ir-148","iso8859-9","iso88599","iso_8859-9","iso_8859-9:1989","l5","latin5","windows-1254","x-cp1254"],name:"windows-1254"},{labels:["cp1255","windows-1255","x-cp1255"],name:"windows-1255"},{labels:["cp1256","windows-1256","x-cp1256"],name:"windows-1256"},{labels:["cp1257","windows-1257","x-cp1257"],name:"windows-1257"},{labels:["cp1258","windows-1258","x-cp1258"],name:"windows-1258"},{labels:["x-mac-cyrillic","x-mac-ukrainian"],name:"x-mac-cyrillic"}],heading:"Legacy single-byte encodings"},{encodings:[{labels:["chinese","csgb2312","csiso58gb231280","gb2312","gb_2312","gb_2312-80","gbk","iso-ir-58","x-gbk"],name:"GBK"},{labels:["gb18030"],name:"gb18030"}],heading:"Legacy multi-byte Chinese (simplified) encodings"},{encodings:[{labels:["big5","big5-hkscs","cn-big5","csbig5","x-x-big5"],name:"Big5"}],heading:"Legacy multi-byte Chinese (traditional) encodings"},{encodings:[{labels:["cseucpkdfmtjapanese","euc-jp","x-euc-jp"],name:"EUC-JP"},{labels:["csiso2022jp","iso-2022-jp"],name:"ISO-2022-JP"},{labels:["csshiftjis","ms932","ms_kanji","shift-jis","shift_jis","sjis","windows-31j","x-sjis"],name:"Shift_JIS"}],heading:"Legacy multi-byte Japanese encodings"},{encodings:[{labels:["cseuckr","csksc56011987","euc-kr","iso-ir-149","korean","ks_c_5601-1987","ks_c_5601-1989","ksc5601","ksc_5601","windows-949"],name:"EUC-KR"}],heading:"Legacy multi-byte Korean encodings"},{encodings:[{labels:["csiso2022kr","hz-gb-2312","iso-2022-cn","iso-2022-cn-ext","iso-2022-kr"],name:"replacement"},{labels:["utf-16be"],name:"UTF-16BE"},{labels:["utf-16","utf-16le"],name:"UTF-16LE"},{labels:["x-user-defined"],name:"x-user-defined"}],heading:"Legacy miscellaneous encodings"}],jt={};Qr.forEach(e=>{e.encodings.forEach(t=>{t.labels.forEach(r=>{jt[r]=t})})});const D=-1;function ei(e){return Array.isArray(e)?e:[e]}function A(e,t,r){return t<=e&&e<=r}function Di(e,t){return e.indexOf(t)!==-1}function st(e){if(e==null)return{};if(e===Object(e))return e;throw TypeError("Could not convert argument to dictionary")}function ji(e){const t=String(e),r=t.length;let n=0;const i=[];for(;n<r;){const s=t.charCodeAt(n);if(s<55296||s>57343)i.push(s);else if(56320<=s&&s<=57343)i.push(65533);else if(55296<=s&&s<=56319)if(n===r-1)i.push(65533);else{const o=t.charCodeAt(n+1);if(56320<=o&&o<=57343){const l=s&1023,m=o&1023;i.push(65536+(l<<10)+m),n+=1}else i.push(65533)}n+=1}return i}function Pi(e){let t="";for(let r=0;r<e.length;++r){let n=e[r];n<=65535?t+=String.fromCharCode(n):(n-=65536,t+=String.fromCharCode((n>>10)+55296,(n&1023)+56320))}return t}function ti(){if(typeof global<"u")return global;if(typeof window<"u")return window;if(typeof self<"u")return self}let Et;function Mi(){if(typeof TextEncodingIndexes<"u")return TextEncodingIndexes.encodingIndexes;const e=ti();return e?"TextEncodingIndexes"in e?global.TextEncodingIndexes.encodingIndexes:"encoding-indexes"in e?global.encodingIndexes:null:null}function ri(){if(Et)return Et;const e=Mi();return e?(Et=e,e):null}function Oe(e,t){return t&&t[e]||null}function De(e,t){const r=t.indexOf(e);return r===-1?null:r}function W(e){const t=ri();if(!t)throw Error("Indexes missing. Did you forget to include encoding-indexes.js first?");return t[e]}function Ri(e){if(e>39419&&e<189e3||e>1237575)return null;if(e===7457)return 59335;let t=0,r=0;const n=W("gb18030-ranges");for(let i=0;i<n.length;++i){const s=ei(n[i]);if(s[0]<=e)t=s[0],r=s[1];else break}return r+e-t}function Li(e){if(e===59335)return 7457;let t=0,r=0;const n=W("gb18030-ranges");for(let i=0;i<n.length;++i){const s=n[i],o=ei(s);if(o[1]<=e)t=o[1],r=o[0];else break}return r+e-t}function Ni(e){return kt=kt||W("jis0208").map(function(r,n){return A(n,8272,8835)?null:r}),kt.indexOf(e)}let kt;function qi(e){Bt=Bt||W("big5").map((r,n)=>n<(161-129)*157?null:r);const t=Bt;return e===9552||e===9566||e===9569||e===9578||e===21313||e===21317?t.lastIndexOf(e):De(e,t)}let Bt;function Z(e){return 0<=e&&e<=127}const G=Z,z=-1;class Hi{constructor(t){this.fatal=t.fatal,this.Big5_lead=0}handler(t,r){if(r===z&&this.Big5_lead!==0)return this.Big5_lead=0,U(this.fatal);if(r===z&&this.Big5_lead===0)return D;if(this.Big5_lead!==0){const n=this.Big5_lead;let i=null;this.Big5_lead=0;const s=r<127?64:98;switch((A(r,64,126)||A(r,161,254))&&(i=(n-129)*157+(r-s)),i){case 1133:return[202,772];case 1135:return[202,780];case 1164:return[234,772];case 1166:return[234,780]}const o=i===null?null:Oe(i,W("big5"));return o===null&&Z(r)&&t.prepend(r),o===null?U(this.fatal):o}return Z(r)?r:A(r,129,254)?(this.Big5_lead=r,null):U(this.fatal)}}class $i{constructor(t){this.fatal=t.fatal}handler(t,r){if(r===z)return D;if(G(r))return r;const n=qi(r);if(n===null)return Q(r);const i=Math.floor(n/157)+129;if(i<161)return Q(r);const s=n%157,o=s<63?64:98;return[i,s+o]}}class Ki{constructor(t){this.fatal=t.fatal,this.eucjp_jis0212_flag=!1,this.eucjp_lead=0}handler(t,r){if(r===z&&this.eucjp_lead!==0)return this.eucjp_lead=0,U(this.fatal);if(r===z&&this.eucjp_lead===0)return D;if(this.eucjp_lead===142&&A(r,161,223))return this.eucjp_lead=0,65377-161+r;if(this.eucjp_lead===143&&A(r,161,254))return this.eucjp_jis0212_flag=!0,this.eucjp_lead=r,null;if(this.eucjp_lead!==0){const n=this.eucjp_lead;this.eucjp_lead=0;let i=null;return A(n,161,254)&&A(r,161,254)&&(i=Oe((n-161)*94+(r-161),W(this.eucjp_jis0212_flag?"jis0212":"jis0208"))),this.eucjp_jis0212_flag=!1,A(r,161,254)||t.prepend(r),i===null?U(this.fatal):i}return Z(r)?r:r===142||r===143||A(r,161,254)?(this.eucjp_lead=r,null):U(this.fatal)}}class Ji{constructor(t){this.fatal=t.fatal}handler(t,r){if(r===z)return D;if(G(r))return r;if(r===165)return 92;if(r===8254)return 126;if(A(r,65377,65439))return[142,r-65377+161];r===8722&&(r=65293);const n=De(r,W("jis0208"));if(n===null)return Q(r);const i=Math.floor(n/94)+161,s=n%94+161;return[i,s]}}class Wi{constructor(t){this.fatal=t.fatal,this.euckr_lead=0}handler(t,r){if(r===z&&this.euckr_lead!==0)return this.euckr_lead=0,U(this.fatal);if(r===z&&this.euckr_lead===0)return D;if(this.euckr_lead!==0){const n=this.euckr_lead;let i=null;this.euckr_lead=0,A(r,65,254)&&(i=(n-129)*190+(r-65));const s=i===null?null:Oe(i,W("euc-kr"));return i===null&&Z(r)&&t.prepend(r),s===null?U(this.fatal):s}return Z(r)?r:A(r,129,254)?(this.euckr_lead=r,null):U(this.fatal)}}class Vi{constructor(t){this.fatal=t.fatal}handler(t,r){if(r===z)return D;if(G(r))return r;const n=De(r,W("euc-kr"));if(n===null)return Q(r);const i=Math.floor(n/190)+129,s=n%190+65;return[i,s]}}class kr{constructor(t){this.fatal=t.fatal,this.gb18030_first=0,this.gb18030_second=0,this.gb18030_third=0}handler(t,r){if(r===z&&this.gb18030_first===0&&this.gb18030_second===0&&this.gb18030_third===0)return D;r===z&&(this.gb18030_first!==0||this.gb18030_second!==0||this.gb18030_third!==0)&&(this.gb18030_first=0,this.gb18030_second=0,this.gb18030_third=0,U(this.fatal));let n;if(this.gb18030_third!==0){n=null,A(r,48,57)&&(n=Ri((((this.gb18030_first-129)*10+this.gb18030_second-48)*126+this.gb18030_third-129)*10+r-48));const i=[this.gb18030_second,this.gb18030_third,r];return this.gb18030_first=0,this.gb18030_second=0,this.gb18030_third=0,n===null?(t.prepend(i),U(this.fatal)):n}if(this.gb18030_second!==0)return A(r,129,254)?(this.gb18030_third=r,null):(t.prepend([this.gb18030_second,r]),this.gb18030_first=0,this.gb18030_second=0,U(this.fatal));if(this.gb18030_first!==0){if(A(r,48,57))return this.gb18030_second=r,null;const i=this.gb18030_first;let s=null;this.gb18030_first=0;const o=r<127?64:65;return(A(r,64,126)||A(r,128,254))&&(s=(i-129)*190+(r-o)),n=s===null?null:Oe(s,W("gb18030")),n===null&&Z(r)&&t.prepend(r),n===null?U(this.fatal):n}return Z(r)?r:r===128?8364:A(r,129,254)?(this.gb18030_first=r,null):U(this.fatal)}}class Br{constructor(t,r=void 0){this.gbk_flag=r,this.fatal=t.fatal}handler(t,r){if(r===z)return D;if(G(r))return r;if(r===58853)return Q(r);if(this.gbk_flag&&r===8364)return 128;let n=De(r,W("gb18030"));if(n!==null){const m=Math.floor(n/190)+129,S=n%190,I=S<63?64:65;return[m,S+I]}if(this.gbk_flag)return Q(r);n=Li(r);const i=Math.floor(n/10/126/10);n=n-i*10*126*10;const s=Math.floor(n/10/126);n=n-s*10*126;const o=Math.floor(n/10),l=n-o*10;return[i+129,s+48,o+129,l+48]}}var j;(function(e){e[e.ASCII=0]="ASCII",e[e.Roman=1]="Roman",e[e.Katakana=2]="Katakana",e[e.LeadByte=3]="LeadByte",e[e.TrailByte=4]="TrailByte",e[e.EscapeStart=5]="EscapeStart",e[e.Escape=6]="Escape"})(j||(j={}));class Gi{constructor(t){this.fatal=t.fatal,this.iso2022jp_decoder_state=j.ASCII,this.iso2022jp_decoder_output_state=j.ASCII,this.iso2022jp_lead=0,this.iso2022jp_output_flag=!1}handler(t,r){switch(this.iso2022jp_decoder_state){default:case j.ASCII:return r===27?(this.iso2022jp_decoder_state=j.EscapeStart,null):A(r,0,127)&&r!==14&&r!==15&&r!==27?(this.iso2022jp_output_flag=!1,r):r===z?D:(this.iso2022jp_output_flag=!1,U(this.fatal));case j.Roman:return r===27?(this.iso2022jp_decoder_state=j.EscapeStart,null):r===92?(this.iso2022jp_output_flag=!1,165):r===126?(this.iso2022jp_output_flag=!1,8254):A(r,0,127)&&r!==14&&r!==15&&r!==27&&r!==92&&r!==126?(this.iso2022jp_output_flag=!1,r):r===z?D:(this.iso2022jp_output_flag=!1,U(this.fatal));case j.Katakana:return r===27?(this.iso2022jp_decoder_state=j.EscapeStart,null):A(r,33,95)?(this.iso2022jp_output_flag=!1,65377-33+r):r===z?D:(this.iso2022jp_output_flag=!1,U(this.fatal));case j.LeadByte:return r===27?(this.iso2022jp_decoder_state=j.EscapeStart,null):A(r,33,126)?(this.iso2022jp_output_flag=!1,this.iso2022jp_lead=r,this.iso2022jp_decoder_state=j.TrailByte,null):r===z?D:(this.iso2022jp_output_flag=!1,U(this.fatal));case j.TrailByte:if(r===27)return this.iso2022jp_decoder_state=j.EscapeStart,U(this.fatal);if(A(r,33,126)){this.iso2022jp_decoder_state=j.LeadByte;const s=(this.iso2022jp_lead-33)*94+r-33,o=Oe(s,W("jis0208"));return o===null?U(this.fatal):o}return r===z?(this.iso2022jp_decoder_state=j.LeadByte,t.prepend(r),U(this.fatal)):(this.iso2022jp_decoder_state=j.LeadByte,U(this.fatal));case j.EscapeStart:return r===36||r===40?(this.iso2022jp_lead=r,this.iso2022jp_decoder_state=j.Escape,null):(t.prepend(r),this.iso2022jp_output_flag=!1,this.iso2022jp_decoder_state=this.iso2022jp_decoder_output_state,U(this.fatal));case j.Escape:const n=this.iso2022jp_lead;this.iso2022jp_lead=0;let i=null;if(n===40&&r===66&&(i=j.ASCII),n===40&&r===74&&(i=j.Roman),n===40&&r===73&&(i=j.Katakana),n===36&&(r===64||r===66)&&(i=j.LeadByte),i!==null){this.iso2022jp_decoder_state=this.iso2022jp_decoder_state=i;const s=this.iso2022jp_output_flag;return this.iso2022jp_output_flag=!0,s?U(this.fatal):null}return t.prepend([n,r]),this.iso2022jp_output_flag=!1,this.iso2022jp_decoder_state=this.iso2022jp_decoder_output_state,U(this.fatal)}}}var J;(function(e){e[e.ASCII=0]="ASCII",e[e.Roman=1]="Roman",e[e.jis0208=2]="jis0208"})(J||(J={}));class Zi{constructor(t){this.fatal=t.fatal,this.iso2022jp_state=J.ASCII}handler(t,r){if(r===z&&this.iso2022jp_state!==J.ASCII)return t.prepend(r),this.iso2022jp_state=J.ASCII,[27,40,66];if(r===z&&this.iso2022jp_state===J.ASCII)return D;if((this.iso2022jp_state===J.ASCII||this.iso2022jp_state===J.Roman)&&(r===14||r===15||r===27))return Q(65533);if(this.iso2022jp_state===J.ASCII&&G(r))return r;if(this.iso2022jp_state===J.Roman&&(G(r)&&r!==92&&r!==126||r==165||r==8254)){if(G(r))return r;if(r===165)return 92;if(r===8254)return 126}if(G(r)&&this.iso2022jp_state!==J.ASCII)return t.prepend(r),this.iso2022jp_state=J.ASCII,[27,40,66];if((r===165||r===8254)&&this.iso2022jp_state!==J.Roman)return t.prepend(r),this.iso2022jp_state=J.Roman,[27,40,74];r===8722&&(r=65293);const n=De(r,W("jis0208"));if(n===null)return Q(r);if(this.iso2022jp_state!==J.jis0208)return t.prepend(r),this.iso2022jp_state=J.jis0208,[27,36,66];const i=Math.floor(n/94)+33,s=n%94+33;return[i,s]}}class Xi{constructor(t){this.fatal=t.fatal,this.Shift_JIS_lead=0}handler(t,r){if(r===z&&this.Shift_JIS_lead!==0)return this.Shift_JIS_lead=0,U(this.fatal);if(r===z&&this.Shift_JIS_lead===0)return D;if(this.Shift_JIS_lead!==0){const n=this.Shift_JIS_lead;let i=null;this.Shift_JIS_lead=0;const s=r<127?64:65,o=n<160?129:193;if((A(r,64,126)||A(r,128,252))&&(i=(n-o)*188+r-s),A(i,8836,10715))return 57344-8836+i;const l=i===null?null:Oe(i,W("jis0208"));return l===null&&Z(r)&&t.prepend(r),l===null?U(this.fatal):l}return Z(r)||r===128?r:A(r,161,223)?65377-161+r:A(r,129,159)||A(r,224,252)?(this.Shift_JIS_lead=r,null):U(this.fatal)}}class Yi{constructor(t){this.fatal=t.fatal}handler(t,r){if(r===z)return D;if(G(r)||r===128)return r;if(r===165)return 92;if(r===8254)return 126;if(A(r,65377,65439))return r-65377+161;r===8722&&(r=65293);const n=Ni(r);if(n===null)return Q(r);const i=Math.floor(n/188),s=i<31?129:193,o=n%188,l=o<63?64:65;return[i+s,o+l]}}class Qi{constructor(t,r){this.index=t,this.fatal=r.fatal}handler(t,r){if(r===z)return D;if(Z(r))return r;const n=this.index[r-128];return n||U(this.fatal)}}class en{constructor(t,r){this.index=t,this.fatal=r.fatal}handler(t,r){if(r===z)return D;if(G(r))return r;const n=De(r,this.index);return n===null&&Q(r),n+128}}function tt(e,t){const r=e>>8,n=e&255;return t?[r,n]:[n,r]}class Or{constructor(t,r){this.utf16_be=t,this.fatal=r.fatal,this.utf16_lead_byte=null,this.utf16_lead_surrogate=null}handler(t,r){if(r===z&&(this.utf16_lead_byte!==null||this.utf16_lead_surrogate!==null))return U(this.fatal);if(r===z&&this.utf16_lead_byte===null&&this.utf16_lead_surrogate===null)return D;if(this.utf16_lead_byte===null)return this.utf16_lead_byte=r,null;let n;if(this.utf16_be?n=(this.utf16_lead_byte<<8)+r:n=(r<<8)+this.utf16_lead_byte,this.utf16_lead_byte=null,this.utf16_lead_surrogate!==null){const i=this.utf16_lead_surrogate;return this.utf16_lead_surrogate=null,A(n,56320,57343)?65536+(i-55296)*1024+(n-56320):(t.prepend(tt(n,this.utf16_be)),U(this.fatal))}return A(n,55296,56319)?(this.utf16_lead_surrogate=n,null):A(n,56320,57343)?U(this.fatal):n}}class Dr{constructor(t,r){this.utf16_be=t,this.fatal=r.fatal}handler(t,r){if(r===z)return D;if(A(r,0,65535))return tt(r,this.utf16_be);const n=tt((r-65536>>10)+55296,this.utf16_be),i=tt((r-65536&1023)+56320,this.utf16_be);return n.concat(i)}}class tn{constructor(t){this.fatal=t.fatal,this.utf8_code_point=0,this.utf8_bytes_seen=0,this.utf8_bytes_needed=0,this.utf8_lower_boundary=128,this.utf8_upper_boundary=191}handler(t,r){if(r===z&&this.utf8_bytes_needed!==0)return this.utf8_bytes_needed=0,U(this.fatal);if(r===z)return D;if(this.utf8_bytes_needed===0){if(A(r,0,127))return r;if(A(r,194,223))this.utf8_bytes_needed=1,this.utf8_code_point=r&31;else if(A(r,224,239))r===224&&(this.utf8_lower_boundary=160),r===237&&(this.utf8_upper_boundary=159),this.utf8_bytes_needed=2,this.utf8_code_point=r&15;else if(A(r,240,244))r===240&&(this.utf8_lower_boundary=144),r===244&&(this.utf8_upper_boundary=143),this.utf8_bytes_needed=3,this.utf8_code_point=r&7;else return U(this.fatal);return null}if(!A(r,this.utf8_lower_boundary,this.utf8_upper_boundary))return this.utf8_code_point=this.utf8_bytes_needed=this.utf8_bytes_seen=0,this.utf8_lower_boundary=128,this.utf8_upper_boundary=191,t.prepend(r),U(this.fatal);if(this.utf8_lower_boundary=128,this.utf8_upper_boundary=191,this.utf8_code_point=this.utf8_code_point<<6|r&63,this.utf8_bytes_seen+=1,this.utf8_bytes_seen!==this.utf8_bytes_needed)return null;const n=this.utf8_code_point;return this.utf8_code_point=this.utf8_bytes_needed=this.utf8_bytes_seen=0,n}}class rn{constructor(t){this.fatal=t.fatal}handler(t,r){if(r===z)return D;if(G(r))return r;let n,i;A(r,128,2047)?(n=1,i=192):A(r,2048,65535)?(n=2,i=224):A(r,65536,1114111)&&(n=3,i=240);const s=[(r>>6*n)+i];for(;n>0;){const o=r>>6*(n-1);s.push(128|o&63),n-=1}return s}}class nn{constructor(t){this.fatal=t.fatal}handler(t,r){return r===z?D:Z(r)?r:63360+r-128}}class sn{constructor(t){this.fatal=t.fatal}handler(t,r){return r===z?D:G(r)?r:A(r,63360,63487)?r-63360+128:Q(r)}}const an=ri(),Pt={"UTF-8":e=>new rn(e),GBK:e=>new Br(e,!0),gb18030:e=>new Br(e),Big5:e=>new $i(e),"EUC-JP":e=>new Ji(e),"ISO-2022-JP":e=>new Zi(e),Shift_JIS:e=>new Yi(e),"EUC-KR":e=>new Vi(e),"UTF-16BE":e=>new Dr(!0,e),"UTF-16LE":e=>new Dr(!1,e),"x-user-defined":e=>new sn(e)},Mt={"UTF-8":e=>new tn(e),GBK:e=>new kr(e),gb18030:e=>new kr(e),Big5:e=>new Hi(e),"EUC-JP":e=>new Ki(e),"ISO-2022-JP":e=>new Gi(e),Shift_JIS:e=>new Xi(e),"EUC-KR":e=>new Wi(e),"UTF-16BE":e=>new Or(!0,e),"UTF-16LE":e=>new Or(!1,e),"x-user-defined":e=>new nn(e)};an&&Qr.forEach(function(e){e.heading==="Legacy single-byte encodings"&&e.encodings.forEach(function(t){const r=t.name,n=W(r.toLowerCase());Mt[r]=function(i){return new Qi(n,i)},Pt[r]=function(i){return new en(n,i)}})});class ii{constructor(t){this.tokens=Array.from(t),this.tokens.reverse()}endOfStream(){return!this.tokens.length}read(){return this.tokens.length?this.tokens.pop():z}prepend(t){if(Array.isArray(t)){const r=t;for(;r.length;)this.tokens.push(r.pop())}else this.tokens.push(t)}push(t){if(Array.isArray(t)){const r=t;for(;r.length;)this.tokens.unshift(r.shift())}else this.tokens.unshift(t)}}class ni{constructor(t,r){t=t!==void 0?String(t):Yr;const n=st(r);this._encoding=null,this._decoder=null,this._ignoreBOM=!1,this._BOMseen=!1,this._error_mode="replacement",this._do_not_flush=!1;const i=Dt(t);if(i===null||i.name==="replacement")throw RangeError("Unknown encoding: "+t);if(!Mt[i.name])throw Error("Decoder not present. Did you forget to include encoding-indexes.js first?");this._encoding=i,Boolean(n.fatal)&&(this._error_mode="fatal"),Boolean(n.ignoreBOM)&&(this._ignoreBOM=!0)}get encoding(){return this._encoding.name.toLowerCase()}get fatal(){return this._error_mode==="fatal"}get ignoreBOM(){return this._ignoreBOM}decode(t,r){const n=on(t),i=st(r);this._do_not_flush||(this._decoder=Mt[this._encoding.name]({fatal:this._error_mode==="fatal"}),this._BOMseen=!1),this._do_not_flush=Boolean(i.stream);const s=new ii(n),o=[];let l;for(;;){const m=s.read();if(m===z||(l=this._decoder.handler(s,m),l===D))break;l!==null&&(Array.isArray(l)?o.push.apply(o,l):o.push(l))}if(!this._do_not_flush){do{if(l=this._decoder.handler(s,s.read()),l===D)break;!l||(Array.isArray(l)?o.push.apply(o,l):o.push(l))}while(!s.endOfStream());this._decoder=null}return this.serializeStream(o)}serializeStream(t){return Di(["UTF-8","UTF-16LE","UTF-16BE"],this._encoding.name)&&!this._ignoreBOM&&!this._BOMseen&&(t.length>0&&t[0]===65279?(this._BOMseen=!0,t.shift()):t.length>0&&(this._BOMseen=!0)),Pi(t)}}function jr(e){try{return e instanceof ArrayBuffer}catch(t){return console.error(t),!1}}function on(e){return typeof e!="object"?new Uint8Array(0):jr(e)?new Uint8Array(e):"buffer"in e&&jr(e.buffer)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(0)}class si{constructor(t,r){const n=st(r);if(this._encoding=null,this._encoder=null,this._do_not_flush=!1,this._fatal=Boolean(n.fatal)?"fatal":"replacement",Boolean(n.NONSTANDARD_allowLegacyEncoding)){t=t?String(t):Yr;const i=Dt(t);if(i===null||i.name==="replacement")throw RangeError("Unknown encoding: "+t);if(!Pt[i.name])throw Error("Encoder not present. Did you forget to include encoding-indexes.js first?");this._encoding=i}else{this._encoding=Dt("utf-8");const i=ti()||{};t!==void 0&&"console"in i&&console.warn("TextEncoder constructor called with encoding label, which is ignored.")}}get encoding(){return this._encoding.name.toLowerCase()}encode(t,r){t=t===void 0?"":String(t);const n=st(r);this._do_not_flush||(this._encoder=Pt[this._encoding.name]({fatal:this._fatal==="fatal"})),this._do_not_flush=Boolean(n.stream);const i=new ii(ji(t)),s=[];let o;for(;;){const l=i.read();if(l===z||(o=this._encoder.handler(i,l),o===D))break;Array.isArray(o)?s.push.apply(s,o):s.push(o)}if(!this._do_not_flush){for(;o=this._encoder.handler(i,i.read()),o!==D;)Array.isArray(o)?s.push.apply(s,o):s.push(o);this._encoder=null}return new Uint8Array(s)}}if(typeof window<"u"){const e=t=>!(t in window)||typeof window[t]>"u"||window[t]===null;e("TextDecoder")&&(window.TextDecoder=ni),e("TextEncoder")&&(window.TextEncoder=si)}var ai=pn,te=[],Pr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var Qe=0,cn=Pr.length;Qe<cn;++Qe)te[Qe]=Pr[Qe];function ln(e){return te[e>>18&63]+te[e>>12&63]+te[e>>6&63]+te[e&63]}function un(e,t,r){for(var n,i=[],s=t;s<r;s+=3)n=(e[s]<<16&16711680)+(e[s+1]<<8&65280)+(e[s+2]&255),i.push(ln(n));return i.join("")}function pn(e){for(var t,r=e.length,n=r%3,i=[],s=16383,o=0,l=r-n;o<l;o+=s)i.push(un(e,o,o+s>l?l:o+s));return n===1?(t=e[r-1],i.push(te[t>>2]+te[t<<4&63]+"==")):n===2&&(t=(e[r-2]<<8)+e[r-1],i.push(te[t>>10]+te[t>>4&63]+te[t<<2&63]+"=")),i.join("")}var E,_,qr,Ie=(qr=class{constructor(e){w(this,E,void 0);w(this,_,0);y(this,E,new DataView(e.buffer)),y(this,_,e.byteOffset)}get offset(){return a(this,_)}readUInt8Array(){const e=this.readU32(),t=new Uint8Array(a(this,E).buffer,a(this,_),e);return y(this,_,a(this,_)+e),t}readBool(){const e=a(this,E).getUint8(a(this,_));return y(this,_,a(this,_)+1),e!==0}readByte(){const e=a(this,E).getUint8(a(this,_));return y(this,_,a(this,_)+1),e}readBytes(e){const t=new DataView(a(this,E).buffer,a(this,_),e);return y(this,_,a(this,_)+e),new Uint8Array(t.buffer)}readI8(){const e=a(this,E).getInt8(a(this,_));return y(this,_,a(this,_)+1),e}readU8(){const e=a(this,E).getUint8(a(this,_));return y(this,_,a(this,_)+1),e}readI16(){const e=a(this,E).getInt16(a(this,_),!0);return y(this,_,a(this,_)+2),e}readU16(){const e=a(this,E).getUint16(a(this,_),!0);return y(this,_,a(this,_)+2),e}readI32(){const e=a(this,E).getInt32(a(this,_),!0);return y(this,_,a(this,_)+4),e}readU32(){const e=a(this,E).getUint32(a(this,_),!0);return y(this,_,a(this,_)+4),e}readI64(){const e=a(this,E).getBigInt64(a(this,_),!0);return y(this,_,a(this,_)+8),e}readU64(){const e=a(this,E).getBigUint64(a(this,_),!0);return y(this,_,a(this,_)+8),e}readU128(){const e=a(this,E).getBigUint64(a(this,_),!0),t=a(this,E).getBigUint64(a(this,_)+8,!0);return y(this,_,a(this,_)+16),(t<<BigInt(64))+e}readI128(){const e=a(this,E).getBigUint64(a(this,_),!0),t=a(this,E).getBigInt64(a(this,_)+8,!0);return y(this,_,a(this,_)+16),(t<<BigInt(64))+e}readU256(){const e=a(this,E).getBigUint64(a(this,_),!0),t=a(this,E).getBigUint64(a(this,_)+8,!0),r=a(this,E).getBigUint64(a(this,_)+16,!0),n=a(this,E).getBigUint64(a(this,_)+24,!0);return y(this,_,a(this,_)+32),(n<<BigInt(3*64))+(r<<BigInt(2*64))+(t<<BigInt(1*64))+e}readI256(){const e=a(this,E).getBigUint64(a(this,_),!0),t=a(this,E).getBigUint64(a(this,_)+8,!0),r=a(this,E).getBigUint64(a(this,_)+16,!0),n=a(this,E).getBigInt64(a(this,_)+24,!0);return y(this,_,a(this,_)+32),(n<<BigInt(3*64))+(r<<BigInt(2*64))+(t<<BigInt(1*64))+e}readF32(){const e=a(this,E).getFloat32(a(this,_),!0);return y(this,_,a(this,_)+4),e}readF64(){const e=a(this,E).getFloat64(a(this,_),!0);return y(this,_,a(this,_)+8),e}readString(){const e=this.readU32(),t=new Uint8Array(a(this,E).buffer,a(this,_),e),n=new ni("utf-8").decode(t);return y(this,_,a(this,_)+e),n}},E=new WeakMap,_=new WeakMap,qr),V,k,x,L,H,Hr,de=(Hr=class{constructor(e){w(this,L);w(this,V,void 0);w(this,k,void 0);w(this,x,0);y(this,V,new Uint8Array(e)),y(this,k,new DataView(a(this,V).buffer))}toBase64(){return ai(a(this,V).subarray(0,a(this,x)))}getBuffer(){return a(this,V).slice(0,a(this,x))}writeUInt8Array(e){const t=e.length;g(this,L,H).call(this,4+t),this.writeU32(t),a(this,V).set(e,a(this,x)),y(this,x,a(this,x)+e.length)}writeBool(e){g(this,L,H).call(this,1),a(this,k).setUint8(a(this,x),e?1:0),y(this,x,a(this,x)+1)}writeByte(e){g(this,L,H).call(this,1),a(this,k).setUint8(a(this,x),e),y(this,x,a(this,x)+1)}writeI8(e){g(this,L,H).call(this,1),a(this,k).setInt8(a(this,x),e),y(this,x,a(this,x)+1)}writeU8(e){g(this,L,H).call(this,1),a(this,k).setUint8(a(this,x),e),y(this,x,a(this,x)+1)}writeI16(e){g(this,L,H).call(this,2),a(this,k).setInt16(a(this,x),e,!0),y(this,x,a(this,x)+2)}writeU16(e){g(this,L,H).call(this,2),a(this,k).setUint16(a(this,x),e,!0),y(this,x,a(this,x)+2)}writeI32(e){g(this,L,H).call(this,4),a(this,k).setInt32(a(this,x),e,!0),y(this,x,a(this,x)+4)}writeU32(e){g(this,L,H).call(this,4),a(this,k).setUint32(a(this,x),e,!0),y(this,x,a(this,x)+4)}writeI64(e){g(this,L,H).call(this,8),a(this,k).setBigInt64(a(this,x),e,!0),y(this,x,a(this,x)+8)}writeU64(e){g(this,L,H).call(this,8),a(this,k).setBigUint64(a(this,x),e,!0),y(this,x,a(this,x)+8)}writeU128(e){g(this,L,H).call(this,16);const t=e&BigInt("0xFFFFFFFFFFFFFFFF"),r=e>>BigInt(64);a(this,k).setBigUint64(a(this,x),t,!0),a(this,k).setBigUint64(a(this,x)+8,r,!0),y(this,x,a(this,x)+16)}writeI128(e){g(this,L,H).call(this,16);const t=e&BigInt("0xFFFFFFFFFFFFFFFF"),r=e>>BigInt(64);a(this,k).setBigInt64(a(this,x),t,!0),a(this,k).setBigInt64(a(this,x)+8,r,!0),y(this,x,a(this,x)+16)}writeU256(e){g(this,L,H).call(this,32);const t=BigInt("0xFFFFFFFFFFFFFFFF"),r=e&t,n=e>>BigInt(64*1)&t,i=e>>BigInt(64*2)&t,s=e>>BigInt(64*3);a(this,k).setBigUint64(a(this,x)+8*0,r,!0),a(this,k).setBigUint64(a(this,x)+8*1,n,!0),a(this,k).setBigUint64(a(this,x)+8*2,i,!0),a(this,k).setBigUint64(a(this,x)+8*3,s,!0),y(this,x,a(this,x)+32)}writeI256(e){g(this,L,H).call(this,32);const t=BigInt("0xFFFFFFFFFFFFFFFF"),r=e&t,n=e>>BigInt(64*1)&t,i=e>>BigInt(64*2)&t,s=e>>BigInt(64*3);a(this,k).setBigUint64(a(this,x)+8*0,r,!0),a(this,k).setBigUint64(a(this,x)+8*1,n,!0),a(this,k).setBigUint64(a(this,x)+8*2,i,!0),a(this,k).setBigInt64(a(this,x)+8*3,s,!0),y(this,x,a(this,x)+32)}writeF32(e){g(this,L,H).call(this,4),a(this,k).setFloat32(a(this,x),e,!0),y(this,x,a(this,x)+4)}writeF64(e){g(this,L,H).call(this,8),a(this,k).setFloat64(a(this,x),e,!0),y(this,x,a(this,x)+8)}writeString(e){const r=new si().encode(e);this.writeU32(r.length),g(this,L,H).call(this,r.length),a(this,V).set(r,a(this,x)),y(this,x,a(this,x)+r.length)}},V=new WeakMap,k=new WeakMap,x=new WeakMap,L=new WeakSet,H=function(e){const t=a(this,x)+e+1;if(t<=a(this,V).length)return;let r=a(this,V).length*2;r<t&&(r=t);const n=new Uint8Array(r);n.set(a(this,V)),y(this,V,n),y(this,k,new DataView(a(this,V).buffer))},Hr);function It(e,t){if(e===t)return!0;if(typeof e!="object"||e===null||typeof t!="object"||t===null)return!1;const r=Object.keys(e),n=Object.keys(t);if(r.length!==n.length)return!1;for(let i of r)if(!n.includes(i)||!It(e[i],t[i]))return!1;return!0}function oi(e){return Array.prototype.map.call(e.reverse(),t=>("00"+t.toString(16)).slice(-2)).join("")}function hn(e){if(e.length!=16)throw new Error(`Uint8Array is not 16 bytes long: ${e}`);return new Ie(e).readU128()}function dn(e){if(e.length!=32)throw new Error(`Uint8Array is not 32 bytes long: [${e}]`);return new Ie(e).readU256()}function ci(e){e.startsWith("0x")&&(e=e.slice(2));let t=e.match(/.{1,2}/g)||[],r=Uint8Array.from(t.map(n=>parseInt(n,16)));return r.length!=32?new Uint8Array(0):r.reverse()}function fn(e){return hn(ci(e))}function yn(e){return dn(ci(e))}function li(e){let t=new de(16);return t.writeU128(e),t.getBuffer()}function gn(e){return oi(li(e))}function ui(e){let t=new de(32);return t.writeU256(e),t.getBuffer()}function Tn(e){return oi(ui(e))}var Rt=class rt{constructor(t){h(this,"data");this.data=t}get __connection_id__(){return this.data}isZero(){return this.data===BigInt(0)}static nullIfZero(t){return t.isZero()?null:t}static random(){function t(){return Math.floor(Math.random()*255)}let r=BigInt(0);for(let n=0;n<16;n++)r=r<<BigInt(8)|BigInt(t());return new rt(r)}isEqual(t){return this.data==t.data}toHexString(){return gn(this.data)}toUint8Array(){return li(this.data)}static fromString(t){return new rt(fn(t))}static fromStringOrNull(t){let r=rt.fromString(t);return r.isZero()?null:r}},fe,bn=(fe=class{constructor(t){h(this,"__time_duration_micros__");this.__time_duration_micros__=t}get micros(){return this.__time_duration_micros__}get millis(){return Number(this.micros/fe.MICROS_PER_MILLIS)}static fromMillis(t){return new fe(BigInt(t)*fe.MICROS_PER_MILLIS)}},h(fe,"MICROS_PER_MILLIS",1000n),fe),Y,mn=(Y=class{constructor(t){h(this,"__timestamp_micros_since_unix_epoch__");this.__timestamp_micros_since_unix_epoch__=t}get microsSinceUnixEpoch(){return this.__timestamp_micros_since_unix_epoch__}static now(){return Y.fromDate(new Date)}static fromDate(t){const r=t.getTime(),n=BigInt(r)*Y.MICROS_PER_MILLIS;return new Y(n)}toDate(){const r=this.__timestamp_micros_since_unix_epoch__/Y.MICROS_PER_MILLIS;if(r>BigInt(Number.MAX_SAFE_INTEGER)||r<BigInt(Number.MIN_SAFE_INTEGER))throw new RangeError("Timestamp is outside of the representable range of JS's Date");return new Date(Number(r))}},h(Y,"MICROS_PER_MILLIS",1000n),h(Y,"UNIX_EPOCH",new Y(0n)),Y),pi=class hi{constructor(t){h(this,"data");this.data=typeof t=="string"?yn(t):t}get __identity__(){return this.data}isEqual(t){return this.toHexString()===t.toHexString()}toHexString(){return Tn(this.data)}toUint8Array(){return ui(this.data)}static fromString(t){return new hi(t)}},Lt;(e=>{function t(){return c.createSumType([new B("Interval",c.createTimeDurationType()),new B("Time",c.createTimestampType())])}e.getAlgebraicType=t,e.Interval=n=>({tag:"Interval",value:{__time_duration_micros__:n}}),e.Time=n=>({tag:"Time",value:{__timestamp_micros_since_unix_epoch__:n}});function r(n){let i=n.asSumValue();switch(i.tag){case 0:return{tag:"Interval",value:{__time_duration_micros__:i.value.asProductValue().elements[0].asBigInt()}};case 1:return{tag:"Time",value:{__timestamp_micros_since_unix_epoch__:i.value.asBigInt()}};default:throw"unreachable"}}e.fromValue=r})(Lt||(Lt={}));var wn=Lt,B=class{constructor(e,t){h(this,"name");h(this,"algebraicType");this.name=e,this.algebraicType=t}},_n=class{constructor(e){h(this,"variants");h(this,"serialize",(e,t)=>{if(this.variants.length==2&&this.variants[0].name==="some"&&this.variants[1].name==="none")t!=null?(e.writeByte(0),this.variants[0].algebraicType.serialize(e,t)):e.writeByte(1);else{let r=t.tag;const n=this.variants.findIndex(i=>i.name===r);if(n<0)throw`Can't serialize a sum type, couldn't find ${t.tag} tag`;e.writeU8(n),this.variants[n].algebraicType.serialize(e,t.value)}});h(this,"deserialize",e=>{let t=e.readU8();if(this.variants.length==2&&this.variants[0].name==="some"&&this.variants[1].name==="none"){if(t===0)return this.variants[0].algebraicType.deserialize(e);if(t===1)return;throw`Can't deserialize an option type, couldn't find ${t} tag`}else{let r=this.variants[t],n=r.algebraicType.deserialize(e);return{tag:r.name,value:n}}});this.variants=e}},u=class{constructor(e,t){h(this,"name");h(this,"algebraicType");this.name=e,this.algebraicType=t}},xn=class{constructor(e){h(this,"elements");h(this,"serialize",(e,t)=>{for(let r of this.elements)r.algebraicType.serialize(e,t[r.name])});h(this,"deserialize",e=>{let t={};if(this.elements.length===1){if(this.elements[0].name==="__time_duration_micros__")return new bn(e.readI64());if(this.elements[0].name==="__timestamp_micros_since_unix_epoch__")return new mn(e.readI64());if(this.elements[0].name==="__identity__")return new pi(e.readU256());if(this.elements[0].name==="__connection_id__")return new Rt(e.readU128())}for(let r of this.elements)t[r.name]=r.algebraicType.deserialize(e);return t});this.elements=e}isEmpty(){return this.elements.length===0}intoMapKey(e){if(this.elements.length===1){if(this.elements[0].name==="__time_duration_micros__")return e.__time_duration_micros__;if(this.elements[0].name==="__timestamp_micros_since_unix_epoch__")return e.__timestamp_micros_since_unix_epoch__;if(this.elements[0].name==="__identity__")return e.__identity__;if(this.elements[0].name==="__connection_id__")return e.__connection_id__}const t=new de(10);return this.serialize(t,e),t.toBase64()}},Sn=class{constructor(e,t){h(this,"keyType");h(this,"valueType");this.keyType=e,this.valueType=t}},oe,Se,M,Fe,R,Re,Nt,Le,qt,Ne,Ht,c=(Fe=class{constructor(){w(this,oe);w(this,Re);w(this,Le);w(this,Ne);h(this,"type");h(this,"type_")}get product(){if(this.type!==d.ProductType)throw"product type was requested, but the type is not ProductType";return this.type_}set product(t){g(this,oe,Se).call(this,d.ProductType,t)}get sum(){if(this.type!==d.SumType)throw"sum type was requested, but the type is not SumType";return this.type_}set sum(t){g(this,oe,Se).call(this,d.SumType,t)}get array(){if(this.type!==d.ArrayType)throw"array type was requested, but the type is not ArrayType";return this.type_}set array(t){g(this,oe,Se).call(this,d.ArrayType,t)}get map(){if(this.type!==d.MapType)throw"map type was requested, but the type is not MapType";return this.type_}set map(t){g(this,oe,Se).call(this,d.MapType,t)}static createProductType(t){return g(this,M,R).call(this,d.ProductType,new xn(t))}static createSumType(t){return g(this,M,R).call(this,d.SumType,new _n(t))}static createArrayType(t){return g(this,M,R).call(this,d.ArrayType,t)}static createMapType(t,r){return g(this,M,R).call(this,d.MapType,new Sn(t,r))}static createBoolType(){return g(this,M,R).call(this,d.Bool,null)}static createI8Type(){return g(this,M,R).call(this,d.I8,null)}static createU8Type(){return g(this,M,R).call(this,d.U8,null)}static createI16Type(){return g(this,M,R).call(this,d.I16,null)}static createU16Type(){return g(this,M,R).call(this,d.U16,null)}static createI32Type(){return g(this,M,R).call(this,d.I32,null)}static createU32Type(){return g(this,M,R).call(this,d.U32,null)}static createI64Type(){return g(this,M,R).call(this,d.I64,null)}static createU64Type(){return g(this,M,R).call(this,d.U64,null)}static createI128Type(){return g(this,M,R).call(this,d.I128,null)}static createU128Type(){return g(this,M,R).call(this,d.U128,null)}static createI256Type(){return g(this,M,R).call(this,d.I256,null)}static createU256Type(){return g(this,M,R).call(this,d.U256,null)}static createF32Type(){return g(this,M,R).call(this,d.F32,null)}static createF64Type(){return g(this,M,R).call(this,d.F64,null)}static createStringType(){return g(this,M,R).call(this,d.String,null)}static createBytesType(){return this.createArrayType(this.createU8Type())}static createOptionType(t){return this.createSumType([new B("some",t),new B("none",this.createProductType([]))])}static createIdentityType(){return this.createProductType([new u("__identity__",this.createU256Type())])}static createConnectionIdType(){return this.createProductType([new u("__connection_id__",this.createU128Type())])}static createScheduleAtType(){return wn.getAlgebraicType()}static createTimestampType(){return this.createProductType([new u("__timestamp_micros_since_unix_epoch__",this.createI64Type())])}static createTimeDurationType(){return this.createProductType([new u("__time_duration_micros__",this.createI64Type())])}isProductType(){return this.type===d.ProductType}isSumType(){return this.type===d.SumType}isArrayType(){return this.type===d.ArrayType}isMapType(){return this.type===d.MapType}isIdentity(){return g(this,Le,qt).call(this,"__identity__")}isConnectionId(){return g(this,Le,qt).call(this,"__connection_id__")}isScheduleAt(){return this.isSumType()&&this.sum.variants.length===2&&this.sum.variants[0].name==="Interval"&&this.sum.variants[0].algebraicType.type===d.U64&&this.sum.variants[1].name==="Time"&&this.sum.variants[1].algebraicType.type===d.U64}isTimestamp(){return g(this,Ne,Ht).call(this,"__timestamp_micros_since_unix_epoch__")}isTimeDuration(){return g(this,Ne,Ht).call(this,"__time_duration_micros__")}intoMapKey(t){switch(this.type){case d.U8:case d.U16:case d.U32:case d.U64:case d.U128:case d.U256:case d.I8:case d.I16:case d.I64:case d.I128:case d.F32:case d.F64:case d.String:case d.Bool:return t;case d.ProductType:return this.product.intoMapKey(t);default:const r=new de(10);return this.serialize(r,t),r.toBase64()}}serialize(t,r){switch(this.type){case d.ProductType:this.product.serialize(t,r);break;case d.SumType:this.sum.serialize(t,r);break;case d.ArrayType:if(g(this,Re,Nt).call(this))t.writeUInt8Array(r);else{const n=this.array;t.writeU32(r.length);for(let i of r)n.serialize(t,i)}break;case d.MapType:throw new Error("not implemented");case d.Bool:t.writeBool(r);break;case d.I8:t.writeI8(r);break;case d.U8:t.writeU8(r);break;case d.I16:t.writeI16(r);break;case d.U16:t.writeU16(r);break;case d.I32:t.writeI32(r);break;case d.U32:t.writeU32(r);break;case d.I64:t.writeI64(r);break;case d.U64:t.writeU64(r);break;case d.I128:t.writeI128(r);break;case d.U128:t.writeU128(r);break;case d.I256:t.writeI256(r);break;case d.U256:t.writeU256(r);break;case d.F32:t.writeF32(r);break;case d.F64:t.writeF64(r);break;case d.String:t.writeString(r);break;default:throw new Error(`not implemented, ${this.type}`)}}deserialize(t){switch(this.type){case d.ProductType:return this.product.deserialize(t);case d.SumType:return this.sum.deserialize(t);case d.ArrayType:if(g(this,Re,Nt).call(this))return t.readUInt8Array();{const r=this.array,n=t.readU32();let i=[];for(let s=0;s<n;s++)i.push(r.deserialize(t));return i}case d.MapType:throw new Error("not implemented");case d.Bool:return t.readBool();case d.I8:return t.readI8();case d.U8:return t.readU8();case d.I16:return t.readI16();case d.U16:return t.readU16();case d.I32:return t.readI32();case d.U32:return t.readU32();case d.I64:return t.readI64();case d.U64:return t.readU64();case d.I128:return t.readI128();case d.U128:return t.readU128();case d.U256:return t.readU256();case d.F32:return t.readF32();case d.F64:return t.readF64();case d.String:return t.readString();default:throw new Error(`not implemented, ${this.type}`)}}},oe=new WeakSet,Se=function(t,r){this.type_=r,this.type=r===void 0?d.None:t},M=new WeakSet,R=function(t,r){var i;let n=new Fe;return g(i=n,oe,Se).call(i,t,r),n},Re=new WeakSet,Nt=function(){return this.isArrayType()&&this.array.type==d.U8},Le=new WeakSet,qt=function(t){return this.isProductType()&&this.product.elements.length===1&&(this.product.elements[0].algebraicType.type==d.U128||this.product.elements[0].algebraicType.type==d.U256)&&this.product.elements[0].name===t},Ne=new WeakSet,Ht=function(t){return this.isProductType()&&this.product.elements.length===1&&this.product.elements[0].algebraicType.type===d.I64&&this.product.elements[0].name===t},w(Fe,M),Fe);(e=>{(t=>{t.SumType="SumType",t.ProductType="ProductType",t.ArrayType="ArrayType",t.MapType="MapType",t.Bool="Bool",t.I8="I8",t.U8="U8",t.I16="I16",t.U16="U16",t.I32="I32",t.U32="U32",t.I64="I64",t.U64="U64",t.I128="I128",t.U128="U128",t.I256="I256",t.U256="U256",t.F32="F32",t.F64="F64",t.String="String",t.None="None"})(e.Type||(e.Type={}))})(c||(c={}));var d=c.Type;function An(e,t){const r=new Ie(t);return e.deserialize(r)}var $t;(e=>{e.FixedSize=i=>({tag:"FixedSize",value:i}),e.RowOffsets=i=>({tag:"RowOffsets",value:i});function t(){return c.createSumType([new B("FixedSize",c.createU16Type()),new B("RowOffsets",c.createArrayType(c.createU64Type()))])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})($t||($t={}));var Me;(e=>{function t(){return c.createProductType([new u("sizeHint",$t.getTypeScriptAlgebraicType()),new u("rowsData",c.createArrayType(c.createU8Type()))])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(Me||(Me={}));var Kt;(e=>{function t(){return c.createProductType([new u("reducer",c.createStringType()),new u("args",c.createArrayType(c.createU8Type())),new u("requestId",c.createU32Type()),new u("flags",c.createU8Type())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(Kt||(Kt={}));var Jt;(e=>{function t(){return c.createProductType([new u("queryStrings",c.createArrayType(c.createStringType())),new u("requestId",c.createU32Type())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(Jt||(Jt={}));var Wt;(e=>{function t(){return c.createProductType([new u("messageId",c.createArrayType(c.createU8Type())),new u("queryString",c.createStringType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(Wt||(Wt={}));var re;(e=>{function t(){return c.createProductType([new u("id",c.createU32Type())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(re||(re={}));var Vt;(e=>{function t(){return c.createProductType([new u("query",c.createStringType()),new u("requestId",c.createU32Type()),new u("queryId",re.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(Vt||(Vt={}));var Gt;(e=>{function t(){return c.createProductType([new u("queryStrings",c.createArrayType(c.createStringType())),new u("requestId",c.createU32Type()),new u("queryId",re.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(Gt||(Gt={}));var Zt;(e=>{function t(){return c.createProductType([new u("requestId",c.createU32Type()),new u("queryId",re.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(Zt||(Zt={}));var Xt;(e=>{function t(){return c.createProductType([new u("requestId",c.createU32Type()),new u("queryId",re.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(Xt||(Xt={}));var Ae;(e=>{e.CallReducer=i=>({tag:"CallReducer",value:i}),e.Subscribe=i=>({tag:"Subscribe",value:i}),e.OneOffQuery=i=>({tag:"OneOffQuery",value:i}),e.SubscribeSingle=i=>({tag:"SubscribeSingle",value:i}),e.SubscribeMulti=i=>({tag:"SubscribeMulti",value:i}),e.Unsubscribe=i=>({tag:"Unsubscribe",value:i}),e.UnsubscribeMulti=i=>({tag:"UnsubscribeMulti",value:i});function t(){return c.createSumType([new B("CallReducer",Kt.getTypeScriptAlgebraicType()),new B("Subscribe",Jt.getTypeScriptAlgebraicType()),new B("OneOffQuery",Wt.getTypeScriptAlgebraicType()),new B("SubscribeSingle",Vt.getTypeScriptAlgebraicType()),new B("SubscribeMulti",Gt.getTypeScriptAlgebraicType()),new B("Unsubscribe",Zt.getTypeScriptAlgebraicType()),new B("UnsubscribeMulti",Xt.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(Ae||(Ae={}));var at;(e=>{function t(){return c.createProductType([new u("deletes",Me.getTypeScriptAlgebraicType()),new u("inserts",Me.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(at||(at={}));var Yt;(e=>{e.Uncompressed=i=>({tag:"Uncompressed",value:i}),e.Brotli=i=>({tag:"Brotli",value:i}),e.Gzip=i=>({tag:"Gzip",value:i});function t(){return c.createSumType([new B("Uncompressed",at.getTypeScriptAlgebraicType()),new B("Brotli",c.createArrayType(c.createU8Type())),new B("Gzip",c.createArrayType(c.createU8Type()))])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(Yt||(Yt={}));var ot;(e=>{function t(){return c.createProductType([new u("tableId",c.createU32Type()),new u("tableName",c.createStringType()),new u("numRows",c.createU64Type()),new u("updates",c.createArrayType(Yt.getTypeScriptAlgebraicType()))])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(ot||(ot={}));var _e;(e=>{function t(){return c.createProductType([new u("tables",c.createArrayType(ot.getTypeScriptAlgebraicType()))])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(_e||(_e={}));var Qt;(e=>{function t(){return c.createProductType([new u("databaseUpdate",_e.getTypeScriptAlgebraicType()),new u("requestId",c.createU32Type()),new u("totalHostExecutionDuration",c.createTimeDurationType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(Qt||(Qt={}));var er;(e=>{e.Committed=i=>({tag:"Committed",value:i}),e.Failed=i=>({tag:"Failed",value:i}),e.OutOfEnergy={tag:"OutOfEnergy"};function t(){return c.createSumType([new B("Committed",_e.getTypeScriptAlgebraicType()),new B("Failed",c.createStringType()),new B("OutOfEnergy",c.createProductType([]))])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(er||(er={}));var tr;(e=>{function t(){return c.createProductType([new u("reducerName",c.createStringType()),new u("reducerId",c.createU32Type()),new u("args",c.createArrayType(c.createU8Type())),new u("requestId",c.createU32Type())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(tr||(tr={}));var rr;(e=>{function t(){return c.createProductType([new u("quanta",c.createU128Type())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(rr||(rr={}));var ir;(e=>{function t(){return c.createProductType([new u("status",er.getTypeScriptAlgebraicType()),new u("timestamp",c.createTimestampType()),new u("callerIdentity",c.createIdentityType()),new u("callerConnectionId",c.createConnectionIdType()),new u("reducerCall",tr.getTypeScriptAlgebraicType()),new u("energyQuantaUsed",rr.getTypeScriptAlgebraicType()),new u("totalHostExecutionDuration",c.createTimeDurationType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(ir||(ir={}));var nr;(e=>{function t(){return c.createProductType([new u("requestId",c.createU32Type()),new u("update",_e.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(nr||(nr={}));var sr;(e=>{function t(){return c.createProductType([new u("identity",c.createIdentityType()),new u("token",c.createStringType()),new u("connectionId",c.createConnectionIdType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(sr||(sr={}));var ar;(e=>{function t(){return c.createProductType([new u("tableName",c.createStringType()),new u("rows",Me.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(ar||(ar={}));var or;(e=>{function t(){return c.createProductType([new u("messageId",c.createArrayType(c.createU8Type())),new u("error",c.createOptionType(c.createStringType())),new u("tables",c.createArrayType(ar.getTypeScriptAlgebraicType())),new u("totalHostExecutionDuration",c.createTimeDurationType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(or||(or={}));var ct;(e=>{function t(){return c.createProductType([new u("tableId",c.createU32Type()),new u("tableName",c.createStringType()),new u("tableRows",ot.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(ct||(ct={}));var cr;(e=>{function t(){return c.createProductType([new u("requestId",c.createU32Type()),new u("totalHostExecutionDurationMicros",c.createU64Type()),new u("queryId",re.getTypeScriptAlgebraicType()),new u("rows",ct.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(cr||(cr={}));var lr;(e=>{function t(){return c.createProductType([new u("requestId",c.createU32Type()),new u("totalHostExecutionDurationMicros",c.createU64Type()),new u("queryId",re.getTypeScriptAlgebraicType()),new u("rows",ct.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(lr||(lr={}));var ur;(e=>{function t(){return c.createProductType([new u("totalHostExecutionDurationMicros",c.createU64Type()),new u("requestId",c.createOptionType(c.createU32Type())),new u("queryId",c.createOptionType(c.createU32Type())),new u("tableId",c.createOptionType(c.createU32Type())),new u("error",c.createStringType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(ur||(ur={}));var pr;(e=>{function t(){return c.createProductType([new u("requestId",c.createU32Type()),new u("totalHostExecutionDurationMicros",c.createU64Type()),new u("queryId",re.getTypeScriptAlgebraicType()),new u("update",_e.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(pr||(pr={}));var hr;(e=>{function t(){return c.createProductType([new u("requestId",c.createU32Type()),new u("totalHostExecutionDurationMicros",c.createU64Type()),new u("queryId",re.getTypeScriptAlgebraicType()),new u("update",_e.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(hr||(hr={}));var dr;(e=>{e.InitialSubscription=i=>({tag:"InitialSubscription",value:i}),e.TransactionUpdate=i=>({tag:"TransactionUpdate",value:i}),e.TransactionUpdateLight=i=>({tag:"TransactionUpdateLight",value:i}),e.IdentityToken=i=>({tag:"IdentityToken",value:i}),e.OneOffQueryResponse=i=>({tag:"OneOffQueryResponse",value:i}),e.SubscribeApplied=i=>({tag:"SubscribeApplied",value:i}),e.UnsubscribeApplied=i=>({tag:"UnsubscribeApplied",value:i}),e.SubscriptionError=i=>({tag:"SubscriptionError",value:i}),e.SubscribeMultiApplied=i=>({tag:"SubscribeMultiApplied",value:i}),e.UnsubscribeMultiApplied=i=>({tag:"UnsubscribeMultiApplied",value:i});function t(){return c.createSumType([new B("InitialSubscription",Qt.getTypeScriptAlgebraicType()),new B("TransactionUpdate",ir.getTypeScriptAlgebraicType()),new B("TransactionUpdateLight",nr.getTypeScriptAlgebraicType()),new B("IdentityToken",sr.getTypeScriptAlgebraicType()),new B("OneOffQueryResponse",or.getTypeScriptAlgebraicType()),new B("SubscribeApplied",cr.getTypeScriptAlgebraicType()),new B("UnsubscribeApplied",lr.getTypeScriptAlgebraicType()),new B("SubscriptionError",ur.getTypeScriptAlgebraicType()),new B("SubscribeMultiApplied",pr.getTypeScriptAlgebraicType()),new B("UnsubscribeMultiApplied",hr.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(dr||(dr={}));var be,$r,Ft=($r=class{constructor(){w(this,be,new Map)}on(e,t){let r=a(this,be).get(e);r||(r=new Set,a(this,be).set(e,r)),r.add(t)}off(e,t){let r=a(this,be).get(e);!r||r.delete(t)}emit(e,...t){let r=a(this,be).get(e);if(!!r)for(let n of r)n(...t)}},be=new WeakMap,$r),In={component:"\u{1F4E6}",info:"\u2139\uFE0F",warn:"\u26A0\uFE0F",error:"\u274C",debug:"\u{1F41B}"},Fn={component:"color: #fff; background-color: #8D6FDD; padding: 2px 5px; border-radius: 3px;",info:"color: #fff; background-color: #007bff; padding: 2px 5px; border-radius: 3px;",warn:"color: #fff; background-color: #ffc107; padding: 2px 5px; border-radius: 3px;",error:"color: #fff; background-color: #dc3545; padding: 2px 5px; border-radius: 3px;",debug:"color: #fff; background-color: #28a745; padding: 2px 5px; border-radius: 3px;"},Un={component:"color: #8D6FDD;",info:"color: #007bff;",warn:"color: #ffc107;",error:"color: #dc3545;",debug:"color: #28a745;"},he=(e,t)=>{console.log(`%c${In[e]} ${e.toUpperCase()}%c ${t}`,Fn[e],Un[e])},zn=class{constructor(e){h(this,"rows");h(this,"tableTypeInfo");h(this,"emitter");h(this,"applyOperations",(e,t)=>{const r=[];if(this.tableTypeInfo.primaryKeyInfo!==void 0){const n=new Map,i=new Map;for(const s of e)if(s.type==="insert"){const[o,l]=n.get(s.rowId)||[s,0];n.set(s.rowId,[s,l+1])}else{const[o,l]=i.get(s.rowId)||[s,0];i.set(s.rowId,[s,l+1])}for(const[s,[o,l]]of n){const m=i.get(s);if(m){const[S,I]=m,v=l-I,C=this.update(t,s,o.row,v);C&&r.push(C),i.delete(s)}else{const S=this.insert(t,o,l);S&&r.push(S)}}for(const[s,o]of i.values()){const l=this.delete(t,s,o);l&&r.push(l)}}else for(const n of e)if(n.type==="insert"){const i=this.insert(t,n);i&&r.push(i)}else{const i=this.delete(t,n);i&&r.push(i)}return r});h(this,"update",(e,t,r,n=0)=>{const i=this.rows.get(t);if(!i){he("error",`Updating a row that was not present in the cache. Table: ${this.tableTypeInfo.tableName}, RowId: ${t}`);return}const[s,o]=i,l=Math.max(1,o+n);if(o+n<=0){he("error",`Negative reference count for in table ${this.tableTypeInfo.tableName} row ${t} (${o} + ${n})`);return}return this.rows.set(t,[r,l]),o===0?(he("error",`Updating a row id in table ${this.tableTypeInfo.tableName} which was not present in the cache (rowId: ${t})`),{type:"insert",table:this.tableTypeInfo.tableName,cb:()=>{this.emitter.emit("insert",e,r)}}):{type:"update",table:this.tableTypeInfo.tableName,cb:()=>{this.emitter.emit("update",e,s,r)}}});h(this,"insert",(e,t,r=1)=>{const[n,i]=this.rows.get(t.rowId)||[t.row,0];if(this.rows.set(t.rowId,[t.row,i+r]),i===0)return{type:"insert",table:this.tableTypeInfo.tableName,cb:()=>{this.emitter.emit("insert",e,t.row)}}});h(this,"delete",(e,t,r=1)=>{const[n,i]=this.rows.get(t.rowId)||[t.row,0];if(i===0){he("warn","Deleting a row that was not present in the cache");return}if(i<=r)return this.rows.delete(t.rowId),{type:"delete",table:this.tableTypeInfo.tableName,cb:()=>{this.emitter.emit("delete",e,t.row)}};this.rows.set(t.rowId,[t.row,i-r])});h(this,"onInsert",e=>{this.emitter.on("insert",e)});h(this,"onDelete",e=>{this.emitter.on("delete",e)});h(this,"onUpdate",e=>{this.emitter.on("update",e)});h(this,"removeOnInsert",e=>{this.emitter.off("insert",e)});h(this,"removeOnDelete",e=>{this.emitter.off("delete",e)});h(this,"removeOnUpdate",e=>{this.emitter.off("update",e)});this.tableTypeInfo=e,this.rows=new Map,this.emitter=new Ft}count(){return this.rows.size}iter(){return Array.from(this.rows.values()).map(([e])=>e)}},vn=class{constructor(){h(this,"tables");this.tables=new Map}getTable(e){const t=this.tables.get(e);if(!t)throw console.error("The table has not been registered for this client. Please register the table before using it. If you have registered global tables using the SpacetimeDBClient.registerTables() or `registerTable()` method, please make sure that is executed first!"),new Error(`Table ${e} does not exist`);return t}getOrCreateTable(e){let t;return this.tables.has(e.tableName)?t=this.tables.get(e.tableName):(t=new zn(e),this.tables.set(e.tableName,t)),t}};function Cn(e,t){const r=Math.min(e.length,t.length);for(let n=0;n<r;n++){const i=e[n],s=t[n];if(i!==s)return typeof i=="number"&&typeof s=="number"?i-s:typeof i=="string"&&typeof s=="string"?i.localeCompare(s):typeof i=="string"?1:-1}return e.length-t.length}var di=class fr{constructor(t,r,n,i=null,s=null){h(this,"major");h(this,"minor");h(this,"patch");h(this,"preRelease");h(this,"buildInfo");this.major=t,this.minor=r,this.patch=n,this.preRelease=i,this.buildInfo=s}toString(){let t=`${this.major}.${this.minor}.${this.patch}`;return this.preRelease&&(t+=`-${this.preRelease.join(".")}`),this.buildInfo&&(t+=`+${this.buildInfo}`),t}compare(t){return this.major!==t.major?this.major-t.major:this.minor!==t.minor?this.minor-t.minor:this.patch!==t.patch?this.patch-t.patch:this.preRelease&&t.preRelease?Cn(this.preRelease,t.preRelease):this.preRelease||t.preRelease?-1:0}clone(){return new fr(this.major,this.minor,this.patch,this.preRelease?[...this.preRelease]:null,this.buildInfo)}static parseVersionString(t){const r=/^(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)(?:-([\da-zA-Z-]+(?:\.[\da-zA-Z-]+)*))?(?:\+([\da-zA-Z-]+(?:\.[\da-zA-Z-]+)*))?$/,n=t.match(r);if(!n)throw new Error(`Invalid version string: ${t}`);const i=parseInt(n[1],10),s=parseInt(n[2],10),o=parseInt(n[3],10),l=n[4]?n[4].split(".").map(S=>isNaN(Number(S))?S:Number(S)):null,m=n[5]||null;return new fr(i,s,o,l,m)}},fi=new di(1,2,0);function En(e){if(e===void 0)throw new Error(Mr(e));if(di.parseVersionString(e).compare(fi)<0)throw new Error(Mr(e))}function Mr(e){return`Module code was generated with an incompatible version of the spacetimedb cli (${e}).  Update the cli version to at least ${fi.toString()} and regenerate the bindings. You can upgrade to the latest cli version by running: spacetime version upgrade`}async function yi(e,t,r=128*1024){let n=0;const i=new ReadableStream({pull(p){if(n<e.length){const f=e.subarray(n,Math.min(n+r,e.length));p.enqueue(f),n+=r}else p.close()}}),s=new DecompressionStream(t),l=i.pipeThrough(s).getReader(),m=[];let S=0,I;for(;!(I=await l.read()).done;)m.push(I.value),S+=I.value.length;const v=new Uint8Array(S);let C=0;for(const p of m)v.set(p,C),C+=p.length;return v}var Ue,gt,gi,Tt,Ti,qe,yr,He,kn=(He=class{constructor(t){w(this,gt);w(this,Tt);w(this,qe);h(this,"onclose");h(this,"onopen");h(this,"onmessage");h(this,"onerror");w(this,Ue,void 0);this.onmessage=void 0,this.onopen=void 0,this.onmessage=void 0,this.onerror=void 0,t.onmessage=g(this,gt,gi).bind(this),t.onerror=g(this,qe,yr).bind(this),t.onclose=g(this,qe,yr).bind(this),t.onopen=g(this,Tt,Ti).bind(this),t.binaryType="arraybuffer",y(this,Ue,t)}send(t){a(this,Ue).send(t)}close(){a(this,Ue).close()}static async createWebSocketFn({url:t,nameOrAddress:r,wsProtocol:n,authToken:i,compression:s,lightMode:o}){const l=new Headers;let m;m=WebSocket;let S;if(i){l.set("Authorization",`Bearer ${i}`);const C=new URL("v1/identity/websocket-token",t);C.protocol=t.protocol==="wss:"?"https:":"http:";const p=await fetch(C,{method:"POST",headers:l});if(p.ok){const{token:f}=await p.json();S=f}else return Promise.reject(new Error(`Failed to verify token: ${p.statusText}`))}const I=new URL(`v1/database/${r}/subscribe`,t);S&&I.searchParams.set("token",S),I.searchParams.set("compression",s==="gzip"?"Gzip":"None"),o&&I.searchParams.set("light","true");const v=new m(I.toString(),n);return new He(v)}},Ue=new WeakMap,gt=new WeakSet,gi=async function(t){const r=new Uint8Array(t.data);let n;if(r[0]===0)n=r.slice(1);else{if(r[0]===1)throw new Error("Brotli Compression not supported. Please use gzip or none compression in withCompression method on DbConnection.");if(r[0]===2)n=await yi(r.slice(1),"gzip");else throw new Error("Unexpected Compression Algorithm. Please use `gzip` or `none`")}this.onmessage?.({data:n})},Tt=new WeakSet,Ti=function(t){this.onopen?.(t)},qe=new WeakSet,yr=function(t){this.onerror?.(t)},He),ze,ve,bt,$e,me,Ke,Je,Ce,Kr,Bn=(Kr=class{constructor(e,t){w(this,ze,void 0);w(this,ve,void 0);w(this,bt,void 0);w(this,$e,void 0);w(this,me,new Ft);w(this,Ke,"gzip");w(this,Je,!1);w(this,Ce,void 0);this.remoteModule=e,this.dbConnectionConstructor=t,y(this,Ce,kn.createWebSocketFn)}withUri(e){return y(this,ze,new URL(e)),this}withModuleName(e){return y(this,ve,e),this}withToken(e){return y(this,$e,e),this}withWSFn(e){return y(this,Ce,e),this}withCompression(e){return y(this,Ke,e),this}withLightMode(e){return y(this,Je,e),this}onConnect(e){return a(this,me).on("connect",e),this}onConnectError(e){return a(this,me).on("connectError",e),this}onDisconnect(e){return a(this,me).on("disconnect",e),this}build(){if(!a(this,ze))throw new Error("URI is required to connect to SpacetimeDB");if(!a(this,ve))throw new Error("Database name or address is required to connect to SpacetimeDB");return En(this.remoteModule.versionInfo?.cliVersion),this.dbConnectionConstructor(new mi({uri:a(this,ze),nameOrAddress:a(this,ve),identity:a(this,bt),token:a(this,$e),emitter:a(this,me),compression:a(this,Ke),lightMode:a(this,Je),createWSFn:a(this,Ce),remoteModule:this.remoteModule}))}},ze=new WeakMap,ve=new WeakMap,bt=new WeakMap,$e=new WeakMap,me=new WeakMap,Ke=new WeakMap,Je=new WeakMap,Ce=new WeakMap,Kr),We,Ve,Jr,bi=(Jr=class{constructor(e){w(this,We,void 0);w(this,Ve,void 0);this.db=e}onApplied(e){return y(this,We,e),this}onError(e){return y(this,Ve,e),this}subscribe(e){const t=Array.isArray(e)?e:[e];if(t.length===0)throw new Error("Subscriptions must have at least one query");return new Dn(this.db,t,a(this,We),a(this,Ve))}subscribeToAllTables(){this.subscribe("SELECT * FROM *")}},We=new WeakMap,Ve=new WeakMap,Jr),On=class{constructor(){h(this,"subscriptions",new Map)}},Ee,we,ce,le,ue,Wr,Dn=(Wr=class{constructor(e,t,r,n){w(this,Ee,void 0);w(this,we,!1);w(this,ce,!1);w(this,le,!1);w(this,ue,new Ft);this.db=e,a(this,ue).on("applied",i=>{y(this,le,!0),r&&r(i)}),a(this,ue).on("error",(i,s)=>{y(this,le,!1),y(this,ce,!0),n&&n(i,s)}),y(this,Ee,this.db.registerSubscription(this,a(this,ue),t))}unsubscribe(){if(a(this,we))throw new Error("Unsubscribe has already been called");y(this,we,!0),this.db.unregisterSubscription(a(this,Ee)),a(this,ue).on("end",e=>{y(this,ce,!0),y(this,le,!1)})}unsubscribeThen(e){if(a(this,ce))throw new Error("Subscription has already ended");if(a(this,we))throw new Error("Unsubscribe has already been called");y(this,we,!0),this.db.unregisterSubscription(a(this,Ee)),a(this,ue).on("end",t=>{y(this,ce,!0),y(this,le,!1),e(t)})}isEnded(){return a(this,ce)}isActive(){return a(this,le)}},Ee=new WeakMap,we=new WeakMap,ce=new WeakMap,le=new WeakMap,ue=new WeakMap,Wr);function jn(e){switch(e){case"FullUpdate":return 0;case"NoSuccessNotify":return 1}}var Ge,K,ke,mt,$,Ze,ee,wt,_t,wi,Be,it,xt,_i,ne,ye,St,xi,At,Si,mr,Pn,wr,Mn,_r,Rn,xr,Ln,Sr,Nn,Ar,qn,Ir,Hn,Fr,$n,Vr,mi=(Vr=class{constructor({uri:e,nameOrAddress:t,identity:r,token:n,emitter:i,remoteModule:s,createWSFn:o,compression:l,lightMode:m}){w(this,_t);w(this,Be);w(this,xt);w(this,ne);w(this,St);w(this,At);w(this,mr);w(this,wr);w(this,_r);w(this,xr);w(this,Sr);w(this,Ar);w(this,Ir);w(this,Fr);h(this,"isActive",!1);h(this,"identity");h(this,"token");h(this,"db");h(this,"reducers");h(this,"setReducerFlags");h(this,"connectionId",Rt.random());w(this,Ge,0);w(this,K,void 0);w(this,ke,new Ft);w(this,mt,void 0);w(this,$,void 0);w(this,Ze,Promise.resolve());w(this,ee,new On);h(this,"clientCache");h(this,"ws");h(this,"wsPromise");w(this,wt,()=>{const e=a(this,Ge);return y(this,Ge,a(this,Ge)+1),e});h(this,"subscriptionBuilder",()=>new bi(this));he("info","Connecting to SpacetimeDB WS...");let S=new URL(e.toString());/^wss?:/.test(e.protocol)||(S.protocol=S.protocol==="https:"?"wss:":"ws:"),this.identity=r,this.token=n,y(this,$,s),y(this,K,i);let I=this.connectionId.toHexString();S.searchParams.set("connection_id",I),this.clientCache=new vn,this.db=a(this,$).dbViewConstructor(this),this.setReducerFlags=a(this,$).setReducerFlagsConstructor(),this.reducers=a(this,$).reducersConstructor(this,this.setReducerFlags),this.wsPromise=o({url:S,nameOrAddress:t,wsProtocol:"v1.bsatn.spacetimedb",authToken:n,compression:l,lightMode:m}).then(v=>(this.ws=v,this.ws.onclose=()=>{a(this,K).emit("disconnect",this)},this.ws.onerror=C=>{a(this,K).emit("connectError",this,C)},this.ws.onopen=g(this,xt,_i).bind(this),this.ws.onmessage=g(this,At,Si).bind(this),v)).catch(v=>{he("error","Error connecting to SpacetimeDB WS"),a(this,K).emit("connectError",this,v)})}registerSubscription(e,t,r){const n=a(this,wt).call(this);return a(this,ee).subscriptions.set(n,{handle:e,emitter:t}),g(this,Be,it).call(this,Ae.SubscribeMulti({queryStrings:r,queryId:{id:n},requestId:0})),n}unregisterSubscription(e){g(this,Be,it).call(this,Ae.UnsubscribeMulti({queryId:{id:e},requestId:0}))}callReducer(e,t,r){const n=Ae.CallReducer({reducer:e,args:t,requestId:0,flags:jn(r)});g(this,Be,it).call(this,n)}disconnect(){this.wsPromise.then(e=>{e&&e.close()})}onReducer(e,t){a(this,ke).on(e,t)}offReducer(e,t){a(this,ke).off(e,t)}},Ge=new WeakMap,K=new WeakMap,ke=new WeakMap,mt=new WeakMap,$=new WeakMap,Ze=new WeakMap,ee=new WeakMap,wt=new WeakMap,_t=new WeakSet,wi=async function(e){const t=(i,s,o)=>{const l=o.rowsData,m=new Ie(l),S=[],I=a(this,$).tables[s].rowType,v=a(this,$).tables[s].primaryKeyInfo;for(;m.offset<l.length+l.byteOffset;){const C=m.offset,p=I.deserialize(m);let f;if(v!==void 0)f=v.colType.intoMapKey(p[v.colName]);else{const b=l.subarray(C-l.byteOffset,m.offset-l.byteOffset);f=ai(b)}S.push({type:i,rowId:f,row:p})}return S},r=async i=>{const s=i.tableName;let o=[];for(const l of i.updates){let m;if(l.tag==="Gzip"){const S=await yi(l.value,"gzip");m=at.deserialize(new Ie(S))}else{if(l.tag==="Brotli")throw new Error("Brotli compression not supported. Please use gzip or none compression in withCompression method on DbConnection.");m=l.value}o=o.concat(t("insert",s,m.inserts)),o=o.concat(t("delete",s,m.deletes))}return{tableName:s,operations:o}},n=async i=>{const s=[];for(const o of i.tables)s.push(await r(o));return s};switch(e.tag){case"InitialSubscription":{const i=e.value.databaseUpdate;return{tag:"InitialSubscription",tableUpdates:await n(i)}}case"TransactionUpdateLight":{const i=e.value.update;return{tag:"TransactionUpdateLight",tableUpdates:await n(i)}}case"TransactionUpdate":{const i=e.value,s=i.callerIdentity,o=Rt.nullIfZero(i.callerConnectionId),l=i.reducerCall.reducerName,m=i.reducerCall.args,S=i.energyQuantaUsed;let I,v="";switch(i.status.tag){case"Committed":I=await n(i.status.value);break;case"Failed":I=[],v=i.status.value;break;case"OutOfEnergy":I=[];break}if(l==="<none>"){console.error(`Received an error from the database: ${v}`);return}let C;return l!==""&&(C={reducerName:l,args:m}),{tag:"TransactionUpdate",tableUpdates:I,identity:s,connectionId:o,reducerInfo:C,status:i.status,energyConsumed:S.quanta,message:v,timestamp:i.timestamp}}case"IdentityToken":return{tag:"IdentityToken",identity:e.value.identity,token:e.value.token,connectionId:e.value.connectionId};case"OneOffQueryResponse":throw new Error(`TypeScript SDK never sends one-off queries, but got OneOffQueryResponse ${e}`);case"SubscribeMultiApplied":{const i=await n(e.value.update);return{tag:"SubscribeApplied",queryId:e.value.queryId.id,tableUpdates:i}}case"UnsubscribeMultiApplied":{const i=await n(e.value.update);return{tag:"UnsubscribeApplied",queryId:e.value.queryId.id,tableUpdates:i}}case"SubscriptionError":return{tag:"SubscriptionError",queryId:e.value.queryId,error:e.value.error}}},Be=new WeakSet,it=function(e){this.wsPromise.then(t=>{if(t){const r=new de(1024);Ae.serialize(r,e);const n=r.getBuffer();t.send(n)}})},xt=new WeakSet,_i=function(){this.isActive=!0},ne=new WeakSet,ye=function(e,t){let r=[];for(let n of e){const i=n.tableName,s=a(this,$).tables[i],l=this.clientCache.getOrCreateTable(s).applyOperations(n.operations,t);for(const m of l)r.push(m)}return r},St=new WeakSet,xi=async function(e){var n;const t=An(dr,e),r=await g(this,_t,wi).call(this,t);if(!!r)switch(r.tag){case"InitialSubscription":{let i={tag:"SubscribeApplied"};const s=a(this,$).eventContextConstructor(this,i),{event:o,...l}=s,m=g(this,ne,ye).call(this,r.tableUpdates,s);a(this,K)&&((n=a(this,mt))==null||n.call(this,l));for(const S of m)S.cb();break}case"TransactionUpdateLight":{let i={tag:"UnknownTransaction"};const s=a(this,$).eventContextConstructor(this,i),o=g(this,ne,ye).call(this,r.tableUpdates,s);for(const l of o)l.cb();break}case"TransactionUpdate":{let i=r.reducerInfo,s=!1,o,l;if(!i)s=!0;else{l=a(this,$).reducers[i.reducerName];try{const f=new Ie(i.args);o=l.argsType.deserialize(f)}catch{console.debug("Failed to deserialize reducer arguments"),s=!0}}if(s){const f={tag:"UnknownTransaction"},b=a(this,$).eventContextConstructor(this,f),T=g(this,ne,ye).call(this,r.tableUpdates,b);for(const F of T)F.cb();return}i=i,l=l;const m={callerIdentity:r.identity,status:r.status,callerConnectionId:r.connectionId,timestamp:r.timestamp,energyConsumed:r.energyConsumed,reducer:{name:i.reducerName,args:o}},S={tag:"Reducer",value:m},I=a(this,$).eventContextConstructor(this,S),v={...I,event:m},C=g(this,ne,ye).call(this,r.tableUpdates,I),p=[];l.argsType.product.elements.forEach((f,b)=>{p.push(o[f.name])}),a(this,ke).emit(i.reducerName,v,...p);for(const f of C)f.cb();break}case"IdentityToken":{this.identity=r.identity,!this.token&&r.token&&(this.token=r.token),this.connectionId=r.connectionId,a(this,K).emit("connect",this,this.identity,this.token);break}case"SubscribeApplied":{const i=a(this,ee).subscriptions.get(r.queryId);if(i===void 0){he("error",`Received SubscribeApplied for unknown queryId ${r.queryId}.`);break}const s={tag:"SubscribeApplied"},o=a(this,$).eventContextConstructor(this,s),{event:l,...m}=o,S=g(this,ne,ye).call(this,r.tableUpdates,o);i?.emitter.emit("applied",m);for(const I of S)I.cb();break}case"UnsubscribeApplied":{const i=a(this,ee).subscriptions.get(r.queryId);if(i===void 0){he("error",`Received UnsubscribeApplied for unknown queryId ${r.queryId}.`);break}const s={tag:"UnsubscribeApplied"},o=a(this,$).eventContextConstructor(this,s),{event:l,...m}=o,S=g(this,ne,ye).call(this,r.tableUpdates,o);i?.emitter.emit("end",m),a(this,ee).subscriptions.delete(r.queryId);for(const I of S)I.cb();break}case"SubscriptionError":{const i=Error(r.error),s={tag:"Error",value:i},l={...a(this,$).eventContextConstructor(this,s),event:i};r.queryId!==void 0?(a(this,ee).subscriptions.get(r.queryId)?.emitter.emit("error",l,i),a(this,ee).subscriptions.delete(r.queryId)):(console.error("Received an error message without a queryId: ",i),a(this,ee).subscriptions.forEach(({emitter:m})=>{m.emit("error",l,i)}))}}},At=new WeakSet,Si=function(e){y(this,Ze,a(this,Ze).then(()=>g(this,St,xi).call(this,e.data)))},mr=new WeakSet,Pn=function(e,t){a(this,K).on(e,t)},wr=new WeakSet,Mn=function(e,t){a(this,K).off(e,t)},_r=new WeakSet,Rn=function(e){a(this,K).on("connect",e)},xr=new WeakSet,Ln=function(e){a(this,K).on("disconnect",e)},Sr=new WeakSet,Nn=function(e){a(this,K).on("connectError",e)},Ar=new WeakSet,qn=function(e){a(this,K).off("connect",e)},Ir=new WeakSet,Hn=function(e){a(this,K).off("disconnect",e)},Fr=new WeakSet,$n=function(e){a(this,K).off("connectError",e)},Vr),lt;(e=>{function t(){return c.createProductType([new u("other",c.createIdentityType()),new u("app",c.createU256Type()),new u("lam",c.createU256Type()),new u("arg",c.createStringType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(lt||(lt={}));var gr;(e=>{function t(){return c.createProductType([new u("setup",c.createStringType()),new u("functions",c.createArrayType(c.createStringType()))])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(gr||(gr={}));var ut;(e=>{function t(){return c.createProductType([new u("app",gr.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(ut||(ut={}));var pt;(e=>{function t(){return c.createProductType([new u("app",c.createU256Type()),new u("value",c.createBoolType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(pt||(pt={}));class Kn{constructor(t){h(this,"tableCache");h(this,"id",{find:t=>{for(let r of this.tableCache.iter())if(It(r.id,t))return r}});h(this,"onInsert",t=>this.tableCache.onInsert(t));h(this,"removeOnInsert",t=>this.tableCache.removeOnInsert(t));h(this,"onDelete",t=>this.tableCache.onDelete(t));h(this,"removeOnDelete",t=>this.tableCache.removeOnDelete(t));h(this,"onUpdate",t=>this.tableCache.onUpdate(t));h(this,"removeOnUpdate",t=>this.tableCache.removeOnUpdate(t));this.tableCache=t}count(){return this.tableCache.count()}iter(){return this.tableCache.iter()}}class Jn{constructor(t){h(this,"tableCache");h(this,"onInsert",t=>this.tableCache.onInsert(t));h(this,"removeOnInsert",t=>this.tableCache.removeOnInsert(t));h(this,"onDelete",t=>this.tableCache.onDelete(t));h(this,"removeOnDelete",t=>this.tableCache.removeOnDelete(t));this.tableCache=t}count(){return this.tableCache.count()}iter(){return this.tableCache.iter()}}class Wn{constructor(t){h(this,"tableCache");h(this,"id",{find:t=>{for(let r of this.tableCache.iter())if(It(r.id,t))return r}});h(this,"onInsert",t=>this.tableCache.onInsert(t));h(this,"removeOnInsert",t=>this.tableCache.removeOnInsert(t));h(this,"onDelete",t=>this.tableCache.onDelete(t));h(this,"removeOnDelete",t=>this.tableCache.removeOnDelete(t));h(this,"onUpdate",t=>this.tableCache.onUpdate(t));h(this,"removeOnUpdate",t=>this.tableCache.removeOnUpdate(t));this.tableCache=t}count(){return this.tableCache.count()}iter(){return this.tableCache.iter()}}class Vn{constructor(t){h(this,"tableCache");h(this,"key",{find:t=>{for(let r of this.tableCache.iter())if(It(r.key,t))return r}});h(this,"onInsert",t=>this.tableCache.onInsert(t));h(this,"removeOnInsert",t=>this.tableCache.removeOnInsert(t));h(this,"onDelete",t=>this.tableCache.onDelete(t));h(this,"removeOnDelete",t=>this.tableCache.removeOnDelete(t));h(this,"onUpdate",t=>this.tableCache.onUpdate(t));h(this,"removeOnUpdate",t=>this.tableCache.removeOnUpdate(t));this.tableCache=t}count(){return this.tableCache.count()}iter(){return this.tableCache.iter()}}var ht;(e=>{function t(){return c.createProductType([new u("id",c.createU256Type()),new u("setup",c.createStringType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(ht||(ht={}));var Tr;(e=>{function t(){return c.createProductType([new u("host",c.createIdentityType()),new u("app",c.createU256Type())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(Tr||(Tr={}));var dt;(e=>{function t(){return c.createProductType([new u("id",c.createU256Type()),new u("code",c.createStringType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(dt||(dt={}));var ft;(e=>{function t(){return c.createProductType([new u("key",c.createU256Type()),new u("owner",c.createIdentityType()),new u("content",c.createStringType())])}e.getTypeScriptAlgebraicType=t;function r(i,s){e.getTypeScriptAlgebraicType().serialize(i,s)}e.serialize=r;function n(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=n})(ft||(ft={}));const je={tables:{app:{tableName:"app",rowType:ht.getTypeScriptAlgebraicType(),primaryKey:"id",primaryKeyInfo:{colName:"id",colType:ht.getTypeScriptAlgebraicType().product.elements[0].algebraicType}},host:{tableName:"host",rowType:Tr.getTypeScriptAlgebraicType()},lambda:{tableName:"lambda",rowType:dt.getTypeScriptAlgebraicType(),primaryKey:"id",primaryKeyInfo:{colName:"id",colType:dt.getTypeScriptAlgebraicType().product.elements[0].algebraicType}},store:{tableName:"store",rowType:ft.getTypeScriptAlgebraicType(),primaryKey:"key",primaryKeyInfo:{colName:"key",colType:ft.getTypeScriptAlgebraicType().product.elements[0].algebraicType}}},reducers:{call_lambda:{reducerName:"call_lambda",argsType:lt.getTypeScriptAlgebraicType()},publish:{reducerName:"publish",argsType:ut.getTypeScriptAlgebraicType()},sethost:{reducerName:"sethost",argsType:pt.getTypeScriptAlgebraicType()}},versionInfo:{cliVersion:"1.2.0"},eventContextConstructor:(e,t)=>({...e,event:t}),dbViewConstructor:e=>new Xn(e),reducersConstructor:(e,t)=>new Gn(e,t),setReducerFlagsConstructor:()=>new Zn};class Gn{constructor(t,r){this.connection=t,this.setCallReducerFlags=r}callLambda(t,r,n,i){const s={other:t,app:r,lam:n,arg:i};let o=new de(1024);lt.getTypeScriptAlgebraicType().serialize(o,s);let l=o.getBuffer();this.connection.callReducer("call_lambda",l,this.setCallReducerFlags.callLambdaFlags)}onCallLambda(t){this.connection.onReducer("call_lambda",t)}removeOnCallLambda(t){this.connection.offReducer("call_lambda",t)}publish(t){const r={app:t};let n=new de(1024);ut.getTypeScriptAlgebraicType().serialize(n,r);let i=n.getBuffer();this.connection.callReducer("publish",i,this.setCallReducerFlags.publishFlags)}onPublish(t){this.connection.onReducer("publish",t)}removeOnPublish(t){this.connection.offReducer("publish",t)}sethost(t,r){const n={app:t,value:r};let i=new de(1024);pt.getTypeScriptAlgebraicType().serialize(i,n);let s=i.getBuffer();this.connection.callReducer("sethost",s,this.setCallReducerFlags.sethostFlags)}onSethost(t){this.connection.onReducer("sethost",t)}removeOnSethost(t){this.connection.offReducer("sethost",t)}}class Zn{constructor(){h(this,"callLambdaFlags","FullUpdate");h(this,"publishFlags","FullUpdate");h(this,"sethostFlags","FullUpdate")}callLambda(t){this.callLambdaFlags=t}publish(t){this.publishFlags=t}sethost(t){this.sethostFlags=t}}class Xn{constructor(t){this.connection=t}get app(){return new Kn(this.connection.clientCache.getOrCreateTable(je.tables.app))}get host(){return new Jn(this.connection.clientCache.getOrCreateTable(je.tables.host))}get lambda(){return new Wn(this.connection.clientCache.getOrCreateTable(je.tables.lambda))}get store(){return new Vn(this.connection.clientCache.getOrCreateTable(je.tables.store))}}class Yn extends bi{}class Ai extends mi{constructor(){super(...arguments);h(this,"subscriptionBuilder",()=>new Yn(this))}}h(Ai,"builder",()=>new Bn(je,r=>r));const Ut=new TextEncoder;function zt(e){let t=0n;for(let r=0;r<e.length;r++)t=(t<<8n)+BigInt(e[r]);return t}function Te(e){const t=new Uint8Array(32);let r=e;for(let n=31;n>=0;n--)t[n]=Number(r&0xffn),r>>=8n;return t}function Ur(e){const t=e.reduce((i,s)=>i+s.length,0),r=new Uint8Array(t);let n=0;for(const i of e)r.set(i,n),n+=i.length;return r}async function br(e){const t=Ut.encode(e),r=new Uint8Array(await crypto.subtle.digest("SHA-256",t));return zt(r)}async function Rr(e,t,r,n,i){const s=Te(e.data),o=Te(t.data),l=Te(r),m=Te(n),S=Ut.encode(i),I=Ur([s,o,l,m,S]),v=new Uint8Array(await crypto.subtle.digest("SHA-256",I));return zt(v)}async function Qn(e,t,r){const n=Te(e.data),i=Te(t),s=Ut.encode(r),o=Ur([n,i,s]),l=new Uint8Array(await crypto.subtle.digest("SHA-256",o));return zt(l)}async function es(e){const t=await Promise.all(e.functions.map(br)),r=Ut.encode(e.setup),n=t.map(Te),i=Ur([r,...n]),s=new Uint8Array(await crypto.subtle.digest("SHA-256",i));return{hash:zt(s),lambdas:t}}const Lr=e=>"id"+e.toHexString(),Nr=e=>new pi(e.slice(2));function ts(e,t,r){return new Promise((n,i)=>{let s=new Map;Ai.builder().withUri(e).withModuleName(t).withToken(r.get()).onConnect(async(o,l,m)=>{r.set(m);const S=new Map,I=new pe({});o.subscriptionBuilder().onApplied(p=>{console.log("APPLIED"),p.db.store.onInsert((f,b)=>{b.owner.data==l.data&&(S.set(b.key,b.content),s.get(b.key)?.forEach(T=>T(JSON.parse(b.content))))}),p.db.host.onInsert((f,b)=>{b.host.data==l.data&&I.update(T=>(T[b.app.toString()]=!0,T),!0)}),p.db.store.onUpdate((f,b,T)=>{console.log("UPDATE",b,T),T.owner.data==l.data&&(S.set(T.key,T.content),s.get(T.key)?.forEach(F=>F(JSON.parse(T.content))))}),p.reducers.onCallLambda(async(f,b,T,F,O)=>{const N=await Rr(l,b,T,F,O);if(f.event.status.tag=="Failed")C.get(N)?.reject(f.event.status.value);else try{let P=S.get(N);P=="undefined"?C.get(N)?.resolve(void 0):C.get(N)?.resolve(JSON.parse(P))}catch{C.get(N)?.resolve(null)}C.delete(N)})}).onError(console.error).subscribe([`SELECT * FROM store WHERE owner = '${l.toHexString()}'`,"SELECT * FROM app","SELECT * FROM lambda",`SELECT * FROM host WHERE host = '${l.toHexString()}'`]);const v=async p=>{let f=await es({setup:p.loadApp.toString(),functions:Object.values(p.api).map(O=>O.toString())});o.reducers.publish({setup:p.loadApp.toString(),functions:Object.values(p.api).map(O=>O.toString())});let F={call:async(O,N,P=null)=>new Promise(async(q,se)=>{const zr=JSON.stringify(P),vr=N.toString(),Fi=await Rr(l,Nr(O),f.hash,await br(vr),zr),Ui=await br(vr);C.set(Fi,{resolve:q,reject:se}),o.reducers.callLambda(Nr(O),f.hash,Ui,zr)}),users:()=>new Promise(async(O,N)=>{let P=o.subscriptionBuilder().onApplied(q=>{P.unsubscribe(),O(Array.from(q.db.host.iter()).filter(se=>se.app==f.hash).map(se=>Lr(se.host)))}).onError(N).subscribe([`SELECT * FROM host WHERE app = '${f.hash}'`])}),subscribe:async(O,N)=>{const P=await Qn(l,f.hash,O);s.has(P)||s.set(P,[]),s.get(P)?.push(N)}};return new Promise((O,N)=>{let P=f.hash.toString();I.subscribe(q=>{q[P]&&O(F)}),o.reducers.sethost(f.hash,!0)})},C=new Map;n({identity:Lr(l),handle:v})}).build()})}const yt="rubox_app";document.title=yt;function Ii(){const e=window.location.pathname.split("/").filter(Boolean),t=e.includes("local"),r=!e.includes(yt);return{serverLocal:t,frontendLocal:r,path:e.filter(n=>n!="local"&&n!=yt)}}let ae=Ii();console.log(ae);const rs=ae.serverLocal?"ws://localhost:3000":"wss://maincloud.spacetimedb.com",Pe=document.body;Pe.appendChild(nt("loading..."));ts(rs,"rubox",new Gr("rubox-token-"+ae.serverLocal,"")).then(e=>{const r=[{init:()=>X(nt("home"),ge("welcome to the rubox"),...r.filter(i=>i.path).map(i=>ge(et(i.path,{onclick:()=>{n(i.path.split("/"))}})))),path:"",cache:void 0},{init:i=>Ei(i),path:"chat",cache:void 0},{init:i=>Oi(i),path:"chess",cache:void 0}];n(ae.path),window.addEventListener("popstate",i=>{ae=Ii(),n(ae.path)});function n(i){let s="/"+(ae.frontendLocal?"":yt)+"/"+i.join("/")+(ae.serverLocal?"/local":"");s=window.location.origin+"/"+s.split("/").filter(Boolean).join("/"),window.history.pushState({},"",s),Pe.innerHTML="",Pe.style.fontFamily="monospace",Pe.style.textAlign="center";for(const o of r)o.path===i.join("/")&&(o.cache||(o.cache=o.init(e)),Pe.appendChild(o.cache))}});
