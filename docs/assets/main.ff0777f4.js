var xi=Object.defineProperty;var Si=(e,t,r)=>t in e?xi(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var p=(e,t,r)=>(Si(e,typeof t!="symbol"?t+"":t,r),r),It=(e,t,r)=>{if(!t.has(e))throw TypeError("Cannot "+r)};var a=(e,t,r)=>(It(e,t,"read from private field"),r?r.call(e):t.get(e)),y=(e,t,r)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,r)},d=(e,t,r,s)=>(It(e,t,"write to private field"),s?s.call(e,r):t.set(e,r),r);var f=(e,t,r)=>(It(e,t,"access private method"),r);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const c of n.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function r(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerpolicy&&(n.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?n.credentials="include":i.crossorigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=r(i);fetch(i.href,n)}})();class he{constructor(t){p(this,"value");p(this,"listeners",[]);this.value=t}get(){return this.value}set(t,r=!1){if(!(!r&&t===this.value)){this.value=t;for(const s of this.listeners)s(t)}}update(t,r=!1){const s=t(this.value);this.set(s,r)}subscribe(t){this.listeners.push(t),t(this.value)}subscribeLater(t){this.listeners.push(t)}}class Hr extends he{constructor(r,s){localStorage.getItem(r)!==null&&(s=JSON.parse(localStorage.getItem(r)));super(s);p(this,"key");this.key=r}set(r,s=!1){(s||JSON.stringify(this.get())!==JSON.stringify(r))&&(super.set(r),localStorage.setItem(this.key,JSON.stringify(r)))}}const Ft=(e,t,r="",s)=>{const i=document.createElement(e);return i.innerText=t,r&&i.classList.add(...r.split(".").filter(n=>n)),s&&Object.entries(s).forEach(([n,c])=>{n==="parent"&&c.appendChild(i),n==="children"?c.forEach(l=>i.appendChild(l)):n==="eventListeners"?Object.entries(c).forEach(([l,g])=>{i.addEventListener(l,g)}):n==="color"||n==="background"?i.style[n]=c:n==="style"?Object.entries(c).forEach(([l,g])=>{i.style.setProperty(l,g)}):i[n]=c}),i},Jr=(e,...t)=>{let r=[],s={};const i=n=>{if(typeof n=="string")r.push(Ft("span",n));else if(typeof n=="number")r.push(Ft("span",n.toString()));else if(n instanceof he){const c=Ge();n.subscribe(l=>{c.innerHTML="",c.appendChild(Ge(l))}),r.push(c)}else if(n instanceof Promise){const c=Ge();n.then(l=>{c.innerHTML="",c.appendChild(Ge(l))}),r.push(c)}else n instanceof HTMLElement?r.push(n):n instanceof Array?n.forEach(i):s={...s,...n}};for(let n of t)i(n);return Ft(e,"","",{...s,children:r})},Ve=e=>(...t)=>Jr(e,...t),ue=Ve("p"),Et=Ve("h2"),pe=Ve("div"),Ze=Ve("button"),Ge=Ve("span"),Fr=(...e)=>{const t=e.find(i=>i instanceof he),r=e.filter(i=>typeof i=="string").join(" "),s=Jr("input",...e);return t?(s.value=t.get(),t.subscribeLater(i=>{s.value!==i.toString()&&(s.value=i.toString())}),s.oninput=i=>{t.set(i.target.value)}):s.value=r,s},Ai=e=>{const t=pe({style:{position:"fixed",top:"0",left:"0",width:"100%",height:"100%",background:"rgba(166, 166, 166, 0.5)",display:"flex","justify-content":"center","align-items":"center"}});return t.appendChild(e),document.body.appendChild(t),t.onclick=()=>{t.remove()},e.style.background="var(--bg)",e.style.color="var(--color)",e.style.padding="1em",e.style.paddingBottom="2em",e.style.borderRadius="1em",e.onclick=r=>{r.stopPropagation()},t},Be={loadApp:e=>({pushMsg:t=>{let r={sender:e.self,receiver:e.other,message:t};e.DB.set(!1,"messages",[...e.DB.get(!1,"messages")??[],r]),e.DB.set(!0,"messages",[...e.DB.get(!0,"messages")??[],r])}}),api:{setname:(e,t)=>{e.DB.set(!0,"name",t)},getname:(e,t)=>e.DB.get(!1,"name"),sendMessage:(e,t)=>{e.pushMsg(t)},getMessages:(e,t)=>e.DB.get(!0,"messages")}},Ii=e=>{let t=new Map,r=ue(),s=pe();return e.handle(Be).then(async({call:i,users:n,subscribe:c})=>{async function l(A){let O=t.get(A);if(O)return O;let j=new he("");return i(A,Be.api.getname,A).then(G=>j.set(G)),t.set(A,j),j}let g=new he([]),m=new he(pe()),_=new Hr("other",e.identity);function C(){m.set(pe(g.get().filter(A=>A.receiver==_.get()&&A.sender==e.identity||A.sender==_.get()&&A.receiver==e.identity).map(A=>ue(l(A.sender)," : ",A.message)),{style:{"max-width":"20em",margin:"auto"}}))}i(e.identity,Be.api.getMessages).then(A=>g.set(A??[])),g.subscribe(A=>C()),_.subscribeLater(A=>C()),c("messages",A=>{g.set(A??[])});let I=Fr();await l(e.identity).then(A=>A.subscribe(O=>I.value=O));let F=Fr(),z=Ze("send");z.onclick=async()=>{await i(_.get(),Be.api.sendMessage,F.value),F.value=""};let R=new he("");_.subscribe(A=>{l(A).then(O=>O.subscribe(j=>R.set(j)))}),s.appendChild(pe(Et("chat"),r,ue("my name:",I,Ze("update",{onclick:()=>{i(e.identity,Be.api.setname,I.value).then(()=>{l(e.identity).then(A=>A.set(I.value))})}})),Ze("chat with: ",R,{onclick:()=>{let A=Ai(pe(Et("chat with"),n().then(O=>O.map(j=>ue(l(j),{onclick:()=>{_.set(j),A.remove()}})))))}}),m,ue("send message:",F,z)))}),s},Kr="utf-8";function x(e,t=void 0){if(e)throw TypeError("Decoder error");return t||65533}function Z(e){throw TypeError("The code point "+e+" could not be encoded.")}function Ct(e){const t=String(e).trim().toLowerCase();return t in Bt?Bt[t]:null}const Vr=[{encodings:[{labels:["unicode-1-1-utf-8","utf-8","utf8"],name:"UTF-8"}],heading:"The Encoding"},{encodings:[{labels:["866","cp866","csibm866","ibm866"],name:"IBM866"},{labels:["csisolatin2","iso-8859-2","iso-ir-101","iso8859-2","iso88592","iso_8859-2","iso_8859-2:1987","l2","latin2"],name:"ISO-8859-2"},{labels:["csisolatin3","iso-8859-3","iso-ir-109","iso8859-3","iso88593","iso_8859-3","iso_8859-3:1988","l3","latin3"],name:"ISO-8859-3"},{labels:["csisolatin4","iso-8859-4","iso-ir-110","iso8859-4","iso88594","iso_8859-4","iso_8859-4:1988","l4","latin4"],name:"ISO-8859-4"},{labels:["csisolatincyrillic","cyrillic","iso-8859-5","iso-ir-144","iso8859-5","iso88595","iso_8859-5","iso_8859-5:1988"],name:"ISO-8859-5"},{labels:["arabic","asmo-708","csiso88596e","csiso88596i","csisolatinarabic","ecma-114","iso-8859-6","iso-8859-6-e","iso-8859-6-i","iso-ir-127","iso8859-6","iso88596","iso_8859-6","iso_8859-6:1987"],name:"ISO-8859-6"},{labels:["csisolatingreek","ecma-118","elot_928","greek","greek8","iso-8859-7","iso-ir-126","iso8859-7","iso88597","iso_8859-7","iso_8859-7:1987","sun_eu_greek"],name:"ISO-8859-7"},{labels:["csiso88598e","csisolatinhebrew","hebrew","iso-8859-8","iso-8859-8-e","iso-ir-138","iso8859-8","iso88598","iso_8859-8","iso_8859-8:1988","visual"],name:"ISO-8859-8"},{labels:["csiso88598i","iso-8859-8-i","logical"],name:"ISO-8859-8-I"},{labels:["csisolatin6","iso-8859-10","iso-ir-157","iso8859-10","iso885910","l6","latin6"],name:"ISO-8859-10"},{labels:["iso-8859-13","iso8859-13","iso885913"],name:"ISO-8859-13"},{labels:["iso-8859-14","iso8859-14","iso885914"],name:"ISO-8859-14"},{labels:["csisolatin9","iso-8859-15","iso8859-15","iso885915","iso_8859-15","l9"],name:"ISO-8859-15"},{labels:["iso-8859-16"],name:"ISO-8859-16"},{labels:["cskoi8r","koi","koi8","koi8-r","koi8_r"],name:"KOI8-R"},{labels:["koi8-ru","koi8-u"],name:"KOI8-U"},{labels:["csmacintosh","mac","macintosh","x-mac-roman"],name:"macintosh"},{labels:["dos-874","iso-8859-11","iso8859-11","iso885911","tis-620","windows-874"],name:"windows-874"},{labels:["cp1250","windows-1250","x-cp1250"],name:"windows-1250"},{labels:["cp1251","windows-1251","x-cp1251"],name:"windows-1251"},{labels:["ansi_x3.4-1968","cp1252","cp819","ibm819","iso-ir-100","windows-1252","x-cp1252"],name:"windows-1252"},{labels:["ascii","us-ascii","iso-8859-1","iso8859-1","iso88591","iso_8859-1","iso_8859-1:1987","l1","latin1","csisolatin1"],name:"iso-8859-1"},{labels:["cp1253","windows-1253","x-cp1253"],name:"windows-1253"},{labels:["cp1254","csisolatin5","iso-8859-9","iso-ir-148","iso8859-9","iso88599","iso_8859-9","iso_8859-9:1989","l5","latin5","windows-1254","x-cp1254"],name:"windows-1254"},{labels:["cp1255","windows-1255","x-cp1255"],name:"windows-1255"},{labels:["cp1256","windows-1256","x-cp1256"],name:"windows-1256"},{labels:["cp1257","windows-1257","x-cp1257"],name:"windows-1257"},{labels:["cp1258","windows-1258","x-cp1258"],name:"windows-1258"},{labels:["x-mac-cyrillic","x-mac-ukrainian"],name:"x-mac-cyrillic"}],heading:"Legacy single-byte encodings"},{encodings:[{labels:["chinese","csgb2312","csiso58gb231280","gb2312","gb_2312","gb_2312-80","gbk","iso-ir-58","x-gbk"],name:"GBK"},{labels:["gb18030"],name:"gb18030"}],heading:"Legacy multi-byte Chinese (simplified) encodings"},{encodings:[{labels:["big5","big5-hkscs","cn-big5","csbig5","x-x-big5"],name:"Big5"}],heading:"Legacy multi-byte Chinese (traditional) encodings"},{encodings:[{labels:["cseucpkdfmtjapanese","euc-jp","x-euc-jp"],name:"EUC-JP"},{labels:["csiso2022jp","iso-2022-jp"],name:"ISO-2022-JP"},{labels:["csshiftjis","ms932","ms_kanji","shift-jis","shift_jis","sjis","windows-31j","x-sjis"],name:"Shift_JIS"}],heading:"Legacy multi-byte Japanese encodings"},{encodings:[{labels:["cseuckr","csksc56011987","euc-kr","iso-ir-149","korean","ks_c_5601-1987","ks_c_5601-1989","ksc5601","ksc_5601","windows-949"],name:"EUC-KR"}],heading:"Legacy multi-byte Korean encodings"},{encodings:[{labels:["csiso2022kr","hz-gb-2312","iso-2022-cn","iso-2022-cn-ext","iso-2022-kr"],name:"replacement"},{labels:["utf-16be"],name:"UTF-16BE"},{labels:["utf-16","utf-16le"],name:"UTF-16LE"},{labels:["x-user-defined"],name:"x-user-defined"}],heading:"Legacy miscellaneous encodings"}],Bt={};Vr.forEach(e=>{e.encodings.forEach(t=>{t.labels.forEach(r=>{Bt[r]=t})})});const B=-1;function Gr(e){return Array.isArray(e)?e:[e]}function w(e,t,r){return t<=e&&e<=r}function Fi(e,t){return e.indexOf(t)!==-1}function et(e){if(e==null)return{};if(e===Object(e))return e;throw TypeError("Could not convert argument to dictionary")}function Ui(e){const t=String(e),r=t.length;let s=0;const i=[];for(;s<r;){const n=t.charCodeAt(s);if(n<55296||n>57343)i.push(n);else if(56320<=n&&n<=57343)i.push(65533);else if(55296<=n&&n<=56319)if(s===r-1)i.push(65533);else{const c=t.charCodeAt(s+1);if(56320<=c&&c<=57343){const l=n&1023,g=c&1023;i.push(65536+(l<<10)+g),s+=1}else i.push(65533)}s+=1}return i}function zi(e){let t="";for(let r=0;r<e.length;++r){let s=e[r];s<=65535?t+=String.fromCharCode(s):(s-=65536,t+=String.fromCharCode((s>>10)+55296,(s&1023)+56320))}return t}function Wr(){if(typeof global<"u")return global;if(typeof window<"u")return window;if(typeof self<"u")return self}let Ut;function vi(){if(typeof TextEncodingIndexes<"u")return TextEncodingIndexes.encodingIndexes;const e=Wr();return e?"TextEncodingIndexes"in e?global.TextEncodingIndexes.encodingIndexes:"encoding-indexes"in e?global.encodingIndexes:null:null}function Zr(){if(Ut)return Ut;const e=vi();return e?(Ut=e,e):null}function ve(e,t){return t&&t[e]||null}function Ee(e,t){const r=t.indexOf(e);return r===-1?null:r}function H(e){const t=Zr();if(!t)throw Error("Indexes missing. Did you forget to include encoding-indexes.js first?");return t[e]}function Ei(e){if(e>39419&&e<189e3||e>1237575)return null;if(e===7457)return 59335;let t=0,r=0;const s=H("gb18030-ranges");for(let i=0;i<s.length;++i){const n=Gr(s[i]);if(n[0]<=e)t=n[0],r=n[1];else break}return r+e-t}function Ci(e){if(e===59335)return 7457;let t=0,r=0;const s=H("gb18030-ranges");for(let i=0;i<s.length;++i){const n=s[i],c=Gr(n);if(c[1]<=e)t=c[1],r=c[0];else break}return r+e-t}function Bi(e){return zt=zt||H("jis0208").map(function(r,s){return w(s,8272,8835)?null:r}),zt.indexOf(e)}let zt;function ki(e){vt=vt||H("big5").map((r,s)=>s<(161-129)*157?null:r);const t=vt;return e===9552||e===9566||e===9569||e===9578||e===21313||e===21317?t.lastIndexOf(e):Ee(e,t)}let vt;function V(e){return 0<=e&&e<=127}const K=V,S=-1;class Oi{constructor(t){this.fatal=t.fatal,this.Big5_lead=0}handler(t,r){if(r===S&&this.Big5_lead!==0)return this.Big5_lead=0,x(this.fatal);if(r===S&&this.Big5_lead===0)return B;if(this.Big5_lead!==0){const s=this.Big5_lead;let i=null;this.Big5_lead=0;const n=r<127?64:98;switch((w(r,64,126)||w(r,161,254))&&(i=(s-129)*157+(r-n)),i){case 1133:return[202,772];case 1135:return[202,780];case 1164:return[234,772];case 1166:return[234,780]}const c=i===null?null:ve(i,H("big5"));return c===null&&V(r)&&t.prepend(r),c===null?x(this.fatal):c}return V(r)?r:w(r,129,254)?(this.Big5_lead=r,null):x(this.fatal)}}class Di{constructor(t){this.fatal=t.fatal}handler(t,r){if(r===S)return B;if(K(r))return r;const s=ki(r);if(s===null)return Z(r);const i=Math.floor(s/157)+129;if(i<161)return Z(r);const n=s%157,c=n<63?64:98;return[i,n+c]}}class ji{constructor(t){this.fatal=t.fatal,this.eucjp_jis0212_flag=!1,this.eucjp_lead=0}handler(t,r){if(r===S&&this.eucjp_lead!==0)return this.eucjp_lead=0,x(this.fatal);if(r===S&&this.eucjp_lead===0)return B;if(this.eucjp_lead===142&&w(r,161,223))return this.eucjp_lead=0,65377-161+r;if(this.eucjp_lead===143&&w(r,161,254))return this.eucjp_jis0212_flag=!0,this.eucjp_lead=r,null;if(this.eucjp_lead!==0){const s=this.eucjp_lead;this.eucjp_lead=0;let i=null;return w(s,161,254)&&w(r,161,254)&&(i=ve((s-161)*94+(r-161),H(this.eucjp_jis0212_flag?"jis0212":"jis0208"))),this.eucjp_jis0212_flag=!1,w(r,161,254)||t.prepend(r),i===null?x(this.fatal):i}return V(r)?r:r===142||r===143||w(r,161,254)?(this.eucjp_lead=r,null):x(this.fatal)}}class Pi{constructor(t){this.fatal=t.fatal}handler(t,r){if(r===S)return B;if(K(r))return r;if(r===165)return 92;if(r===8254)return 126;if(w(r,65377,65439))return[142,r-65377+161];r===8722&&(r=65293);const s=Ee(r,H("jis0208"));if(s===null)return Z(r);const i=Math.floor(s/94)+161,n=s%94+161;return[i,n]}}class Mi{constructor(t){this.fatal=t.fatal,this.euckr_lead=0}handler(t,r){if(r===S&&this.euckr_lead!==0)return this.euckr_lead=0,x(this.fatal);if(r===S&&this.euckr_lead===0)return B;if(this.euckr_lead!==0){const s=this.euckr_lead;let i=null;this.euckr_lead=0,w(r,65,254)&&(i=(s-129)*190+(r-65));const n=i===null?null:ve(i,H("euc-kr"));return i===null&&V(r)&&t.prepend(r),n===null?x(this.fatal):n}return V(r)?r:w(r,129,254)?(this.euckr_lead=r,null):x(this.fatal)}}class Ri{constructor(t){this.fatal=t.fatal}handler(t,r){if(r===S)return B;if(K(r))return r;const s=Ee(r,H("euc-kr"));if(s===null)return Z(r);const i=Math.floor(s/190)+129,n=s%190+65;return[i,n]}}class Ur{constructor(t){this.fatal=t.fatal,this.gb18030_first=0,this.gb18030_second=0,this.gb18030_third=0}handler(t,r){if(r===S&&this.gb18030_first===0&&this.gb18030_second===0&&this.gb18030_third===0)return B;r===S&&(this.gb18030_first!==0||this.gb18030_second!==0||this.gb18030_third!==0)&&(this.gb18030_first=0,this.gb18030_second=0,this.gb18030_third=0,x(this.fatal));let s;if(this.gb18030_third!==0){s=null,w(r,48,57)&&(s=Ei((((this.gb18030_first-129)*10+this.gb18030_second-48)*126+this.gb18030_third-129)*10+r-48));const i=[this.gb18030_second,this.gb18030_third,r];return this.gb18030_first=0,this.gb18030_second=0,this.gb18030_third=0,s===null?(t.prepend(i),x(this.fatal)):s}if(this.gb18030_second!==0)return w(r,129,254)?(this.gb18030_third=r,null):(t.prepend([this.gb18030_second,r]),this.gb18030_first=0,this.gb18030_second=0,x(this.fatal));if(this.gb18030_first!==0){if(w(r,48,57))return this.gb18030_second=r,null;const i=this.gb18030_first;let n=null;this.gb18030_first=0;const c=r<127?64:65;return(w(r,64,126)||w(r,128,254))&&(n=(i-129)*190+(r-c)),s=n===null?null:ve(n,H("gb18030")),s===null&&V(r)&&t.prepend(r),s===null?x(this.fatal):s}return V(r)?r:r===128?8364:w(r,129,254)?(this.gb18030_first=r,null):x(this.fatal)}}class zr{constructor(t,r=void 0){this.gbk_flag=r,this.fatal=t.fatal}handler(t,r){if(r===S)return B;if(K(r))return r;if(r===58853)return Z(r);if(this.gbk_flag&&r===8364)return 128;let s=Ee(r,H("gb18030"));if(s!==null){const g=Math.floor(s/190)+129,m=s%190,_=m<63?64:65;return[g,m+_]}if(this.gbk_flag)return Z(r);s=Ci(r);const i=Math.floor(s/10/126/10);s=s-i*10*126*10;const n=Math.floor(s/10/126);s=s-n*10*126;const c=Math.floor(s/10),l=s-c*10;return[i+129,n+48,c+129,l+48]}}var k;(function(e){e[e.ASCII=0]="ASCII",e[e.Roman=1]="Roman",e[e.Katakana=2]="Katakana",e[e.LeadByte=3]="LeadByte",e[e.TrailByte=4]="TrailByte",e[e.EscapeStart=5]="EscapeStart",e[e.Escape=6]="Escape"})(k||(k={}));class Li{constructor(t){this.fatal=t.fatal,this.iso2022jp_decoder_state=k.ASCII,this.iso2022jp_decoder_output_state=k.ASCII,this.iso2022jp_lead=0,this.iso2022jp_output_flag=!1}handler(t,r){switch(this.iso2022jp_decoder_state){default:case k.ASCII:return r===27?(this.iso2022jp_decoder_state=k.EscapeStart,null):w(r,0,127)&&r!==14&&r!==15&&r!==27?(this.iso2022jp_output_flag=!1,r):r===S?B:(this.iso2022jp_output_flag=!1,x(this.fatal));case k.Roman:return r===27?(this.iso2022jp_decoder_state=k.EscapeStart,null):r===92?(this.iso2022jp_output_flag=!1,165):r===126?(this.iso2022jp_output_flag=!1,8254):w(r,0,127)&&r!==14&&r!==15&&r!==27&&r!==92&&r!==126?(this.iso2022jp_output_flag=!1,r):r===S?B:(this.iso2022jp_output_flag=!1,x(this.fatal));case k.Katakana:return r===27?(this.iso2022jp_decoder_state=k.EscapeStart,null):w(r,33,95)?(this.iso2022jp_output_flag=!1,65377-33+r):r===S?B:(this.iso2022jp_output_flag=!1,x(this.fatal));case k.LeadByte:return r===27?(this.iso2022jp_decoder_state=k.EscapeStart,null):w(r,33,126)?(this.iso2022jp_output_flag=!1,this.iso2022jp_lead=r,this.iso2022jp_decoder_state=k.TrailByte,null):r===S?B:(this.iso2022jp_output_flag=!1,x(this.fatal));case k.TrailByte:if(r===27)return this.iso2022jp_decoder_state=k.EscapeStart,x(this.fatal);if(w(r,33,126)){this.iso2022jp_decoder_state=k.LeadByte;const n=(this.iso2022jp_lead-33)*94+r-33,c=ve(n,H("jis0208"));return c===null?x(this.fatal):c}return r===S?(this.iso2022jp_decoder_state=k.LeadByte,t.prepend(r),x(this.fatal)):(this.iso2022jp_decoder_state=k.LeadByte,x(this.fatal));case k.EscapeStart:return r===36||r===40?(this.iso2022jp_lead=r,this.iso2022jp_decoder_state=k.Escape,null):(t.prepend(r),this.iso2022jp_output_flag=!1,this.iso2022jp_decoder_state=this.iso2022jp_decoder_output_state,x(this.fatal));case k.Escape:const s=this.iso2022jp_lead;this.iso2022jp_lead=0;let i=null;if(s===40&&r===66&&(i=k.ASCII),s===40&&r===74&&(i=k.Roman),s===40&&r===73&&(i=k.Katakana),s===36&&(r===64||r===66)&&(i=k.LeadByte),i!==null){this.iso2022jp_decoder_state=this.iso2022jp_decoder_state=i;const n=this.iso2022jp_output_flag;return this.iso2022jp_output_flag=!0,n?x(this.fatal):null}return t.prepend([s,r]),this.iso2022jp_output_flag=!1,this.iso2022jp_decoder_state=this.iso2022jp_decoder_output_state,x(this.fatal)}}}var $;(function(e){e[e.ASCII=0]="ASCII",e[e.Roman=1]="Roman",e[e.jis0208=2]="jis0208"})($||($={}));class Ni{constructor(t){this.fatal=t.fatal,this.iso2022jp_state=$.ASCII}handler(t,r){if(r===S&&this.iso2022jp_state!==$.ASCII)return t.prepend(r),this.iso2022jp_state=$.ASCII,[27,40,66];if(r===S&&this.iso2022jp_state===$.ASCII)return B;if((this.iso2022jp_state===$.ASCII||this.iso2022jp_state===$.Roman)&&(r===14||r===15||r===27))return Z(65533);if(this.iso2022jp_state===$.ASCII&&K(r))return r;if(this.iso2022jp_state===$.Roman&&(K(r)&&r!==92&&r!==126||r==165||r==8254)){if(K(r))return r;if(r===165)return 92;if(r===8254)return 126}if(K(r)&&this.iso2022jp_state!==$.ASCII)return t.prepend(r),this.iso2022jp_state=$.ASCII,[27,40,66];if((r===165||r===8254)&&this.iso2022jp_state!==$.Roman)return t.prepend(r),this.iso2022jp_state=$.Roman,[27,40,74];r===8722&&(r=65293);const s=Ee(r,H("jis0208"));if(s===null)return Z(r);if(this.iso2022jp_state!==$.jis0208)return t.prepend(r),this.iso2022jp_state=$.jis0208,[27,36,66];const i=Math.floor(s/94)+33,n=s%94+33;return[i,n]}}class qi{constructor(t){this.fatal=t.fatal,this.Shift_JIS_lead=0}handler(t,r){if(r===S&&this.Shift_JIS_lead!==0)return this.Shift_JIS_lead=0,x(this.fatal);if(r===S&&this.Shift_JIS_lead===0)return B;if(this.Shift_JIS_lead!==0){const s=this.Shift_JIS_lead;let i=null;this.Shift_JIS_lead=0;const n=r<127?64:65,c=s<160?129:193;if((w(r,64,126)||w(r,128,252))&&(i=(s-c)*188+r-n),w(i,8836,10715))return 57344-8836+i;const l=i===null?null:ve(i,H("jis0208"));return l===null&&V(r)&&t.prepend(r),l===null?x(this.fatal):l}return V(r)||r===128?r:w(r,161,223)?65377-161+r:w(r,129,159)||w(r,224,252)?(this.Shift_JIS_lead=r,null):x(this.fatal)}}class $i{constructor(t){this.fatal=t.fatal}handler(t,r){if(r===S)return B;if(K(r)||r===128)return r;if(r===165)return 92;if(r===8254)return 126;if(w(r,65377,65439))return r-65377+161;r===8722&&(r=65293);const s=Bi(r);if(s===null)return Z(r);const i=Math.floor(s/188),n=i<31?129:193,c=s%188,l=c<63?64:65;return[i+n,c+l]}}class Hi{constructor(t,r){this.index=t,this.fatal=r.fatal}handler(t,r){if(r===S)return B;if(V(r))return r;const s=this.index[r-128];return s||x(this.fatal)}}class Ji{constructor(t,r){this.index=t,this.fatal=r.fatal}handler(t,r){if(r===S)return B;if(K(r))return r;const s=Ee(r,this.index);return s===null&&Z(r),s+128}}function Xe(e,t){const r=e>>8,s=e&255;return t?[r,s]:[s,r]}class vr{constructor(t,r){this.utf16_be=t,this.fatal=r.fatal,this.utf16_lead_byte=null,this.utf16_lead_surrogate=null}handler(t,r){if(r===S&&(this.utf16_lead_byte!==null||this.utf16_lead_surrogate!==null))return x(this.fatal);if(r===S&&this.utf16_lead_byte===null&&this.utf16_lead_surrogate===null)return B;if(this.utf16_lead_byte===null)return this.utf16_lead_byte=r,null;let s;if(this.utf16_be?s=(this.utf16_lead_byte<<8)+r:s=(r<<8)+this.utf16_lead_byte,this.utf16_lead_byte=null,this.utf16_lead_surrogate!==null){const i=this.utf16_lead_surrogate;return this.utf16_lead_surrogate=null,w(s,56320,57343)?65536+(i-55296)*1024+(s-56320):(t.prepend(Xe(s,this.utf16_be)),x(this.fatal))}return w(s,55296,56319)?(this.utf16_lead_surrogate=s,null):w(s,56320,57343)?x(this.fatal):s}}class Er{constructor(t,r){this.utf16_be=t,this.fatal=r.fatal}handler(t,r){if(r===S)return B;if(w(r,0,65535))return Xe(r,this.utf16_be);const s=Xe((r-65536>>10)+55296,this.utf16_be),i=Xe((r-65536&1023)+56320,this.utf16_be);return s.concat(i)}}class Ki{constructor(t){this.fatal=t.fatal,this.utf8_code_point=0,this.utf8_bytes_seen=0,this.utf8_bytes_needed=0,this.utf8_lower_boundary=128,this.utf8_upper_boundary=191}handler(t,r){if(r===S&&this.utf8_bytes_needed!==0)return this.utf8_bytes_needed=0,x(this.fatal);if(r===S)return B;if(this.utf8_bytes_needed===0){if(w(r,0,127))return r;if(w(r,194,223))this.utf8_bytes_needed=1,this.utf8_code_point=r&31;else if(w(r,224,239))r===224&&(this.utf8_lower_boundary=160),r===237&&(this.utf8_upper_boundary=159),this.utf8_bytes_needed=2,this.utf8_code_point=r&15;else if(w(r,240,244))r===240&&(this.utf8_lower_boundary=144),r===244&&(this.utf8_upper_boundary=143),this.utf8_bytes_needed=3,this.utf8_code_point=r&7;else return x(this.fatal);return null}if(!w(r,this.utf8_lower_boundary,this.utf8_upper_boundary))return this.utf8_code_point=this.utf8_bytes_needed=this.utf8_bytes_seen=0,this.utf8_lower_boundary=128,this.utf8_upper_boundary=191,t.prepend(r),x(this.fatal);if(this.utf8_lower_boundary=128,this.utf8_upper_boundary=191,this.utf8_code_point=this.utf8_code_point<<6|r&63,this.utf8_bytes_seen+=1,this.utf8_bytes_seen!==this.utf8_bytes_needed)return null;const s=this.utf8_code_point;return this.utf8_code_point=this.utf8_bytes_needed=this.utf8_bytes_seen=0,s}}class Vi{constructor(t){this.fatal=t.fatal}handler(t,r){if(r===S)return B;if(K(r))return r;let s,i;w(r,128,2047)?(s=1,i=192):w(r,2048,65535)?(s=2,i=224):w(r,65536,1114111)&&(s=3,i=240);const n=[(r>>6*s)+i];for(;s>0;){const c=r>>6*(s-1);n.push(128|c&63),s-=1}return n}}class Gi{constructor(t){this.fatal=t.fatal}handler(t,r){return r===S?B:V(r)?r:63360+r-128}}class Wi{constructor(t){this.fatal=t.fatal}handler(t,r){return r===S?B:K(r)?r:w(r,63360,63487)?r-63360+128:Z(r)}}const Zi=Zr(),kt={"UTF-8":e=>new Vi(e),GBK:e=>new zr(e,!0),gb18030:e=>new zr(e),Big5:e=>new Di(e),"EUC-JP":e=>new Pi(e),"ISO-2022-JP":e=>new Ni(e),Shift_JIS:e=>new $i(e),"EUC-KR":e=>new Ri(e),"UTF-16BE":e=>new Er(!0,e),"UTF-16LE":e=>new Er(!1,e),"x-user-defined":e=>new Wi(e)},Ot={"UTF-8":e=>new Ki(e),GBK:e=>new Ur(e),gb18030:e=>new Ur(e),Big5:e=>new Oi(e),"EUC-JP":e=>new ji(e),"ISO-2022-JP":e=>new Li(e),Shift_JIS:e=>new qi(e),"EUC-KR":e=>new Mi(e),"UTF-16BE":e=>new vr(!0,e),"UTF-16LE":e=>new vr(!1,e),"x-user-defined":e=>new Gi(e)};Zi&&Vr.forEach(function(e){e.heading==="Legacy single-byte encodings"&&e.encodings.forEach(function(t){const r=t.name,s=H(r.toLowerCase());Ot[r]=function(i){return new Hi(s,i)},kt[r]=function(i){return new Ji(s,i)}})});class Xr{constructor(t){this.tokens=Array.from(t),this.tokens.reverse()}endOfStream(){return!this.tokens.length}read(){return this.tokens.length?this.tokens.pop():S}prepend(t){if(Array.isArray(t)){const r=t;for(;r.length;)this.tokens.push(r.pop())}else this.tokens.push(t)}push(t){if(Array.isArray(t)){const r=t;for(;r.length;)this.tokens.unshift(r.shift())}else this.tokens.unshift(t)}}class Yr{constructor(t,r){t=t!==void 0?String(t):Kr;const s=et(r);this._encoding=null,this._decoder=null,this._ignoreBOM=!1,this._BOMseen=!1,this._error_mode="replacement",this._do_not_flush=!1;const i=Ct(t);if(i===null||i.name==="replacement")throw RangeError("Unknown encoding: "+t);if(!Ot[i.name])throw Error("Decoder not present. Did you forget to include encoding-indexes.js first?");this._encoding=i,Boolean(s.fatal)&&(this._error_mode="fatal"),Boolean(s.ignoreBOM)&&(this._ignoreBOM=!0)}get encoding(){return this._encoding.name.toLowerCase()}get fatal(){return this._error_mode==="fatal"}get ignoreBOM(){return this._ignoreBOM}decode(t,r){const s=Xi(t),i=et(r);this._do_not_flush||(this._decoder=Ot[this._encoding.name]({fatal:this._error_mode==="fatal"}),this._BOMseen=!1),this._do_not_flush=Boolean(i.stream);const n=new Xr(s),c=[];let l;for(;;){const g=n.read();if(g===S||(l=this._decoder.handler(n,g),l===B))break;l!==null&&(Array.isArray(l)?c.push.apply(c,l):c.push(l))}if(!this._do_not_flush){do{if(l=this._decoder.handler(n,n.read()),l===B)break;!l||(Array.isArray(l)?c.push.apply(c,l):c.push(l))}while(!n.endOfStream());this._decoder=null}return this.serializeStream(c)}serializeStream(t){return Fi(["UTF-8","UTF-16LE","UTF-16BE"],this._encoding.name)&&!this._ignoreBOM&&!this._BOMseen&&(t.length>0&&t[0]===65279?(this._BOMseen=!0,t.shift()):t.length>0&&(this._BOMseen=!0)),zi(t)}}function Cr(e){try{return e instanceof ArrayBuffer}catch(t){return console.error(t),!1}}function Xi(e){return typeof e!="object"?new Uint8Array(0):Cr(e)?new Uint8Array(e):"buffer"in e&&Cr(e.buffer)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(0)}class Qr{constructor(t,r){const s=et(r);if(this._encoding=null,this._encoder=null,this._do_not_flush=!1,this._fatal=Boolean(s.fatal)?"fatal":"replacement",Boolean(s.NONSTANDARD_allowLegacyEncoding)){t=t?String(t):Kr;const i=Ct(t);if(i===null||i.name==="replacement")throw RangeError("Unknown encoding: "+t);if(!kt[i.name])throw Error("Encoder not present. Did you forget to include encoding-indexes.js first?");this._encoding=i}else{this._encoding=Ct("utf-8");const i=Wr()||{};t!==void 0&&"console"in i&&console.warn("TextEncoder constructor called with encoding label, which is ignored.")}}get encoding(){return this._encoding.name.toLowerCase()}encode(t,r){t=t===void 0?"":String(t);const s=et(r);this._do_not_flush||(this._encoder=kt[this._encoding.name]({fatal:this._fatal==="fatal"})),this._do_not_flush=Boolean(s.stream);const i=new Xr(Ui(t)),n=[];let c;for(;;){const l=i.read();if(l===S||(c=this._encoder.handler(i,l),c===B))break;Array.isArray(c)?n.push.apply(n,c):n.push(c)}if(!this._do_not_flush){for(;c=this._encoder.handler(i,i.read()),c!==B;)Array.isArray(c)?n.push.apply(n,c):n.push(c);this._encoder=null}return new Uint8Array(n)}}if(typeof window<"u"){const e=t=>!(t in window)||typeof window[t]>"u"||window[t]===null;e("TextDecoder")&&(window.TextDecoder=Yr),e("TextEncoder")&&(window.TextEncoder=Qr)}var ei=ts,Y=[],Br="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var We=0,Yi=Br.length;We<Yi;++We)Y[We]=Br[We];function Qi(e){return Y[e>>18&63]+Y[e>>12&63]+Y[e>>6&63]+Y[e&63]}function es(e,t,r){for(var s,i=[],n=t;n<r;n+=3)s=(e[n]<<16&16711680)+(e[n+1]<<8&65280)+(e[n+2]&255),i.push(Qi(s));return i.join("")}function ts(e){for(var t,r=e.length,s=r%3,i=[],n=16383,c=0,l=r-s;c<l;c+=n)i.push(es(e,c,c+n>l?l:c+n));return s===1?(t=e[r-1],i.push(Y[t>>2]+Y[t<<4&63]+"==")):s===2&&(t=(e[r-2]<<8)+e[r-1],i.push(Y[t>>10]+Y[t>>4&63]+Y[t<<2&63]+"=")),i.join("")}var U,T,Pr,we=(Pr=class{constructor(e){y(this,U,void 0);y(this,T,0);d(this,U,new DataView(e.buffer)),d(this,T,e.byteOffset)}get offset(){return a(this,T)}readUInt8Array(){const e=this.readU32(),t=new Uint8Array(a(this,U).buffer,a(this,T),e);return d(this,T,a(this,T)+e),t}readBool(){const e=a(this,U).getUint8(a(this,T));return d(this,T,a(this,T)+1),e!==0}readByte(){const e=a(this,U).getUint8(a(this,T));return d(this,T,a(this,T)+1),e}readBytes(e){const t=new DataView(a(this,U).buffer,a(this,T),e);return d(this,T,a(this,T)+e),new Uint8Array(t.buffer)}readI8(){const e=a(this,U).getInt8(a(this,T));return d(this,T,a(this,T)+1),e}readU8(){const e=a(this,U).getUint8(a(this,T));return d(this,T,a(this,T)+1),e}readI16(){const e=a(this,U).getInt16(a(this,T),!0);return d(this,T,a(this,T)+2),e}readU16(){const e=a(this,U).getUint16(a(this,T),!0);return d(this,T,a(this,T)+2),e}readI32(){const e=a(this,U).getInt32(a(this,T),!0);return d(this,T,a(this,T)+4),e}readU32(){const e=a(this,U).getUint32(a(this,T),!0);return d(this,T,a(this,T)+4),e}readI64(){const e=a(this,U).getBigInt64(a(this,T),!0);return d(this,T,a(this,T)+8),e}readU64(){const e=a(this,U).getBigUint64(a(this,T),!0);return d(this,T,a(this,T)+8),e}readU128(){const e=a(this,U).getBigUint64(a(this,T),!0),t=a(this,U).getBigUint64(a(this,T)+8,!0);return d(this,T,a(this,T)+16),(t<<BigInt(64))+e}readI128(){const e=a(this,U).getBigUint64(a(this,T),!0),t=a(this,U).getBigInt64(a(this,T)+8,!0);return d(this,T,a(this,T)+16),(t<<BigInt(64))+e}readU256(){const e=a(this,U).getBigUint64(a(this,T),!0),t=a(this,U).getBigUint64(a(this,T)+8,!0),r=a(this,U).getBigUint64(a(this,T)+16,!0),s=a(this,U).getBigUint64(a(this,T)+24,!0);return d(this,T,a(this,T)+32),(s<<BigInt(3*64))+(r<<BigInt(2*64))+(t<<BigInt(1*64))+e}readI256(){const e=a(this,U).getBigUint64(a(this,T),!0),t=a(this,U).getBigUint64(a(this,T)+8,!0),r=a(this,U).getBigUint64(a(this,T)+16,!0),s=a(this,U).getBigInt64(a(this,T)+24,!0);return d(this,T,a(this,T)+32),(s<<BigInt(3*64))+(r<<BigInt(2*64))+(t<<BigInt(1*64))+e}readF32(){const e=a(this,U).getFloat32(a(this,T),!0);return d(this,T,a(this,T)+4),e}readF64(){const e=a(this,U).getFloat64(a(this,T),!0);return d(this,T,a(this,T)+8),e}readString(){const e=this.readU32(),t=new Uint8Array(a(this,U).buffer,a(this,T),e),s=new Yr("utf-8").decode(t);return d(this,T,a(this,T)+e),s}},U=new WeakMap,T=new WeakMap,Pr),J,v,b,M,L,Mr,ae=(Mr=class{constructor(e){y(this,M);y(this,J,void 0);y(this,v,void 0);y(this,b,0);d(this,J,new Uint8Array(e)),d(this,v,new DataView(a(this,J).buffer))}toBase64(){return ei(a(this,J).subarray(0,a(this,b)))}getBuffer(){return a(this,J).slice(0,a(this,b))}writeUInt8Array(e){const t=e.length;f(this,M,L).call(this,4+t),this.writeU32(t),a(this,J).set(e,a(this,b)),d(this,b,a(this,b)+e.length)}writeBool(e){f(this,M,L).call(this,1),a(this,v).setUint8(a(this,b),e?1:0),d(this,b,a(this,b)+1)}writeByte(e){f(this,M,L).call(this,1),a(this,v).setUint8(a(this,b),e),d(this,b,a(this,b)+1)}writeI8(e){f(this,M,L).call(this,1),a(this,v).setInt8(a(this,b),e),d(this,b,a(this,b)+1)}writeU8(e){f(this,M,L).call(this,1),a(this,v).setUint8(a(this,b),e),d(this,b,a(this,b)+1)}writeI16(e){f(this,M,L).call(this,2),a(this,v).setInt16(a(this,b),e,!0),d(this,b,a(this,b)+2)}writeU16(e){f(this,M,L).call(this,2),a(this,v).setUint16(a(this,b),e,!0),d(this,b,a(this,b)+2)}writeI32(e){f(this,M,L).call(this,4),a(this,v).setInt32(a(this,b),e,!0),d(this,b,a(this,b)+4)}writeU32(e){f(this,M,L).call(this,4),a(this,v).setUint32(a(this,b),e,!0),d(this,b,a(this,b)+4)}writeI64(e){f(this,M,L).call(this,8),a(this,v).setBigInt64(a(this,b),e,!0),d(this,b,a(this,b)+8)}writeU64(e){f(this,M,L).call(this,8),a(this,v).setBigUint64(a(this,b),e,!0),d(this,b,a(this,b)+8)}writeU128(e){f(this,M,L).call(this,16);const t=e&BigInt("0xFFFFFFFFFFFFFFFF"),r=e>>BigInt(64);a(this,v).setBigUint64(a(this,b),t,!0),a(this,v).setBigUint64(a(this,b)+8,r,!0),d(this,b,a(this,b)+16)}writeI128(e){f(this,M,L).call(this,16);const t=e&BigInt("0xFFFFFFFFFFFFFFFF"),r=e>>BigInt(64);a(this,v).setBigInt64(a(this,b),t,!0),a(this,v).setBigInt64(a(this,b)+8,r,!0),d(this,b,a(this,b)+16)}writeU256(e){f(this,M,L).call(this,32);const t=BigInt("0xFFFFFFFFFFFFFFFF"),r=e&t,s=e>>BigInt(64*1)&t,i=e>>BigInt(64*2)&t,n=e>>BigInt(64*3);a(this,v).setBigUint64(a(this,b)+8*0,r,!0),a(this,v).setBigUint64(a(this,b)+8*1,s,!0),a(this,v).setBigUint64(a(this,b)+8*2,i,!0),a(this,v).setBigUint64(a(this,b)+8*3,n,!0),d(this,b,a(this,b)+32)}writeI256(e){f(this,M,L).call(this,32);const t=BigInt("0xFFFFFFFFFFFFFFFF"),r=e&t,s=e>>BigInt(64*1)&t,i=e>>BigInt(64*2)&t,n=e>>BigInt(64*3);a(this,v).setBigUint64(a(this,b)+8*0,r,!0),a(this,v).setBigUint64(a(this,b)+8*1,s,!0),a(this,v).setBigUint64(a(this,b)+8*2,i,!0),a(this,v).setBigInt64(a(this,b)+8*3,n,!0),d(this,b,a(this,b)+32)}writeF32(e){f(this,M,L).call(this,4),a(this,v).setFloat32(a(this,b),e,!0),d(this,b,a(this,b)+4)}writeF64(e){f(this,M,L).call(this,8),a(this,v).setFloat64(a(this,b),e,!0),d(this,b,a(this,b)+8)}writeString(e){const r=new Qr().encode(e);this.writeU32(r.length),f(this,M,L).call(this,r.length),a(this,J).set(r,a(this,b)),d(this,b,a(this,b)+r.length)}},J=new WeakMap,v=new WeakMap,b=new WeakMap,M=new WeakSet,L=function(e){const t=a(this,b)+e+1;if(t<=a(this,J).length)return;let r=a(this,J).length*2;r<t&&(r=t);const s=new Uint8Array(r);s.set(a(this,J)),d(this,J,s),d(this,v,new DataView(a(this,J).buffer))},Mr);function wt(e,t){if(e===t)return!0;if(typeof e!="object"||e===null||typeof t!="object"||t===null)return!1;const r=Object.keys(e),s=Object.keys(t);if(r.length!==s.length)return!1;for(let i of r)if(!s.includes(i)||!wt(e[i],t[i]))return!1;return!0}function ti(e){return Array.prototype.map.call(e.reverse(),t=>("00"+t.toString(16)).slice(-2)).join("")}function rs(e){if(e.length!=16)throw new Error(`Uint8Array is not 16 bytes long: ${e}`);return new we(e).readU128()}function is(e){if(e.length!=32)throw new Error(`Uint8Array is not 32 bytes long: [${e}]`);return new we(e).readU256()}function ri(e){e.startsWith("0x")&&(e=e.slice(2));let t=e.match(/.{1,2}/g)||[],r=Uint8Array.from(t.map(s=>parseInt(s,16)));return r.length!=32?new Uint8Array(0):r.reverse()}function ss(e){return rs(ri(e))}function ns(e){return is(ri(e))}function ii(e){let t=new ae(16);return t.writeU128(e),t.getBuffer()}function as(e){return ti(ii(e))}function si(e){let t=new ae(32);return t.writeU256(e),t.getBuffer()}function cs(e){return ti(si(e))}var Dt=class Ye{constructor(t){p(this,"data");this.data=t}get __connection_id__(){return this.data}isZero(){return this.data===BigInt(0)}static nullIfZero(t){return t.isZero()?null:t}static random(){function t(){return Math.floor(Math.random()*255)}let r=BigInt(0);for(let s=0;s<16;s++)r=r<<BigInt(8)|BigInt(t());return new Ye(r)}isEqual(t){return this.data==t.data}toHexString(){return as(this.data)}toUint8Array(){return ii(this.data)}static fromString(t){return new Ye(ss(t))}static fromStringOrNull(t){let r=Ye.fromString(t);return r.isZero()?null:r}},ce,os=(ce=class{constructor(t){p(this,"__time_duration_micros__");this.__time_duration_micros__=t}get micros(){return this.__time_duration_micros__}get millis(){return Number(this.micros/ce.MICROS_PER_MILLIS)}static fromMillis(t){return new ce(BigInt(t)*ce.MICROS_PER_MILLIS)}},p(ce,"MICROS_PER_MILLIS",1000n),ce),W,ls=(W=class{constructor(t){p(this,"__timestamp_micros_since_unix_epoch__");this.__timestamp_micros_since_unix_epoch__=t}get microsSinceUnixEpoch(){return this.__timestamp_micros_since_unix_epoch__}static now(){return W.fromDate(new Date)}static fromDate(t){const r=t.getTime(),s=BigInt(r)*W.MICROS_PER_MILLIS;return new W(s)}toDate(){const r=this.__timestamp_micros_since_unix_epoch__/W.MICROS_PER_MILLIS;if(r>BigInt(Number.MAX_SAFE_INTEGER)||r<BigInt(Number.MIN_SAFE_INTEGER))throw new RangeError("Timestamp is outside of the representable range of JS's Date");return new Date(Number(r))}},p(W,"MICROS_PER_MILLIS",1000n),p(W,"UNIX_EPOCH",new W(0n)),W),ni=class ai{constructor(t){p(this,"data");this.data=typeof t=="string"?ns(t):t}get __identity__(){return this.data}isEqual(t){return this.toHexString()===t.toHexString()}toHexString(){return cs(this.data)}toUint8Array(){return si(this.data)}static fromString(t){return new ai(t)}},jt;(e=>{function t(){return o.createSumType([new E("Interval",o.createTimeDurationType()),new E("Time",o.createTimestampType())])}e.getAlgebraicType=t,e.Interval=s=>({tag:"Interval",value:{__time_duration_micros__:s}}),e.Time=s=>({tag:"Time",value:{__timestamp_micros_since_unix_epoch__:s}});function r(s){let i=s.asSumValue();switch(i.tag){case 0:return{tag:"Interval",value:{__time_duration_micros__:i.value.asProductValue().elements[0].asBigInt()}};case 1:return{tag:"Time",value:{__timestamp_micros_since_unix_epoch__:i.value.asBigInt()}};default:throw"unreachable"}}e.fromValue=r})(jt||(jt={}));var us=jt,E=class{constructor(e,t){p(this,"name");p(this,"algebraicType");this.name=e,this.algebraicType=t}},ps=class{constructor(e){p(this,"variants");p(this,"serialize",(e,t)=>{if(this.variants.length==2&&this.variants[0].name==="some"&&this.variants[1].name==="none")t!=null?(e.writeByte(0),this.variants[0].algebraicType.serialize(e,t)):e.writeByte(1);else{let r=t.tag;const s=this.variants.findIndex(i=>i.name===r);if(s<0)throw`Can't serialize a sum type, couldn't find ${t.tag} tag`;e.writeU8(s),this.variants[s].algebraicType.serialize(e,t.value)}});p(this,"deserialize",e=>{let t=e.readU8();if(this.variants.length==2&&this.variants[0].name==="some"&&this.variants[1].name==="none"){if(t===0)return this.variants[0].algebraicType.deserialize(e);if(t===1)return;throw`Can't deserialize an option type, couldn't find ${t} tag`}else{let r=this.variants[t],s=r.algebraicType.deserialize(e);return{tag:r.name,value:s}}});this.variants=e}},u=class{constructor(e,t){p(this,"name");p(this,"algebraicType");this.name=e,this.algebraicType=t}},hs=class{constructor(e){p(this,"elements");p(this,"serialize",(e,t)=>{for(let r of this.elements)r.algebraicType.serialize(e,t[r.name])});p(this,"deserialize",e=>{let t={};if(this.elements.length===1){if(this.elements[0].name==="__time_duration_micros__")return new os(e.readI64());if(this.elements[0].name==="__timestamp_micros_since_unix_epoch__")return new ls(e.readI64());if(this.elements[0].name==="__identity__")return new ni(e.readU256());if(this.elements[0].name==="__connection_id__")return new Dt(e.readU128())}for(let r of this.elements)t[r.name]=r.algebraicType.deserialize(e);return t});this.elements=e}isEmpty(){return this.elements.length===0}intoMapKey(e){if(this.elements.length===1){if(this.elements[0].name==="__time_duration_micros__")return e.__time_duration_micros__;if(this.elements[0].name==="__timestamp_micros_since_unix_epoch__")return e.__timestamp_micros_since_unix_epoch__;if(this.elements[0].name==="__identity__")return e.__identity__;if(this.elements[0].name==="__connection_id__")return e.__connection_id__}const t=new ae(10);return this.serialize(t,e),t.toBase64()}},ds=class{constructor(e,t){p(this,"keyType");p(this,"valueType");this.keyType=e,this.valueType=t}},te,be,D,_e,P,De,Pt,je,Mt,Pe,Rt,o=(_e=class{constructor(){y(this,te);y(this,De);y(this,je);y(this,Pe);p(this,"type");p(this,"type_")}get product(){if(this.type!==h.ProductType)throw"product type was requested, but the type is not ProductType";return this.type_}set product(t){f(this,te,be).call(this,h.ProductType,t)}get sum(){if(this.type!==h.SumType)throw"sum type was requested, but the type is not SumType";return this.type_}set sum(t){f(this,te,be).call(this,h.SumType,t)}get array(){if(this.type!==h.ArrayType)throw"array type was requested, but the type is not ArrayType";return this.type_}set array(t){f(this,te,be).call(this,h.ArrayType,t)}get map(){if(this.type!==h.MapType)throw"map type was requested, but the type is not MapType";return this.type_}set map(t){f(this,te,be).call(this,h.MapType,t)}static createProductType(t){return f(this,D,P).call(this,h.ProductType,new hs(t))}static createSumType(t){return f(this,D,P).call(this,h.SumType,new ps(t))}static createArrayType(t){return f(this,D,P).call(this,h.ArrayType,t)}static createMapType(t,r){return f(this,D,P).call(this,h.MapType,new ds(t,r))}static createBoolType(){return f(this,D,P).call(this,h.Bool,null)}static createI8Type(){return f(this,D,P).call(this,h.I8,null)}static createU8Type(){return f(this,D,P).call(this,h.U8,null)}static createI16Type(){return f(this,D,P).call(this,h.I16,null)}static createU16Type(){return f(this,D,P).call(this,h.U16,null)}static createI32Type(){return f(this,D,P).call(this,h.I32,null)}static createU32Type(){return f(this,D,P).call(this,h.U32,null)}static createI64Type(){return f(this,D,P).call(this,h.I64,null)}static createU64Type(){return f(this,D,P).call(this,h.U64,null)}static createI128Type(){return f(this,D,P).call(this,h.I128,null)}static createU128Type(){return f(this,D,P).call(this,h.U128,null)}static createI256Type(){return f(this,D,P).call(this,h.I256,null)}static createU256Type(){return f(this,D,P).call(this,h.U256,null)}static createF32Type(){return f(this,D,P).call(this,h.F32,null)}static createF64Type(){return f(this,D,P).call(this,h.F64,null)}static createStringType(){return f(this,D,P).call(this,h.String,null)}static createBytesType(){return this.createArrayType(this.createU8Type())}static createOptionType(t){return this.createSumType([new E("some",t),new E("none",this.createProductType([]))])}static createIdentityType(){return this.createProductType([new u("__identity__",this.createU256Type())])}static createConnectionIdType(){return this.createProductType([new u("__connection_id__",this.createU128Type())])}static createScheduleAtType(){return us.getAlgebraicType()}static createTimestampType(){return this.createProductType([new u("__timestamp_micros_since_unix_epoch__",this.createI64Type())])}static createTimeDurationType(){return this.createProductType([new u("__time_duration_micros__",this.createI64Type())])}isProductType(){return this.type===h.ProductType}isSumType(){return this.type===h.SumType}isArrayType(){return this.type===h.ArrayType}isMapType(){return this.type===h.MapType}isIdentity(){return f(this,je,Mt).call(this,"__identity__")}isConnectionId(){return f(this,je,Mt).call(this,"__connection_id__")}isScheduleAt(){return this.isSumType()&&this.sum.variants.length===2&&this.sum.variants[0].name==="Interval"&&this.sum.variants[0].algebraicType.type===h.U64&&this.sum.variants[1].name==="Time"&&this.sum.variants[1].algebraicType.type===h.U64}isTimestamp(){return f(this,Pe,Rt).call(this,"__timestamp_micros_since_unix_epoch__")}isTimeDuration(){return f(this,Pe,Rt).call(this,"__time_duration_micros__")}intoMapKey(t){switch(this.type){case h.U8:case h.U16:case h.U32:case h.U64:case h.U128:case h.U256:case h.I8:case h.I16:case h.I64:case h.I128:case h.F32:case h.F64:case h.String:case h.Bool:return t;case h.ProductType:return this.product.intoMapKey(t);default:const r=new ae(10);return this.serialize(r,t),r.toBase64()}}serialize(t,r){switch(this.type){case h.ProductType:this.product.serialize(t,r);break;case h.SumType:this.sum.serialize(t,r);break;case h.ArrayType:if(f(this,De,Pt).call(this))t.writeUInt8Array(r);else{const s=this.array;t.writeU32(r.length);for(let i of r)s.serialize(t,i)}break;case h.MapType:throw new Error("not implemented");case h.Bool:t.writeBool(r);break;case h.I8:t.writeI8(r);break;case h.U8:t.writeU8(r);break;case h.I16:t.writeI16(r);break;case h.U16:t.writeU16(r);break;case h.I32:t.writeI32(r);break;case h.U32:t.writeU32(r);break;case h.I64:t.writeI64(r);break;case h.U64:t.writeU64(r);break;case h.I128:t.writeI128(r);break;case h.U128:t.writeU128(r);break;case h.I256:t.writeI256(r);break;case h.U256:t.writeU256(r);break;case h.F32:t.writeF32(r);break;case h.F64:t.writeF64(r);break;case h.String:t.writeString(r);break;default:throw new Error(`not implemented, ${this.type}`)}}deserialize(t){switch(this.type){case h.ProductType:return this.product.deserialize(t);case h.SumType:return this.sum.deserialize(t);case h.ArrayType:if(f(this,De,Pt).call(this))return t.readUInt8Array();{const r=this.array,s=t.readU32();let i=[];for(let n=0;n<s;n++)i.push(r.deserialize(t));return i}case h.MapType:throw new Error("not implemented");case h.Bool:return t.readBool();case h.I8:return t.readI8();case h.U8:return t.readU8();case h.I16:return t.readI16();case h.U16:return t.readU16();case h.I32:return t.readI32();case h.U32:return t.readU32();case h.I64:return t.readI64();case h.U64:return t.readU64();case h.I128:return t.readI128();case h.U128:return t.readU128();case h.U256:return t.readU256();case h.F32:return t.readF32();case h.F64:return t.readF64();case h.String:return t.readString();default:throw new Error(`not implemented, ${this.type}`)}}},te=new WeakSet,be=function(t,r){this.type_=r,this.type=r===void 0?h.None:t},D=new WeakSet,P=function(t,r){var i;let s=new _e;return f(i=s,te,be).call(i,t,r),s},De=new WeakSet,Pt=function(){return this.isArrayType()&&this.array.type==h.U8},je=new WeakSet,Mt=function(t){return this.isProductType()&&this.product.elements.length===1&&(this.product.elements[0].algebraicType.type==h.U128||this.product.elements[0].algebraicType.type==h.U256)&&this.product.elements[0].name===t},Pe=new WeakSet,Rt=function(t){return this.isProductType()&&this.product.elements.length===1&&this.product.elements[0].algebraicType.type===h.I64&&this.product.elements[0].name===t},y(_e,D),_e);(e=>{(t=>{t.SumType="SumType",t.ProductType="ProductType",t.ArrayType="ArrayType",t.MapType="MapType",t.Bool="Bool",t.I8="I8",t.U8="U8",t.I16="I16",t.U16="U16",t.I32="I32",t.U32="U32",t.I64="I64",t.U64="U64",t.I128="I128",t.U128="U128",t.I256="I256",t.U256="U256",t.F32="F32",t.F64="F64",t.String="String",t.None="None"})(e.Type||(e.Type={}))})(o||(o={}));var h=o.Type;function fs(e,t){const r=new we(t);return e.deserialize(r)}var Lt;(e=>{e.FixedSize=i=>({tag:"FixedSize",value:i}),e.RowOffsets=i=>({tag:"RowOffsets",value:i});function t(){return o.createSumType([new E("FixedSize",o.createU16Type()),new E("RowOffsets",o.createArrayType(o.createU64Type()))])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})(Lt||(Lt={}));var Oe;(e=>{function t(){return o.createProductType([new u("sizeHint",Lt.getTypeScriptAlgebraicType()),new u("rowsData",o.createArrayType(o.createU8Type()))])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})(Oe||(Oe={}));var Nt;(e=>{function t(){return o.createProductType([new u("reducer",o.createStringType()),new u("args",o.createArrayType(o.createU8Type())),new u("requestId",o.createU32Type()),new u("flags",o.createU8Type())])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})(Nt||(Nt={}));var qt;(e=>{function t(){return o.createProductType([new u("queryStrings",o.createArrayType(o.createStringType())),new u("requestId",o.createU32Type())])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})(qt||(qt={}));var $t;(e=>{function t(){return o.createProductType([new u("messageId",o.createArrayType(o.createU8Type())),new u("queryString",o.createStringType())])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})($t||($t={}));var Q;(e=>{function t(){return o.createProductType([new u("id",o.createU32Type())])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})(Q||(Q={}));var Ht;(e=>{function t(){return o.createProductType([new u("query",o.createStringType()),new u("requestId",o.createU32Type()),new u("queryId",Q.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})(Ht||(Ht={}));var Jt;(e=>{function t(){return o.createProductType([new u("queryStrings",o.createArrayType(o.createStringType())),new u("requestId",o.createU32Type()),new u("queryId",Q.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})(Jt||(Jt={}));var Kt;(e=>{function t(){return o.createProductType([new u("requestId",o.createU32Type()),new u("queryId",Q.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})(Kt||(Kt={}));var Vt;(e=>{function t(){return o.createProductType([new u("requestId",o.createU32Type()),new u("queryId",Q.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})(Vt||(Vt={}));var me;(e=>{e.CallReducer=i=>({tag:"CallReducer",value:i}),e.Subscribe=i=>({tag:"Subscribe",value:i}),e.OneOffQuery=i=>({tag:"OneOffQuery",value:i}),e.SubscribeSingle=i=>({tag:"SubscribeSingle",value:i}),e.SubscribeMulti=i=>({tag:"SubscribeMulti",value:i}),e.Unsubscribe=i=>({tag:"Unsubscribe",value:i}),e.UnsubscribeMulti=i=>({tag:"UnsubscribeMulti",value:i});function t(){return o.createSumType([new E("CallReducer",Nt.getTypeScriptAlgebraicType()),new E("Subscribe",qt.getTypeScriptAlgebraicType()),new E("OneOffQuery",$t.getTypeScriptAlgebraicType()),new E("SubscribeSingle",Ht.getTypeScriptAlgebraicType()),new E("SubscribeMulti",Jt.getTypeScriptAlgebraicType()),new E("Unsubscribe",Kt.getTypeScriptAlgebraicType()),new E("UnsubscribeMulti",Vt.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})(me||(me={}));var tt;(e=>{function t(){return o.createProductType([new u("deletes",Oe.getTypeScriptAlgebraicType()),new u("inserts",Oe.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})(tt||(tt={}));var Gt;(e=>{e.Uncompressed=i=>({tag:"Uncompressed",value:i}),e.Brotli=i=>({tag:"Brotli",value:i}),e.Gzip=i=>({tag:"Gzip",value:i});function t(){return o.createSumType([new E("Uncompressed",tt.getTypeScriptAlgebraicType()),new E("Brotli",o.createArrayType(o.createU8Type())),new E("Gzip",o.createArrayType(o.createU8Type()))])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})(Gt||(Gt={}));var rt;(e=>{function t(){return o.createProductType([new u("tableId",o.createU32Type()),new u("tableName",o.createStringType()),new u("numRows",o.createU64Type()),new u("updates",o.createArrayType(Gt.getTypeScriptAlgebraicType()))])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})(rt||(rt={}));var Te;(e=>{function t(){return o.createProductType([new u("tables",o.createArrayType(rt.getTypeScriptAlgebraicType()))])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})(Te||(Te={}));var Wt;(e=>{function t(){return o.createProductType([new u("databaseUpdate",Te.getTypeScriptAlgebraicType()),new u("requestId",o.createU32Type()),new u("totalHostExecutionDuration",o.createTimeDurationType())])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})(Wt||(Wt={}));var Zt;(e=>{e.Committed=i=>({tag:"Committed",value:i}),e.Failed=i=>({tag:"Failed",value:i}),e.OutOfEnergy={tag:"OutOfEnergy"};function t(){return o.createSumType([new E("Committed",Te.getTypeScriptAlgebraicType()),new E("Failed",o.createStringType()),new E("OutOfEnergy",o.createProductType([]))])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})(Zt||(Zt={}));var Xt;(e=>{function t(){return o.createProductType([new u("reducerName",o.createStringType()),new u("reducerId",o.createU32Type()),new u("args",o.createArrayType(o.createU8Type())),new u("requestId",o.createU32Type())])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})(Xt||(Xt={}));var Yt;(e=>{function t(){return o.createProductType([new u("quanta",o.createU128Type())])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})(Yt||(Yt={}));var Qt;(e=>{function t(){return o.createProductType([new u("status",Zt.getTypeScriptAlgebraicType()),new u("timestamp",o.createTimestampType()),new u("callerIdentity",o.createIdentityType()),new u("callerConnectionId",o.createConnectionIdType()),new u("reducerCall",Xt.getTypeScriptAlgebraicType()),new u("energyQuantaUsed",Yt.getTypeScriptAlgebraicType()),new u("totalHostExecutionDuration",o.createTimeDurationType())])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})(Qt||(Qt={}));var er;(e=>{function t(){return o.createProductType([new u("requestId",o.createU32Type()),new u("update",Te.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})(er||(er={}));var tr;(e=>{function t(){return o.createProductType([new u("identity",o.createIdentityType()),new u("token",o.createStringType()),new u("connectionId",o.createConnectionIdType())])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})(tr||(tr={}));var rr;(e=>{function t(){return o.createProductType([new u("tableName",o.createStringType()),new u("rows",Oe.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})(rr||(rr={}));var ir;(e=>{function t(){return o.createProductType([new u("messageId",o.createArrayType(o.createU8Type())),new u("error",o.createOptionType(o.createStringType())),new u("tables",o.createArrayType(rr.getTypeScriptAlgebraicType())),new u("totalHostExecutionDuration",o.createTimeDurationType())])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})(ir||(ir={}));var it;(e=>{function t(){return o.createProductType([new u("tableId",o.createU32Type()),new u("tableName",o.createStringType()),new u("tableRows",rt.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})(it||(it={}));var sr;(e=>{function t(){return o.createProductType([new u("requestId",o.createU32Type()),new u("totalHostExecutionDurationMicros",o.createU64Type()),new u("queryId",Q.getTypeScriptAlgebraicType()),new u("rows",it.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})(sr||(sr={}));var nr;(e=>{function t(){return o.createProductType([new u("requestId",o.createU32Type()),new u("totalHostExecutionDurationMicros",o.createU64Type()),new u("queryId",Q.getTypeScriptAlgebraicType()),new u("rows",it.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})(nr||(nr={}));var ar;(e=>{function t(){return o.createProductType([new u("totalHostExecutionDurationMicros",o.createU64Type()),new u("requestId",o.createOptionType(o.createU32Type())),new u("queryId",o.createOptionType(o.createU32Type())),new u("tableId",o.createOptionType(o.createU32Type())),new u("error",o.createStringType())])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})(ar||(ar={}));var cr;(e=>{function t(){return o.createProductType([new u("requestId",o.createU32Type()),new u("totalHostExecutionDurationMicros",o.createU64Type()),new u("queryId",Q.getTypeScriptAlgebraicType()),new u("update",Te.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})(cr||(cr={}));var or;(e=>{function t(){return o.createProductType([new u("requestId",o.createU32Type()),new u("totalHostExecutionDurationMicros",o.createU64Type()),new u("queryId",Q.getTypeScriptAlgebraicType()),new u("update",Te.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})(or||(or={}));var lr;(e=>{e.InitialSubscription=i=>({tag:"InitialSubscription",value:i}),e.TransactionUpdate=i=>({tag:"TransactionUpdate",value:i}),e.TransactionUpdateLight=i=>({tag:"TransactionUpdateLight",value:i}),e.IdentityToken=i=>({tag:"IdentityToken",value:i}),e.OneOffQueryResponse=i=>({tag:"OneOffQueryResponse",value:i}),e.SubscribeApplied=i=>({tag:"SubscribeApplied",value:i}),e.UnsubscribeApplied=i=>({tag:"UnsubscribeApplied",value:i}),e.SubscriptionError=i=>({tag:"SubscriptionError",value:i}),e.SubscribeMultiApplied=i=>({tag:"SubscribeMultiApplied",value:i}),e.UnsubscribeMultiApplied=i=>({tag:"UnsubscribeMultiApplied",value:i});function t(){return o.createSumType([new E("InitialSubscription",Wt.getTypeScriptAlgebraicType()),new E("TransactionUpdate",Qt.getTypeScriptAlgebraicType()),new E("TransactionUpdateLight",er.getTypeScriptAlgebraicType()),new E("IdentityToken",tr.getTypeScriptAlgebraicType()),new E("OneOffQueryResponse",ir.getTypeScriptAlgebraicType()),new E("SubscribeApplied",sr.getTypeScriptAlgebraicType()),new E("UnsubscribeApplied",nr.getTypeScriptAlgebraicType()),new E("SubscriptionError",ar.getTypeScriptAlgebraicType()),new E("SubscribeMultiApplied",cr.getTypeScriptAlgebraicType()),new E("UnsubscribeMultiApplied",or.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})(lr||(lr={}));var fe,Rr,_t=(Rr=class{constructor(){y(this,fe,new Map)}on(e,t){let r=a(this,fe).get(e);r||(r=new Set,a(this,fe).set(e,r)),r.add(t)}off(e,t){let r=a(this,fe).get(e);!r||r.delete(t)}emit(e,...t){let r=a(this,fe).get(e);if(!!r)for(let s of r)s(...t)}},fe=new WeakMap,Rr),gs={component:"\u{1F4E6}",info:"\u2139\uFE0F",warn:"\u26A0\uFE0F",error:"\u274C",debug:"\u{1F41B}"},ys={component:"color: #fff; background-color: #8D6FDD; padding: 2px 5px; border-radius: 3px;",info:"color: #fff; background-color: #007bff; padding: 2px 5px; border-radius: 3px;",warn:"color: #fff; background-color: #ffc107; padding: 2px 5px; border-radius: 3px;",error:"color: #fff; background-color: #dc3545; padding: 2px 5px; border-radius: 3px;",debug:"color: #fff; background-color: #28a745; padding: 2px 5px; border-radius: 3px;"},Ts={component:"color: #8D6FDD;",info:"color: #007bff;",warn:"color: #ffc107;",error:"color: #dc3545;",debug:"color: #28a745;"},ne=(e,t)=>{console.log(`%c${gs[e]} ${e.toUpperCase()}%c ${t}`,ys[e],Ts[e])},bs=class{constructor(e){p(this,"rows");p(this,"tableTypeInfo");p(this,"emitter");p(this,"applyOperations",(e,t)=>{const r=[];if(this.tableTypeInfo.primaryKeyInfo!==void 0){const s=new Map,i=new Map;for(const n of e)if(n.type==="insert"){const[c,l]=s.get(n.rowId)||[n,0];s.set(n.rowId,[n,l+1])}else{const[c,l]=i.get(n.rowId)||[n,0];i.set(n.rowId,[n,l+1])}for(const[n,[c,l]]of s){const g=i.get(n);if(g){const[m,_]=g,C=l-_,I=this.update(t,n,c.row,C);I&&r.push(I),i.delete(n)}else{const m=this.insert(t,c,l);m&&r.push(m)}}for(const[n,c]of i.values()){const l=this.delete(t,n,c);l&&r.push(l)}}else for(const s of e)if(s.type==="insert"){const i=this.insert(t,s);i&&r.push(i)}else{const i=this.delete(t,s);i&&r.push(i)}return r});p(this,"update",(e,t,r,s=0)=>{const i=this.rows.get(t);if(!i){ne("error",`Updating a row that was not present in the cache. Table: ${this.tableTypeInfo.tableName}, RowId: ${t}`);return}const[n,c]=i,l=Math.max(1,c+s);if(c+s<=0){ne("error",`Negative reference count for in table ${this.tableTypeInfo.tableName} row ${t} (${c} + ${s})`);return}return this.rows.set(t,[r,l]),c===0?(ne("error",`Updating a row id in table ${this.tableTypeInfo.tableName} which was not present in the cache (rowId: ${t})`),{type:"insert",table:this.tableTypeInfo.tableName,cb:()=>{this.emitter.emit("insert",e,r)}}):{type:"update",table:this.tableTypeInfo.tableName,cb:()=>{this.emitter.emit("update",e,n,r)}}});p(this,"insert",(e,t,r=1)=>{const[s,i]=this.rows.get(t.rowId)||[t.row,0];if(this.rows.set(t.rowId,[t.row,i+r]),i===0)return{type:"insert",table:this.tableTypeInfo.tableName,cb:()=>{this.emitter.emit("insert",e,t.row)}}});p(this,"delete",(e,t,r=1)=>{const[s,i]=this.rows.get(t.rowId)||[t.row,0];if(i===0){ne("warn","Deleting a row that was not present in the cache");return}if(i<=r)return this.rows.delete(t.rowId),{type:"delete",table:this.tableTypeInfo.tableName,cb:()=>{this.emitter.emit("delete",e,t.row)}};this.rows.set(t.rowId,[t.row,i-r])});p(this,"onInsert",e=>{this.emitter.on("insert",e)});p(this,"onDelete",e=>{this.emitter.on("delete",e)});p(this,"onUpdate",e=>{this.emitter.on("update",e)});p(this,"removeOnInsert",e=>{this.emitter.off("insert",e)});p(this,"removeOnDelete",e=>{this.emitter.off("delete",e)});p(this,"removeOnUpdate",e=>{this.emitter.off("update",e)});this.tableTypeInfo=e,this.rows=new Map,this.emitter=new _t}count(){return this.rows.size}iter(){return Array.from(this.rows.values()).map(([e])=>e)}},ms=class{constructor(){p(this,"tables");this.tables=new Map}getTable(e){const t=this.tables.get(e);if(!t)throw console.error("The table has not been registered for this client. Please register the table before using it. If you have registered global tables using the SpacetimeDBClient.registerTables() or `registerTable()` method, please make sure that is executed first!"),new Error(`Table ${e} does not exist`);return t}getOrCreateTable(e){let t;return this.tables.has(e.tableName)?t=this.tables.get(e.tableName):(t=new bs(e),this.tables.set(e.tableName,t)),t}};function ws(e,t){const r=Math.min(e.length,t.length);for(let s=0;s<r;s++){const i=e[s],n=t[s];if(i!==n)return typeof i=="number"&&typeof n=="number"?i-n:typeof i=="string"&&typeof n=="string"?i.localeCompare(n):typeof i=="string"?1:-1}return e.length-t.length}var ci=class ur{constructor(t,r,s,i=null,n=null){p(this,"major");p(this,"minor");p(this,"patch");p(this,"preRelease");p(this,"buildInfo");this.major=t,this.minor=r,this.patch=s,this.preRelease=i,this.buildInfo=n}toString(){let t=`${this.major}.${this.minor}.${this.patch}`;return this.preRelease&&(t+=`-${this.preRelease.join(".")}`),this.buildInfo&&(t+=`+${this.buildInfo}`),t}compare(t){return this.major!==t.major?this.major-t.major:this.minor!==t.minor?this.minor-t.minor:this.patch!==t.patch?this.patch-t.patch:this.preRelease&&t.preRelease?ws(this.preRelease,t.preRelease):this.preRelease||t.preRelease?-1:0}clone(){return new ur(this.major,this.minor,this.patch,this.preRelease?[...this.preRelease]:null,this.buildInfo)}static parseVersionString(t){const r=/^(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)(?:-([\da-zA-Z-]+(?:\.[\da-zA-Z-]+)*))?(?:\+([\da-zA-Z-]+(?:\.[\da-zA-Z-]+)*))?$/,s=t.match(r);if(!s)throw new Error(`Invalid version string: ${t}`);const i=parseInt(s[1],10),n=parseInt(s[2],10),c=parseInt(s[3],10),l=s[4]?s[4].split(".").map(m=>isNaN(Number(m))?m:Number(m)):null,g=s[5]||null;return new ur(i,n,c,l,g)}},oi=new ci(1,2,0);function _s(e){if(e===void 0)throw new Error(kr(e));if(ci.parseVersionString(e).compare(oi)<0)throw new Error(kr(e))}function kr(e){return`Module code was generated with an incompatible version of the spacetimedb cli (${e}).  Update the cli version to at least ${oi.toString()} and regenerate the bindings. You can upgrade to the latest cli version by running: spacetime version upgrade`}async function li(e,t,r=128*1024){let s=0;const i=new ReadableStream({pull(F){if(s<e.length){const z=e.subarray(s,Math.min(s+r,e.length));F.enqueue(z),s+=r}else F.close()}}),n=new DecompressionStream(t),l=i.pipeThrough(n).getReader(),g=[];let m=0,_;for(;!(_=await l.read()).done;)g.push(_.value),m+=_.value.length;const C=new Uint8Array(m);let I=0;for(const F of g)C.set(F,I),I+=F.length;return C}var xe,pt,ui,ht,pi,Me,pr,Re,xs=(Re=class{constructor(t){y(this,pt);y(this,ht);y(this,Me);p(this,"onclose");p(this,"onopen");p(this,"onmessage");p(this,"onerror");y(this,xe,void 0);this.onmessage=void 0,this.onopen=void 0,this.onmessage=void 0,this.onerror=void 0,t.onmessage=f(this,pt,ui).bind(this),t.onerror=f(this,Me,pr).bind(this),t.onclose=f(this,Me,pr).bind(this),t.onopen=f(this,ht,pi).bind(this),t.binaryType="arraybuffer",d(this,xe,t)}send(t){a(this,xe).send(t)}close(){a(this,xe).close()}static async createWebSocketFn({url:t,nameOrAddress:r,wsProtocol:s,authToken:i,compression:n,lightMode:c}){const l=new Headers;let g;g=WebSocket;let m;if(i){l.set("Authorization",`Bearer ${i}`);const I=new URL("v1/identity/websocket-token",t);I.protocol=t.protocol==="wss:"?"https:":"http:";const F=await fetch(I,{method:"POST",headers:l});if(F.ok){const{token:z}=await F.json();m=z}else return Promise.reject(new Error(`Failed to verify token: ${F.statusText}`))}const _=new URL(`v1/database/${r}/subscribe`,t);m&&_.searchParams.set("token",m),_.searchParams.set("compression",n==="gzip"?"Gzip":"None"),c&&_.searchParams.set("light","true");const C=new g(_.toString(),s);return new Re(C)}},xe=new WeakMap,pt=new WeakSet,ui=async function(t){const r=new Uint8Array(t.data);let s;if(r[0]===0)s=r.slice(1);else{if(r[0]===1)throw new Error("Brotli Compression not supported. Please use gzip or none compression in withCompression method on DbConnection.");if(r[0]===2)s=await li(r.slice(1),"gzip");else throw new Error("Unexpected Compression Algorithm. Please use `gzip` or `none`")}this.onmessage?.({data:s})},ht=new WeakSet,pi=function(t){this.onopen?.(t)},Me=new WeakSet,pr=function(t){this.onerror?.(t)},Re),Se,Ae,dt,Le,ge,Ne,qe,Ie,Lr,Ss=(Lr=class{constructor(e,t){y(this,Se,void 0);y(this,Ae,void 0);y(this,dt,void 0);y(this,Le,void 0);y(this,ge,new _t);y(this,Ne,"gzip");y(this,qe,!1);y(this,Ie,void 0);this.remoteModule=e,this.dbConnectionConstructor=t,d(this,Ie,xs.createWebSocketFn)}withUri(e){return d(this,Se,new URL(e)),this}withModuleName(e){return d(this,Ae,e),this}withToken(e){return d(this,Le,e),this}withWSFn(e){return d(this,Ie,e),this}withCompression(e){return d(this,Ne,e),this}withLightMode(e){return d(this,qe,e),this}onConnect(e){return a(this,ge).on("connect",e),this}onConnectError(e){return a(this,ge).on("connectError",e),this}onDisconnect(e){return a(this,ge).on("disconnect",e),this}build(){if(!a(this,Se))throw new Error("URI is required to connect to SpacetimeDB");if(!a(this,Ae))throw new Error("Database name or address is required to connect to SpacetimeDB");return _s(this.remoteModule.versionInfo?.cliVersion),this.dbConnectionConstructor(new di({uri:a(this,Se),nameOrAddress:a(this,Ae),identity:a(this,dt),token:a(this,Le),emitter:a(this,ge),compression:a(this,Ne),lightMode:a(this,qe),createWSFn:a(this,Ie),remoteModule:this.remoteModule}))}},Se=new WeakMap,Ae=new WeakMap,dt=new WeakMap,Le=new WeakMap,ge=new WeakMap,Ne=new WeakMap,qe=new WeakMap,Ie=new WeakMap,Lr),$e,He,Nr,hi=(Nr=class{constructor(e){y(this,$e,void 0);y(this,He,void 0);this.db=e}onApplied(e){return d(this,$e,e),this}onError(e){return d(this,He,e),this}subscribe(e){const t=Array.isArray(e)?e:[e];if(t.length===0)throw new Error("Subscriptions must have at least one query");return new Is(this.db,t,a(this,$e),a(this,He))}subscribeToAllTables(){this.subscribe("SELECT * FROM *")}},$e=new WeakMap,He=new WeakMap,Nr),As=class{constructor(){p(this,"subscriptions",new Map)}},Fe,ye,re,ie,se,qr,Is=(qr=class{constructor(e,t,r,s){y(this,Fe,void 0);y(this,ye,!1);y(this,re,!1);y(this,ie,!1);y(this,se,new _t);this.db=e,a(this,se).on("applied",i=>{d(this,ie,!0),r&&r(i)}),a(this,se).on("error",(i,n)=>{d(this,ie,!1),d(this,re,!0),s&&s(i,n)}),d(this,Fe,this.db.registerSubscription(this,a(this,se),t))}unsubscribe(){if(a(this,ye))throw new Error("Unsubscribe has already been called");d(this,ye,!0),this.db.unregisterSubscription(a(this,Fe)),a(this,se).on("end",e=>{d(this,re,!0),d(this,ie,!1)})}unsubscribeThen(e){if(a(this,re))throw new Error("Subscription has already ended");if(a(this,ye))throw new Error("Unsubscribe has already been called");d(this,ye,!0),this.db.unregisterSubscription(a(this,Fe)),a(this,se).on("end",t=>{d(this,re,!0),d(this,ie,!1),e(t)})}isEnded(){return a(this,re)}isActive(){return a(this,ie)}},Fe=new WeakMap,ye=new WeakMap,re=new WeakMap,ie=new WeakMap,se=new WeakMap,qr);function Fs(e){switch(e){case"FullUpdate":return 0;case"NoSuccessNotify":return 1}}var Je,q,Ue,ft,N,Ke,X,gt,yt,fi,ze,Qe,Tt,gi,ee,oe,bt,yi,mt,Ti,gr,Us,yr,zs,Tr,vs,br,Es,mr,Cs,wr,Bs,_r,ks,xr,Os,$r,di=($r=class{constructor({uri:e,nameOrAddress:t,identity:r,token:s,emitter:i,remoteModule:n,createWSFn:c,compression:l,lightMode:g}){y(this,yt);y(this,ze);y(this,Tt);y(this,ee);y(this,bt);y(this,mt);y(this,gr);y(this,yr);y(this,Tr);y(this,br);y(this,mr);y(this,wr);y(this,_r);y(this,xr);p(this,"isActive",!1);p(this,"identity");p(this,"token");p(this,"db");p(this,"reducers");p(this,"setReducerFlags");p(this,"connectionId",Dt.random());y(this,Je,0);y(this,q,void 0);y(this,Ue,new _t);y(this,ft,void 0);y(this,N,void 0);y(this,Ke,Promise.resolve());y(this,X,new As);p(this,"clientCache");p(this,"ws");p(this,"wsPromise");y(this,gt,()=>{const e=a(this,Je);return d(this,Je,a(this,Je)+1),e});p(this,"subscriptionBuilder",()=>new hi(this));ne("info","Connecting to SpacetimeDB WS...");let m=new URL(e.toString());/^wss?:/.test(e.protocol)||(m.protocol=m.protocol==="https:"?"wss:":"ws:"),this.identity=r,this.token=s,d(this,N,n),d(this,q,i);let _=this.connectionId.toHexString();m.searchParams.set("connection_id",_),this.clientCache=new ms,this.db=a(this,N).dbViewConstructor(this),this.setReducerFlags=a(this,N).setReducerFlagsConstructor(),this.reducers=a(this,N).reducersConstructor(this,this.setReducerFlags),this.wsPromise=c({url:m,nameOrAddress:t,wsProtocol:"v1.bsatn.spacetimedb",authToken:s,compression:l,lightMode:g}).then(C=>(this.ws=C,this.ws.onclose=()=>{a(this,q).emit("disconnect",this)},this.ws.onerror=I=>{a(this,q).emit("connectError",this,I)},this.ws.onopen=f(this,Tt,gi).bind(this),this.ws.onmessage=f(this,mt,Ti).bind(this),C)).catch(C=>{ne("error","Error connecting to SpacetimeDB WS"),a(this,q).emit("connectError",this,C)})}registerSubscription(e,t,r){const s=a(this,gt).call(this);return a(this,X).subscriptions.set(s,{handle:e,emitter:t}),f(this,ze,Qe).call(this,me.SubscribeMulti({queryStrings:r,queryId:{id:s},requestId:0})),s}unregisterSubscription(e){f(this,ze,Qe).call(this,me.UnsubscribeMulti({queryId:{id:e},requestId:0}))}callReducer(e,t,r){const s=me.CallReducer({reducer:e,args:t,requestId:0,flags:Fs(r)});f(this,ze,Qe).call(this,s)}disconnect(){this.wsPromise.then(e=>{e&&e.close()})}onReducer(e,t){a(this,Ue).on(e,t)}offReducer(e,t){a(this,Ue).off(e,t)}},Je=new WeakMap,q=new WeakMap,Ue=new WeakMap,ft=new WeakMap,N=new WeakMap,Ke=new WeakMap,X=new WeakMap,gt=new WeakMap,yt=new WeakSet,fi=async function(e){const t=(i,n,c)=>{const l=c.rowsData,g=new we(l),m=[],_=a(this,N).tables[n].rowType,C=a(this,N).tables[n].primaryKeyInfo;for(;g.offset<l.length+l.byteOffset;){const I=g.offset,F=_.deserialize(g);let z;if(C!==void 0)z=C.colType.intoMapKey(F[C.colName]);else{const R=l.subarray(I-l.byteOffset,g.offset-l.byteOffset);z=ei(R)}m.push({type:i,rowId:z,row:F})}return m},r=async i=>{const n=i.tableName;let c=[];for(const l of i.updates){let g;if(l.tag==="Gzip"){const m=await li(l.value,"gzip");g=tt.deserialize(new we(m))}else{if(l.tag==="Brotli")throw new Error("Brotli compression not supported. Please use gzip or none compression in withCompression method on DbConnection.");g=l.value}c=c.concat(t("insert",n,g.inserts)),c=c.concat(t("delete",n,g.deletes))}return{tableName:n,operations:c}},s=async i=>{const n=[];for(const c of i.tables)n.push(await r(c));return n};switch(e.tag){case"InitialSubscription":{const i=e.value.databaseUpdate;return{tag:"InitialSubscription",tableUpdates:await s(i)}}case"TransactionUpdateLight":{const i=e.value.update;return{tag:"TransactionUpdateLight",tableUpdates:await s(i)}}case"TransactionUpdate":{const i=e.value,n=i.callerIdentity,c=Dt.nullIfZero(i.callerConnectionId),l=i.reducerCall.reducerName,g=i.reducerCall.args,m=i.energyQuantaUsed;let _,C="";switch(i.status.tag){case"Committed":_=await s(i.status.value);break;case"Failed":_=[],C=i.status.value;break;case"OutOfEnergy":_=[];break}if(l==="<none>"){console.error(`Received an error from the database: ${C}`);return}let I;return l!==""&&(I={reducerName:l,args:g}),{tag:"TransactionUpdate",tableUpdates:_,identity:n,connectionId:c,reducerInfo:I,status:i.status,energyConsumed:m.quanta,message:C,timestamp:i.timestamp}}case"IdentityToken":return{tag:"IdentityToken",identity:e.value.identity,token:e.value.token,connectionId:e.value.connectionId};case"OneOffQueryResponse":throw new Error(`TypeScript SDK never sends one-off queries, but got OneOffQueryResponse ${e}`);case"SubscribeMultiApplied":{const i=await s(e.value.update);return{tag:"SubscribeApplied",queryId:e.value.queryId.id,tableUpdates:i}}case"UnsubscribeMultiApplied":{const i=await s(e.value.update);return{tag:"UnsubscribeApplied",queryId:e.value.queryId.id,tableUpdates:i}}case"SubscriptionError":return{tag:"SubscriptionError",queryId:e.value.queryId,error:e.value.error}}},ze=new WeakSet,Qe=function(e){this.wsPromise.then(t=>{if(t){const r=new ae(1024);me.serialize(r,e);const s=r.getBuffer();t.send(s)}})},Tt=new WeakSet,gi=function(){this.isActive=!0},ee=new WeakSet,oe=function(e,t){let r=[];for(let s of e){const i=s.tableName,n=a(this,N).tables[i],l=this.clientCache.getOrCreateTable(n).applyOperations(s.operations,t);for(const g of l)r.push(g)}return r},bt=new WeakSet,yi=async function(e){var s;const t=fs(lr,e),r=await f(this,yt,fi).call(this,t);if(!!r)switch(r.tag){case"InitialSubscription":{let i={tag:"SubscribeApplied"};const n=a(this,N).eventContextConstructor(this,i),{event:c,...l}=n,g=f(this,ee,oe).call(this,r.tableUpdates,n);a(this,q)&&((s=a(this,ft))==null||s.call(this,l));for(const m of g)m.cb();break}case"TransactionUpdateLight":{let i={tag:"UnknownTransaction"};const n=a(this,N).eventContextConstructor(this,i),c=f(this,ee,oe).call(this,r.tableUpdates,n);for(const l of c)l.cb();break}case"TransactionUpdate":{let i=r.reducerInfo,n=!1,c,l;if(!i)n=!0;else{l=a(this,N).reducers[i.reducerName];try{const z=new we(i.args);c=l.argsType.deserialize(z)}catch{console.debug("Failed to deserialize reducer arguments"),n=!0}}if(n){const z={tag:"UnknownTransaction"},R=a(this,N).eventContextConstructor(this,z),A=f(this,ee,oe).call(this,r.tableUpdates,R);for(const O of A)O.cb();return}i=i,l=l;const g={callerIdentity:r.identity,status:r.status,callerConnectionId:r.connectionId,timestamp:r.timestamp,energyConsumed:r.energyConsumed,reducer:{name:i.reducerName,args:c}},m={tag:"Reducer",value:g},_=a(this,N).eventContextConstructor(this,m),C={..._,event:g},I=f(this,ee,oe).call(this,r.tableUpdates,_),F=[];l.argsType.product.elements.forEach((z,R)=>{F.push(c[z.name])}),a(this,Ue).emit(i.reducerName,C,...F);for(const z of I)z.cb();break}case"IdentityToken":{this.identity=r.identity,!this.token&&r.token&&(this.token=r.token),this.connectionId=r.connectionId,a(this,q).emit("connect",this,this.identity,this.token);break}case"SubscribeApplied":{const i=a(this,X).subscriptions.get(r.queryId);if(i===void 0){ne("error",`Received SubscribeApplied for unknown queryId ${r.queryId}.`);break}const n={tag:"SubscribeApplied"},c=a(this,N).eventContextConstructor(this,n),{event:l,...g}=c,m=f(this,ee,oe).call(this,r.tableUpdates,c);i?.emitter.emit("applied",g);for(const _ of m)_.cb();break}case"UnsubscribeApplied":{const i=a(this,X).subscriptions.get(r.queryId);if(i===void 0){ne("error",`Received UnsubscribeApplied for unknown queryId ${r.queryId}.`);break}const n={tag:"UnsubscribeApplied"},c=a(this,N).eventContextConstructor(this,n),{event:l,...g}=c,m=f(this,ee,oe).call(this,r.tableUpdates,c);i?.emitter.emit("end",g),a(this,X).subscriptions.delete(r.queryId);for(const _ of m)_.cb();break}case"SubscriptionError":{const i=Error(r.error),n={tag:"Error",value:i},l={...a(this,N).eventContextConstructor(this,n),event:i};r.queryId!==void 0?(a(this,X).subscriptions.get(r.queryId)?.emitter.emit("error",l,i),a(this,X).subscriptions.delete(r.queryId)):(console.error("Received an error message without a queryId: ",i),a(this,X).subscriptions.forEach(({emitter:g})=>{g.emit("error",l,i)}))}}},mt=new WeakSet,Ti=function(e){d(this,Ke,a(this,Ke).then(()=>f(this,bt,yi).call(this,e.data)))},gr=new WeakSet,Us=function(e,t){a(this,q).on(e,t)},yr=new WeakSet,zs=function(e,t){a(this,q).off(e,t)},Tr=new WeakSet,vs=function(e){a(this,q).on("connect",e)},br=new WeakSet,Es=function(e){a(this,q).on("disconnect",e)},mr=new WeakSet,Cs=function(e){a(this,q).on("connectError",e)},wr=new WeakSet,Bs=function(e){a(this,q).off("connect",e)},_r=new WeakSet,ks=function(e){a(this,q).off("disconnect",e)},xr=new WeakSet,Os=function(e){a(this,q).off("connectError",e)},$r),st;(e=>{function t(){return o.createProductType([new u("other",o.createIdentityType()),new u("app",o.createU256Type()),new u("lam",o.createU256Type()),new u("arg",o.createStringType())])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})(st||(st={}));var hr;(e=>{function t(){return o.createProductType([new u("setup",o.createStringType()),new u("functions",o.createArrayType(o.createStringType()))])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})(hr||(hr={}));var nt;(e=>{function t(){return o.createProductType([new u("app",hr.getTypeScriptAlgebraicType())])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})(nt||(nt={}));var at;(e=>{function t(){return o.createProductType([new u("app",o.createU256Type()),new u("value",o.createBoolType())])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})(at||(at={}));class Ds{constructor(t){p(this,"tableCache");p(this,"id",{find:t=>{for(let r of this.tableCache.iter())if(wt(r.id,t))return r}});p(this,"onInsert",t=>this.tableCache.onInsert(t));p(this,"removeOnInsert",t=>this.tableCache.removeOnInsert(t));p(this,"onDelete",t=>this.tableCache.onDelete(t));p(this,"removeOnDelete",t=>this.tableCache.removeOnDelete(t));p(this,"onUpdate",t=>this.tableCache.onUpdate(t));p(this,"removeOnUpdate",t=>this.tableCache.removeOnUpdate(t));this.tableCache=t}count(){return this.tableCache.count()}iter(){return this.tableCache.iter()}}class js{constructor(t){p(this,"tableCache");p(this,"onInsert",t=>this.tableCache.onInsert(t));p(this,"removeOnInsert",t=>this.tableCache.removeOnInsert(t));p(this,"onDelete",t=>this.tableCache.onDelete(t));p(this,"removeOnDelete",t=>this.tableCache.removeOnDelete(t));this.tableCache=t}count(){return this.tableCache.count()}iter(){return this.tableCache.iter()}}class Ps{constructor(t){p(this,"tableCache");p(this,"id",{find:t=>{for(let r of this.tableCache.iter())if(wt(r.id,t))return r}});p(this,"onInsert",t=>this.tableCache.onInsert(t));p(this,"removeOnInsert",t=>this.tableCache.removeOnInsert(t));p(this,"onDelete",t=>this.tableCache.onDelete(t));p(this,"removeOnDelete",t=>this.tableCache.removeOnDelete(t));p(this,"onUpdate",t=>this.tableCache.onUpdate(t));p(this,"removeOnUpdate",t=>this.tableCache.removeOnUpdate(t));this.tableCache=t}count(){return this.tableCache.count()}iter(){return this.tableCache.iter()}}class Ms{constructor(t){p(this,"tableCache");p(this,"key",{find:t=>{for(let r of this.tableCache.iter())if(wt(r.key,t))return r}});p(this,"onInsert",t=>this.tableCache.onInsert(t));p(this,"removeOnInsert",t=>this.tableCache.removeOnInsert(t));p(this,"onDelete",t=>this.tableCache.onDelete(t));p(this,"removeOnDelete",t=>this.tableCache.removeOnDelete(t));p(this,"onUpdate",t=>this.tableCache.onUpdate(t));p(this,"removeOnUpdate",t=>this.tableCache.removeOnUpdate(t));this.tableCache=t}count(){return this.tableCache.count()}iter(){return this.tableCache.iter()}}var ct;(e=>{function t(){return o.createProductType([new u("id",o.createU256Type()),new u("setup",o.createStringType())])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})(ct||(ct={}));var dr;(e=>{function t(){return o.createProductType([new u("host",o.createIdentityType()),new u("app",o.createU256Type())])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})(dr||(dr={}));var ot;(e=>{function t(){return o.createProductType([new u("id",o.createU256Type()),new u("code",o.createStringType())])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})(ot||(ot={}));var lt;(e=>{function t(){return o.createProductType([new u("key",o.createU256Type()),new u("owner",o.createIdentityType()),new u("content",o.createStringType())])}e.getTypeScriptAlgebraicType=t;function r(i,n){e.getTypeScriptAlgebraicType().serialize(i,n)}e.serialize=r;function s(i){return e.getTypeScriptAlgebraicType().deserialize(i)}e.deserialize=s})(lt||(lt={}));const ke={tables:{app:{tableName:"app",rowType:ct.getTypeScriptAlgebraicType(),primaryKey:"id",primaryKeyInfo:{colName:"id",colType:ct.getTypeScriptAlgebraicType().product.elements[0].algebraicType}},host:{tableName:"host",rowType:dr.getTypeScriptAlgebraicType()},lambda:{tableName:"lambda",rowType:ot.getTypeScriptAlgebraicType(),primaryKey:"id",primaryKeyInfo:{colName:"id",colType:ot.getTypeScriptAlgebraicType().product.elements[0].algebraicType}},store:{tableName:"store",rowType:lt.getTypeScriptAlgebraicType(),primaryKey:"key",primaryKeyInfo:{colName:"key",colType:lt.getTypeScriptAlgebraicType().product.elements[0].algebraicType}}},reducers:{call_lambda:{reducerName:"call_lambda",argsType:st.getTypeScriptAlgebraicType()},publish:{reducerName:"publish",argsType:nt.getTypeScriptAlgebraicType()},sethost:{reducerName:"sethost",argsType:at.getTypeScriptAlgebraicType()}},versionInfo:{cliVersion:"1.2.0"},eventContextConstructor:(e,t)=>({...e,event:t}),dbViewConstructor:e=>new Ns(e),reducersConstructor:(e,t)=>new Rs(e,t),setReducerFlagsConstructor:()=>new Ls};class Rs{constructor(t,r){this.connection=t,this.setCallReducerFlags=r}callLambda(t,r,s,i){const n={other:t,app:r,lam:s,arg:i};let c=new ae(1024);st.getTypeScriptAlgebraicType().serialize(c,n);let l=c.getBuffer();this.connection.callReducer("call_lambda",l,this.setCallReducerFlags.callLambdaFlags)}onCallLambda(t){this.connection.onReducer("call_lambda",t)}removeOnCallLambda(t){this.connection.offReducer("call_lambda",t)}publish(t){const r={app:t};let s=new ae(1024);nt.getTypeScriptAlgebraicType().serialize(s,r);let i=s.getBuffer();this.connection.callReducer("publish",i,this.setCallReducerFlags.publishFlags)}onPublish(t){this.connection.onReducer("publish",t)}removeOnPublish(t){this.connection.offReducer("publish",t)}sethost(t,r){const s={app:t,value:r};let i=new ae(1024);at.getTypeScriptAlgebraicType().serialize(i,s);let n=i.getBuffer();this.connection.callReducer("sethost",n,this.setCallReducerFlags.sethostFlags)}onSethost(t){this.connection.onReducer("sethost",t)}removeOnSethost(t){this.connection.offReducer("sethost",t)}}class Ls{constructor(){p(this,"callLambdaFlags","FullUpdate");p(this,"publishFlags","FullUpdate");p(this,"sethostFlags","FullUpdate")}callLambda(t){this.callLambdaFlags=t}publish(t){this.publishFlags=t}sethost(t){this.sethostFlags=t}}class Ns{constructor(t){this.connection=t}get app(){return new Ds(this.connection.clientCache.getOrCreateTable(ke.tables.app))}get host(){return new js(this.connection.clientCache.getOrCreateTable(ke.tables.host))}get lambda(){return new Ps(this.connection.clientCache.getOrCreateTable(ke.tables.lambda))}get store(){return new Ms(this.connection.clientCache.getOrCreateTable(ke.tables.store))}}class qs extends hi{}class bi extends di{constructor(){super(...arguments);p(this,"subscriptionBuilder",()=>new qs(this))}}p(bi,"builder",()=>new Ss(ke,r=>r));const xt=new TextEncoder;function St(e){let t=0n;for(let r=0;r<e.length;r++)t=(t<<8n)+BigInt(e[r]);return t}function de(e){const t=new Uint8Array(32);let r=e;for(let s=31;s>=0;s--)t[s]=Number(r&0xffn),r>>=8n;return t}function Sr(e){const t=e.reduce((i,n)=>i+n.length,0),r=new Uint8Array(t);let s=0;for(const i of e)r.set(i,s),s+=i.length;return r}async function fr(e){const t=xt.encode(e),r=new Uint8Array(await crypto.subtle.digest("SHA-256",t));return St(r)}async function Or(e,t,r,s,i){const n=de(e.data),c=de(t.data),l=de(r),g=de(s),m=xt.encode(i),_=Sr([n,c,l,g,m]),C=new Uint8Array(await crypto.subtle.digest("SHA-256",_));return St(C)}async function $s(e,t,r){const s=de(e.data),i=de(t),n=xt.encode(r),c=Sr([s,i,n]),l=new Uint8Array(await crypto.subtle.digest("SHA-256",c));return St(l)}async function Hs(e){const t=await Promise.all(e.functions.map(fr)),r=xt.encode(e.setup),s=t.map(de),i=Sr([r,...s]),n=new Uint8Array(await crypto.subtle.digest("SHA-256",i));return{hash:St(n),lambdas:t}}const Dr=e=>"id"+e.toHexString(),jr=e=>new ni(e.slice(2));function Js(e,t,r){return new Promise((s,i)=>{let n=new Map;bi.builder().withUri(e).withModuleName(t).withToken(r.get()).onConnect(async(c,l,g)=>{r.set(g);const m=new Map;c.subscriptionBuilder().onApplied(I=>{console.log("APPLIED"),console.log(Array.from(I.db.store.iter())),I.db.store.onInsert((F,z)=>{z.owner.data==l.data&&(m.set(z.key,z.content),n.get(z.key)?.forEach(R=>R(JSON.parse(z.content))))}),I.db.store.onUpdate((F,z,R)=>{console.log("UPDATE",z,R),R.owner.data==l.data&&(m.set(R.key,R.content),n.get(R.key)?.forEach(A=>A(JSON.parse(R.content))))}),I.reducers.onCallLambda(async(F,z,R,A,O)=>{const j=await Or(l,z,R,A,O);if(F.event.status.tag=="Failed")_.get(j)?.reject(F.event.status.value);else try{_.get(j)?.resolve(JSON.parse(m.get(j)))}catch(G){console.log(m.get(j)),console.error(G),_.get(j)?.resolve(null)}_.delete(j)})}).onError(console.error).subscribe([`SELECT * FROM store WHERE owner = '${l.toHexString()}'`,"SELECT * FROM app","SELECT * FROM lambda",`SELECT * FROM host WHERE host = '${l.toHexString()}'`]);const _=new Map,C=async I=>{let F=await Hs({setup:I.loadApp.toString(),functions:Object.values(I.api).map(O=>O.toString())});return c.reducers.publish({setup:I.loadApp.toString(),functions:Object.values(I.api).map(O=>O.toString())}),c.reducers.sethost(F.hash,!0),{call:async(O,j,G=null)=>new Promise(async(At,Ce)=>{const Ar=JSON.stringify(G),Ir=j.toString(),wi=await Or(l,jr(O),F.hash,await fr(Ir),Ar),_i=await fr(Ir);_.set(wi,{resolve:At,reject:Ce}),c.reducers.callLambda(jr(O),F.hash,_i,Ar)}),users:()=>new Promise(async(O,j)=>{let G=c.subscriptionBuilder().onApplied(At=>{G.unsubscribe(),O(Array.from(At.db.host.iter()).filter(Ce=>Ce.app==F.hash).map(Ce=>Dr(Ce.host)))}).onError(j).subscribe([`SELECT * FROM host WHERE app = '${F.hash}'`])}),subscribe:async(O,j)=>{const G=await $s(l,F.hash,O);n.has(G)||n.set(G,[]),n.get(G)?.push(j)}}};s({identity:Dr(l),handle:C})}).build()})}const ut="LamBox";document.title=ut;function mi(){const e=window.location.pathname.split("/").filter(Boolean),t=e.includes("local"),r=!e.includes(ut);return{serverLocal:t,frontendLocal:r,path:e.filter(s=>s!="local"&&s!=ut)}}let le=mi();const Ks=le.serverLocal?"ws://localhost:3000":"wss://maincloud.spacetimedb.com";Js(Ks,"rubox",new Hr("rubox-token-"+le.serverLocal,"")).then(e=>{const t=document.body,s=[{init:()=>pe(Et("home"),ue("welcome to the rubox"),...s.filter(n=>n.path).map(n=>ue(Ze(n.path,{onclick:()=>{i(n.path.split("/"))}})))),path:"",cache:void 0},{init:n=>Ii(n),path:"chat",cache:void 0}];i(le.path),window.addEventListener("popstate",n=>{le=mi(),i(le.path)});function i(n){let c=(le.serverLocal?"local":"")+"/"+(le.frontendLocal?"":ut)+"/"+n.join("/");c=window.location.origin+"/"+c.split("/").filter(Boolean).join("/"),window.history.pushState({},"",c),t.innerHTML="",t.style.fontFamily="monospace",t.style.textAlign="center";for(const l of s)l.path===n.join("/")&&(l.cache||(l.cache=l.init(e)),t.appendChild(l.cache))}});
